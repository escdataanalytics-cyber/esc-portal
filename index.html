<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESC â€¢ Plataforma de Ensino</title>
<script>
  const SUPABASE_URL = 'https://zycxnizgauollnafyotk.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Y3huaXpnYXVvbGxuYWZ5b3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDM4MjIsImV4cCI6MjA4NzExOTgyMn0.t7YJAOoJ3qbthikkwBDIL5nyp-wBEJFkkPbZMrRFcRM';
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='14' fill='%23080b10'/><rect width='64' height='64' rx='14' fill='url(%23g)' opacity='.9'/><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300c8ff' stop-opacity='.25'/><stop offset='1' stop-color='%237c5cfc' stop-opacity='.25'/></linearGradient></defs><rect x='3' y='3' width='58' height='58' rx='12' fill='none' stroke='%2300c8ff' stroke-width='1.5' stroke-opacity='.5'/><text x='32' y='42' font-family='Arial Black,sans-serif' font-weight='900' font-size='22' fill='%2300c8ff' text-anchor='middle' letter-spacing='-1'>ESC</text></svg>"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
:root{
  --black:#080b10;--dark:#0f1318;--surface:#161c24;--surface2:#1e2630;
  --border:rgba(0,200,255,.14);--border-hi:rgba(0,200,255,.38);
  --cyan:#00c8ff;--purple:#7c5cfc;--green:#0fba81;--amber:#f59e0b;--red:#ef4444;
  --text:#ddeeff;--muted:#6b8fa8;--soft:#9ab8cc;
  --fd:'Orbitron',monospace;--fb:'Rajdhani',system-ui;--fm:'JetBrains Mono',monospace;
  --r:12px;--rs:8px;
}
body{font-family:var(--fb);color:var(--text);background:var(--black);min-height:100vh;
  background-image:radial-gradient(ellipse 80% 50% at 20% -10%,rgba(0,200,255,.06),transparent 60%),
  radial-gradient(ellipse 60% 40% at 90% 10%,rgba(124,92,252,.06),transparent 50%);}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:rgba(0,0,0,.15)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
.hidden{display:none!important}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r)}
.cp{padding:20px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 17px;border-radius:999px;border:none;cursor:pointer;font-family:var(--fb);font-weight:700;font-size:.92rem;transition:all .22s;white-space:nowrap}
.bp{background:linear-gradient(135deg,var(--cyan),var(--purple));color:#050d14;box-shadow:0 6px 20px rgba(0,200,255,.18)}
.bp:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,200,255,.32)}
.bp:disabled{opacity:.4;cursor:not-allowed;transform:none}
.bo{background:transparent;border:1px solid var(--border-hi);color:var(--cyan)}
.bo:hover{background:rgba(0,200,255,.08)}
.bg2{background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--soft)}
.bg2:hover{background:rgba(255,255,255,.08);color:var(--text)}
.bd{background:rgba(239,68,68,.1);border:1px solid var(--red);color:var(--red);border-radius:var(--rs);padding:5px 11px;font-size:.82rem}
.bd:hover{background:rgba(239,68,68,.2)}
.bs{background:rgba(15,186,129,.1);border:1px solid var(--green);color:var(--green);border-radius:var(--rs);padding:5px 11px;font-size:.82rem}
.bs:hover{background:rgba(15,186,129,.2)}
.blv{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 6px 24px rgba(239,68,68,.4);animation:livePulse 2s ease-in-out infinite}
.blv:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(239,68,68,.6)}
@keyframes livePulse{0%,100%{box-shadow:0 6px 24px rgba(239,68,68,.4)}50%{box-shadow:0 6px 32px rgba(239,68,68,.7),0 0 0 6px rgba(239,68,68,.1)}}
.livedot{width:8px;height:8px;background:#fff;border-radius:50%;animation:dotBlink 1s ease-in-out infinite}
@keyframes dotBlink{0%,100%{opacity:1}50%{opacity:.3}}
.btn-sm{padding:6px 13px;font-size:.85rem}.btn-xs{padding:4px 9px;font-size:.78rem}
.fg{display:flex;flex-direction:column;gap:5px}
.fl{font-size:.78rem;font-weight:700;color:var(--soft);letter-spacing:.5px;text-transform:uppercase}
.fi{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--rs);padding:10px 13px;color:var(--text);font-family:var(--fb);font-size:.95rem;outline:none;transition:border .22s;width:100%}
.fi:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,200,255,.1)}
.fi::placeholder{color:var(--muted)}
select.fi{cursor:pointer}textarea.fi{resize:vertical}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.fgrid .full{grid-column:1/-1}
.ferr{font-size:.82rem;color:var(--red);font-weight:700}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:999px;font-size:.74rem;font-weight:700}
.bc{background:rgba(0,200,255,.1);color:var(--cyan);border:1px solid rgba(0,200,255,.25)}
.bg3{background:rgba(15,186,129,.1);color:var(--green);border:1px solid rgba(15,186,129,.25)}
.ba{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.25)}
.br{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.bpp{background:rgba(124,92,252,.1);color:var(--purple);border:1px solid rgba(124,92,252,.25)}
.bw2{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--border)}
.pw{height:6px;background:rgba(0,0,0,.35);border-radius:999px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:999px;transition:width .5s}
.pw.lg{height:10px}
#tc{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:7px;max-width:340px}
.toast{padding:11px 16px;border:1px solid var(--border);background:rgba(12,16,22,.97);border-radius:var(--r);font-weight:700;font-size:.9rem;animation:tIn .3s ease}
.ts{border-color:var(--green);color:var(--green)}.te{border-color:var(--red);color:var(--red)}
.ti{border-color:var(--cyan);color:var(--cyan)}.tw{border-color:var(--amber);color:var(--amber)}
@keyframes tIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fi .2s}
.modal{background:var(--surface);border:1px solid var(--border-hi);border-radius:16px;padding:26px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,.6);animation:mi .28s ease}
.mtt{font-family:var(--fd);font-size:1.05rem;color:var(--cyan);margin-bottom:18px}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes mi{from{opacity:0;transform:translateY(-18px)}to{opacity:1;transform:translateY(0)}}
.hdr{position:sticky;top:0;z-index:100;display:flex;align-items:center;gap:14px;padding:0 20px;height:58px;background:rgba(8,11,16,.93);border-bottom:1px solid var(--border);backdrop-filter:blur(12px)}
.brand{display:flex;align-items:center;gap:10px}
.blog{width:34px;height:34px;border-radius:9px;display:grid;place-items:center;background:linear-gradient(135deg,rgba(0,200,255,.15),rgba(124,92,252,.15));border:1px solid rgba(0,200,255,.3);font-family:var(--fd);font-weight:900;font-size:.72rem;color:#bff6ff}
.bname{font-family:var(--fd);font-size:.9rem;font-weight:700;color:#bff6ff}
.bsub{font-size:.75rem;color:var(--muted)}
.hright{margin-left:auto;display:flex;align-items:center;gap:9px}
.uchip{display:flex;align-items:center;gap:7px;padding:4px 11px 4px 5px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.28)}
.uav{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-size:.78rem;font-weight:900;color:#050d14;background:linear-gradient(135deg,var(--cyan),var(--purple));flex-shrink:0}
.uname{font-size:.86rem;font-weight:700}
.expw{display:flex;align-items:center;gap:5px;padding:5px 11px;border:1px solid var(--amber);border-radius:999px;background:rgba(245,158,11,.07);color:var(--amber);font-size:.8rem;font-weight:700;animation:wp 3s ease-in-out infinite}
@keyframes wp{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,.2)}50%{box-shadow:0 0 0 5px rgba(245,158,11,0)}}
.l2{display:grid;grid-template-columns:255px 1fr;min-height:calc(100vh - 58px)}
.sbar{border-right:1px solid var(--border);padding:14px;overflow-y:auto;max-height:calc(100vh - 58px);background:rgba(0,0,0,.1)}
.nsect{font-size:.7rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;padding:3px 7px;margin:14px 0 5px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--rs);color:var(--soft);font-weight:600;cursor:pointer;transition:all .18s;margin-bottom:2px;border:1px solid transparent;font-size:.9rem}
.ni:hover{color:var(--text);background:rgba(255,255,255,.04)}
.ni.act{color:var(--cyan);background:rgba(0,200,255,.07);border-color:rgba(0,200,255,.18)}
.nic{font-size:.95rem;width:19px;text-align:center;flex-shrink:0}
.nbadge{background:var(--red);color:#fff;border-radius:999px;font-size:.66rem;font-weight:900;padding:2px 5px;margin-left:auto}
.mcont{overflow-y:auto;max-height:calc(100vh - 58px);padding:22px}
.ladm{display:grid;grid-template-columns:215px 1fr;min-height:calc(100vh - 58px)}
.abar{border-right:1px solid var(--border);padding:14px;background:rgba(0,0,0,.18)}
.ani{display:flex;align-items:center;gap:9px;padding:10px 13px;border-radius:var(--rs);color:var(--muted);font-weight:700;cursor:pointer;transition:all .18s;margin-bottom:3px;border:1px solid transparent;font-size:.9rem}
.ani:hover{color:var(--text);background:rgba(255,255,255,.04)}
.ani.act{color:#c9f2ff;border-color:rgba(0,200,255,.25);background:rgba(0,200,255,.07)}
.page{display:none}.page.act{display:block;animation:fi .28s}
.tw2{overflow-x:auto;border-radius:var(--r);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
thead tr{background:rgba(0,200,255,.03)}
th{padding:10px 13px;text-align:left;font-size:.75rem;font-weight:800;color:var(--soft);letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border)}
td{padding:10px 13px;border-bottom:1px solid rgba(255,255,255,.04);font-size:.9rem;vertical-align:middle}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(255,255,255,.02)}
.sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px}
.sc{padding:17px;border:1px solid var(--border);border-radius:var(--r);background:rgba(0,0,0,.18);transition:all .28s}
.sc:hover{border-color:var(--border-hi);transform:translateY(-2px)}
.sval{font-size:1.7rem;font-weight:900;line-height:1;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.slbl{font-size:.78rem;color:var(--muted);margin-top:5px}
.trail{display:flex;flex-direction:column}
.tri{display:flex;gap:15px;padding:15px 0;position:relative}
.tri:not(:last-child)::after{content:'';position:absolute;left:18px;top:48px;bottom:-5px;width:2px;background:linear-gradient(180deg,var(--border-hi),var(--border))}
.tdot{width:38px;height:38px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-size:1rem;border:2px solid var(--border);background:var(--surface2);position:relative;z-index:1;transition:all .28s}
.tdot.done{border-color:var(--green);background:rgba(15,186,129,.12);box-shadow:0 0 14px rgba(15,186,129,.25)}
.tdot.cur{border-color:var(--cyan);background:rgba(0,200,255,.12);box-shadow:0 0 14px rgba(0,200,255,.25)}
.tdot.lock{opacity:.4}
.cgrid{display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
.plwr{border-radius:14px 14px 0 0;overflow:hidden;background:#000;aspect-ratio:16/9;position:relative}
.vif{width:100%;height:100%;border:none;display:block}
.pov{position:absolute;top:11px;left:11px;display:flex;gap:7px;z-index:5}
.ptag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.13);background:rgba(0,0,0,.72);backdrop-filter:blur(8px);font-size:.8rem;font-weight:700;color:#c9f2ff}
.tbar{display:flex;gap:5px;padding:11px;border-top:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap}
.tb{padding:7px 13px;border-radius:var(--rs);border:1px solid var(--border);background:rgba(0,0,0,.22);color:var(--soft);font-weight:700;cursor:pointer;white-space:nowrap;transition:all .18s;font-family:var(--fb);font-size:.86rem}
.tb:hover{color:var(--text);border-color:var(--border-hi)}
.tb.act{background:rgba(0,200,255,.1);border-color:var(--cyan);color:var(--cyan)}
.tp{display:none;padding:17px;min-height:240px}.tp.act{display:block;animation:fi .28s}
.pc{border:1px solid var(--border);border-radius:var(--r);background:rgba(0,0,0,.18);margin-bottom:11px;overflow:hidden;transition:border .18s}
.pc:hover{border-color:var(--border-hi)}.pc.pin{border-color:rgba(245,158,11,.28)}
.phead{padding:13px 15px;display:flex;align-items:flex-start;gap:11px}
.pav{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-weight:900;font-size:.82rem;color:#050d14;background:linear-gradient(135deg,var(--cyan),var(--purple))}
.pbody{padding:0 15px 12px;color:var(--soft);font-size:.9rem;line-height:1.55}
.pfooter{padding:9px 15px;border-top:1px solid var(--border);display:flex;gap:7px;align-items:center}
.rlist{background:rgba(0,0,0,.18);border-top:1px solid var(--border)}
.ri{padding:11px 15px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:9px}
.ri:last-child{border-bottom:none}
.rav{width:24px;height:24px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-size:.65rem;font-weight:900;color:#050d14;background:linear-gradient(135deg,var(--purple),var(--cyan))}
.rav.adm{background:linear-gradient(135deg,var(--red),var(--purple));width:28px;height:28px;font-size:.7rem}
.ri.adm-reply{background:rgba(124,92,252,.05);border-left:3px solid var(--purple)}
.ri.pending-reply{background:rgba(245,158,11,.04);border-left:3px solid rgba(245,158,11,.4);opacity:.75}
.nta{width:100%;min-height:170px;background:rgba(0,0,0,.28);border:1px solid var(--border);border-radius:var(--rs);padding:12px;color:var(--text);font-family:var(--fb);font-size:.93rem;resize:vertical;outline:none;transition:border .22s}
.nta:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,200,255,.09)}
/* LIVE CARD */
.livecard{border:2px solid var(--red);border-radius:16px;padding:22px;background:linear-gradient(135deg,rgba(239,68,68,.07),rgba(220,38,38,.03));position:relative;overflow:hidden;margin-bottom:16px}
.livecard::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(239,68,68,.1),transparent 70%)}
.livecard-inner{position:relative;z-index:1}
.livebadge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;background:var(--red);color:#fff;font-size:.78rem;font-weight:900;letter-spacing:.5px;margin-bottom:11px}
/* COUNTDOWN */
.cdcard{border:1px solid rgba(124,92,252,.3);border-radius:16px;padding:20px;background:linear-gradient(135deg,rgba(124,92,252,.06),rgba(0,200,255,.04));margin-bottom:16px}
.cdgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:13px}
.cdu{text-align:center;padding:13px 8px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--rs)}
.cdv{font-family:var(--fd);font-size:1.6rem;font-weight:900;color:var(--cyan);line-height:1}
.cdl{font-size:.68rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
/* MURAL */
.muralcard{border:1px solid rgba(245,158,11,.25);border-radius:var(--r);padding:16px;background:rgba(245,158,11,.04);margin-bottom:11px;position:relative}
.muralcard.fix{border-color:rgba(245,158,11,.5);background:rgba(245,158,11,.07)}
.muralfix{position:absolute;top:11px;right:11px;font-size:.75rem;color:var(--amber);font-weight:800}
/* LOGIN */
#ls{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.lwrap{width:100%;max-width:430px}
.llogobox{width:58px;height:58px;border-radius:15px;margin:0 auto 13px;display:grid;place-items:center;background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(124,92,252,.18));border:1px solid rgba(0,200,255,.38);font-family:var(--fd);font-weight:900;font-size:1.05rem;color:#bff6ff;box-shadow:0 0 28px rgba(0,200,255,.18)}
.lcard{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:30px;box-shadow:0 40px 90px rgba(0,0,0,.5)}
.ltabs{display:flex;gap:3px;margin-bottom:22px;background:rgba(0,0,0,.28);border-radius:var(--rs);padding:3px}
.ltab{flex:1;padding:8px;text-align:center;border-radius:var(--rs);font-weight:700;cursor:pointer;transition:all .22s;font-family:var(--fb);font-size:.88rem;color:var(--muted)}
.ltab.act{background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(124,92,252,.18));color:var(--cyan)}
.lbtn{width:100%;padding:12px;border:none;border-radius:var(--r);cursor:pointer;font-family:var(--fb);font-size:.97rem;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));color:#050d14;box-shadow:0 8px 22px rgba(0,200,255,.22);transition:all .28s;margin-top:7px}
.lbtn:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(0,200,255,.38)}
.lbtn:disabled{opacity:.4;cursor:not-allowed;transform:none}
hr.div{border:none;border-top:1px solid var(--border);margin:14px 0}
@media(max-width:1080px){.cgrid{grid-template-columns:1fr}}
@media(max-width:880px){.l2,.ladm{grid-template-columns:1fr}.sbar,.abar{display:none}.fgrid{grid-template-columns:1fr}}
@media(max-width:580px){.hdr{padding:0 12px}.bname{display:none}.mcont{padding:14px}.cdv{font-size:1.2rem}}
</style>
</head>
<body>
<div id="tc"></div>

<!-- LOGIN -->
<div id="ls">
  <div class="lwrap">
    <div style="text-align:center;margin-bottom:28px">
      <div class="llogobox">ESC</div>
      <div style="font-family:var(--fd);font-size:1.15rem;font-weight:700;color:#bff6ff">Plataforma de Ensino</div>
      <div style="font-size:.85rem;color:var(--muted);margin-top:3px">Dos dados ao Dashboard ğŸ“Š</div>
    </div>
    <div class="lcard">
      <div class="ltabs">
        <div class="ltab act" data-lt="login">ğŸ” Entrar</div>
        <div class="ltab" data-lt="reg">ğŸ—ï¸ Solicitar Acesso</div>
      </div>
      <div id="lf-login">
        <div class="fg" style="margin-bottom:13px"><label class="fl">Login</label><input id="lUser" class="fi" type="text" placeholder="seu.login" autocomplete="username"/></div>
        <div class="fg" style="margin-bottom:13px"><label class="fl">Senha</label><input id="lPass" class="fi" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/></div>
        <div id="lErr" class="ferr" style="min-height:18px;margin-bottom:8px"></div>
        <button id="lBtn" class="lbtn">ENTRAR</button>
        <div style="text-align:center;font-size:.78rem;color:var(--muted);margin-top:11px">Problemas de acesso? Contate o administrador.</div>
      </div>
      <div id="lf-reg" class="hidden">
        <div style="padding:10px;border:1px solid rgba(0,200,255,.18);border-radius:var(--rs);background:rgba(0,200,255,.04);margin-bottom:14px;font-size:.84rem;color:var(--soft)">
          â„¹ï¸ Preencha seus dados. ApÃ³s aprovaÃ§Ã£o do admin, vocÃª receberÃ¡ acesso.
        </div>
        <div class="fgrid" style="margin-bottom:13px">
          <div class="fg"><label class="fl">Nome completo</label><input id="rNome" class="fi" placeholder="JoÃ£o da Silva"/></div>
          <div class="fg"><label class="fl">Email</label><input id="rEmail" class="fi" type="email" placeholder="joao@empresa.com"/></div>
          <div class="fg"><label class="fl">Login desejado</label><input id="rLogin" class="fi" placeholder="joao.silva"/></div>
          <div class="fg"><label class="fl">Senha</label><input id="rPass" class="fi" type="password" placeholder="MÃ­nimo 6 caracteres"/></div>
        </div>
        <div id="rErr" class="ferr" style="min-height:18px;margin-bottom:8px"></div>
        <button id="rBtn" class="lbtn">SOLICITAR ACESSO</button>
      </div>
    </div>
  </div>
</div>

<!-- STUDENT APP -->
<div id="sa" class="hidden">
  <header class="hdr">
    <div class="brand"><div class="blog">ESC</div><div><div class="bname">ESC Plataforma</div><div class="bsub" id="sTurmaHdr">Telemetria B30</div></div></div>
    <div class="hright">
      <div id="ew" class="expw hidden">âš ï¸ Expira em <span id="ed"></span>d</div>
      <div class="uchip"><div id="sAv" class="uav">?</div><span id="sNm" class="uname"></span></div>
      <button id="sOut" class="btn bg2 btn-sm">Sair</button>
    </div>
  </header>
  <div class="l2">
    <nav class="sbar">
      <div class="nsect">NavegaÃ§Ã£o</div>
      <div class="ni act" data-pg="dash"><span class="nic">ğŸ </span>Meu Progresso</div>
      <div class="ni" data-pg="class"><span class="nic">ğŸ“</span>Sala de Aula</div>
      <div class="ni" data-pg="mural"><span class="nic">ğŸ“‹</span>Mural</div>
      <div class="ni" data-pg="forum"><span class="nic">ğŸ’¬</span>FÃ³rum</div>
      <div class="nsect">MÃ³dulos</div>
      <div id="sML"></div>
      <div class="nsect" style="margin-top:18px">Progresso</div>
      <div style="padding:4px">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:.83rem;color:var(--soft)">ConcluÃ­do</span><span style="font-size:.83rem;font-weight:800;color:var(--cyan)" id="sPct">0%</span></div>
        <div class="pw lg"><div id="sBar" class="pf" style="width:0%"></div></div>
        <div style="font-size:.75rem;color:var(--muted);margin-top:6px" id="sLbl">0 de 0 mÃ³dulos</div>
      </div>
    </nav>
    <div class="mcont">

      <!-- DASHBOARD -->
      <div id="pg-dash" class="page act">
        <div style="margin-bottom:22px">
          <h1 style="font-family:var(--fd);font-size:1.3rem;color:#bff6ff;margin-bottom:3px">OlÃ¡, <span id="dWel"></span>! ğŸ‘‹</h1>
          <div style="color:var(--soft);font-size:.93rem">Continue de onde parou.</div>
        </div>

        <!-- LIVE CARD -->
        <div id="liveSection" class="hidden">
          <div class="livecard">
            <div class="livecard-inner">
              <div class="livebadge"><div class="livedot"></div> AO VIVO AGORA</div>
              <div style="font-family:var(--fd);font-size:1.05rem;color:#fff;margin-bottom:6px" id="liveTitulo">Aula ao Vivo</div>
              <div style="font-size:.88rem;color:rgba(255,255,255,.7);margin-bottom:16px" id="liveDesc">Sua turma estÃ¡ em aula agora!</div>
              <a id="liveBtn" href="#" target="_blank" rel="noopener" class="btn blv">
                <div class="livedot"></div> ENTRAR NA AULA
              </a>
            </div>
          </div>
        </div>

        <!-- COUNTDOWN -->
        <div id="cdSection" class="hidden">
          <div class="cdcard">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
              <div>
                <div style="font-family:var(--fd);font-size:.88rem;color:var(--purple);margin-bottom:3px">â±ï¸ PRÃ“XIMA AULA</div>
                <div style="font-weight:800;font-size:1rem" id="cdTitulo">â€”</div>
                <div style="font-size:.82rem;color:var(--muted);margin-top:2px" id="cdData">â€”</div>
              </div>
              <span class="badge bpp" id="cdTurmaLabel"></span>
            </div>
            <div class="cdgrid">
              <div class="cdu"><div class="cdv" id="cdD">00</div><div class="cdl">Dias</div></div>
              <div class="cdu"><div class="cdv" id="cdH">00</div><div class="cdl">Horas</div></div>
              <div class="cdu"><div class="cdv" id="cdM">00</div><div class="cdl">Min</div></div>
              <div class="cdu"><div class="cdv" id="cdS">00</div><div class="cdl">Seg</div></div>
            </div>
          </div>
        </div>

        <div class="sgrid" style="margin-bottom:20px">
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">ğŸ“š</div><div class="sval" id="dPct">0%</div><div class="slbl">ConcluÃ­do</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">âœ…</div><div class="sval" id="dDone">0/0</div><div class="slbl">MÃ³dulos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">â±ï¸</div><div class="sval" id="dTime">0h</div><div class="slbl">Tempo total</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">ğŸ¯</div><div class="sval" id="dQuiz">â€”</div><div class="slbl">Ãšltimo quiz</div></div>
        </div>
        <div class="card cp">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div style="font-family:var(--fd);font-size:.95rem;color:#bff6ff">ğŸ—ºï¸ Trilha de Aprendizado</div>
            <span id="dTurma" class="badge bc"></span>
          </div>
          <div id="trail" class="trail"></div>
        </div>
      </div>

      <!-- CLASSROOM -->
      <div id="pg-class" class="page">
        <div class="cgrid">
          <div class="card">
            <div style="padding:11px 11px 0">
              <div class="plwr">
                <div id="vc" style="width:100%;height:100%;display:grid;place-items:center;color:var(--muted)">Selecione um mÃ³dulo</div>
                <div class="pov"><span class="ptag" id="pMod">ğŸ“– MÃ³dulo</span><span class="ptag">ğŸ¬ HD</span></div>
              </div>
            </div>
            <div class="tbar">
              <button class="tb act" data-tab="cont">ğŸ“– ConteÃºdo</button>
              <button class="tb" data-tab="mat">ğŸ“ Materiais</button>
              <button class="tb" data-tab="quiz">ğŸ¯ Quiz</button>
              <button class="tb" data-tab="note">ğŸ“ AnotaÃ§Ãµes</button>
              <button class="tb" data-tab="fmod">ğŸ’¬ FÃ³rum</button>
            </div>
            <div>
              <div id="tab-cont" class="tp act">
                <h3 style="color:var(--cyan);margin-bottom:11px" id="cMT">â€”</h3>
                <div id="cTop" style="color:var(--soft);line-height:2"></div>
                <hr class="div"/>
                <div style="border:1px solid var(--border);border-radius:var(--r);padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
                  <div><div style="font-size:.83rem;color:var(--soft);margin-bottom:4px">Progresso do vÃ­deo</div><div id="vPct" style="font-size:1.7rem;font-weight:900;color:#bff6ff">0%</div></div>
                  <button id="bDone" class="btn bp btn-sm">âœ… Concluir</button>
                </div>
              </div>
              <div id="tab-mat" class="tp"><h3 style="color:var(--cyan);margin-bottom:12px">ğŸ“ Materiais</h3><div id="cMat"></div></div>
              <div id="tab-quiz" class="tp"><h3 style="color:var(--cyan);margin-bottom:12px">ğŸ¯ Quiz</h3><div id="qCont"></div></div>
              <div id="tab-note" class="tp">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:11px">
                  <h3 style="color:var(--cyan)">ğŸ“ AnotaÃ§Ãµes</h3>
                  <button id="bNote" class="btn bo btn-sm">ğŸ’¾ Salvar</button>
                </div>
                <textarea id="nta" class="nta" placeholder="Suas anotaÃ§Ãµes...&#10;&#10;ğŸ’¡ Salvas automaticamente a cada 30s."></textarea>
                <div style="font-size:.75rem;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between"><span><span id="nch">0</span> chars</span><span>Salvo: <span id="nSv">nunca</span></span></div>
              </div>
              <div id="tab-fmod" class="tp">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:11px">
                  <h3 style="color:var(--cyan)">ğŸ’¬ FÃ³rum deste mÃ³dulo</h3>
                  <button id="bNPM" class="btn bp btn-sm">+ DÃºvida</button>
                </div>
                <div id="fML"></div>
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:15px">
            <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:12px">ğŸ“š MÃ³dulos</div><div id="cML" style="display:flex;flex-direction:column;gap:7px"></div></div>
            <div class="card cp">
              <div style="font-weight:800;color:var(--cyan);margin-bottom:11px">â„¹ï¸ Detalhes</div>
              <div style="display:flex;flex-direction:column;gap:7px">
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Professor</span><span style="font-size:.85rem;font-weight:700">Equipe ESC</span></div>
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Acesso atÃ©</span><span style="font-size:.85rem;font-weight:700" id="cAU">â€”</span></div>
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Turma</span><span id="cTn" class="badge bc">â€”</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MURAL -->
      <div id="pg-mural" class="page">
        <div style="margin-bottom:20px">
          <h1 style="font-family:var(--fd);font-size:1.2rem;color:#bff6ff;margin-bottom:3px">ğŸ“‹ Mural de Avisos</h1>
          <div style="color:var(--soft);font-size:.88rem">Comunicados da sua turma</div>
        </div>
        <div id="muralList"></div>
      </div>

      <!-- FORUM -->
      <div id="pg-forum" class="page">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
          <div><h1 style="font-family:var(--fd);font-size:1.2rem;color:#bff6ff;margin-bottom:3px">ğŸ’¬ FÃ³rum</h1><div style="color:var(--soft);font-size:.88rem">Tire dÃºvidas e interaja</div></div>
          <button id="bNP" class="btn bp">+ Nova DÃºvida</button>
        </div>
        <div style="display:flex;gap:11px;margin-bottom:18px;flex-wrap:wrap">
          <select id="fMF" class="fi" style="width:auto;min-width:190px"></select>
          <select id="fSF" class="fi" style="width:auto"><option value="approved">Publicadas</option><option value="mine">Minhas postagens</option></select>
        </div>
        <div id="fList"></div>
      </div>

    </div>
  </div>
</div>

<!-- ADMIN APP -->
<div id="aa" class="hidden">
  <header class="hdr">
    <div class="brand"><div class="blog">ESC</div><div><div class="bname">Painel Admin</div><div class="bsub">Gerenciamento</div></div></div>
    <div class="hright">
      <span class="badge br" style="padding:5px 11px;font-size:.8rem">ğŸ”§ ADMIN</span>
      <div class="uchip"><div class="uav" style="background:linear-gradient(135deg,var(--red),var(--purple))">A</div><span class="uname">Administrador</span></div>
      <button id="aOut" class="btn bg2 btn-sm">Sair</button>
    </div>
  </header>
  <div class="ladm">
    <nav class="abar">
      <div class="nsect" style="margin-top:0">Menu</div>
      <div class="ani act" data-adm="dash">ğŸ“Š Dashboard</div>
      <div class="ani" data-adm="pend">ğŸ”” Pendentes <span id="pBadge" class="nbadge hidden" style="margin-left:5px">0</span></div>
      <div class="ani" data-adm="alunos">ğŸ‘¥ Alunos</div>
      <div class="ani" data-adm="turmas">ğŸ« Turmas</div>
      <div class="ani" data-adm="mods">ğŸ¬ MÃ³dulos</div>
      <div class="ani" data-adm="mats">ğŸ“ Materiais</div>
      <div class="ani" data-adm="quiz">ğŸ¯ Quiz</div>
      <div class="ani" data-adm="live">ğŸ”´ Aulas Ao Vivo</div>
      <div class="ani" data-adm="mural">ğŸ“‹ Mural</div>
      <div class="ani" data-adm="forum">ğŸ’¬ FÃ³rum</div>
    </nav>
    <div class="mcont">

      <!-- ADM DASHBOARD -->
      <div id="adm-dash" class="page act">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ“Š Dashboard</div>
        <div class="sgrid" style="margin-bottom:20px">
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">ğŸ‘¥</div><div class="sval" id="aA">0</div><div class="slbl">Alunos ativos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">â³</div><div class="sval" id="aP">0</div><div class="slbl">Pendentes</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">ğŸ¬</div><div class="sval" id="aMo">0</div><div class="slbl">MÃ³dulos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">ğŸ“ˆ</div><div class="sval" id="aMd">0%</div><div class="slbl">Progresso mÃ©dio</div></div>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ‘¥ Progresso dos Alunos</div>
          <div class="tw2"><table><thead><tr><th>Aluno</th><th>Turma</th><th>Progresso</th><th>MÃ³dulos</th><th>Validade</th><th>Status</th></tr></thead><tbody id="aDT"></tbody></table></div>
        </div>
      </div>

      <!-- PENDENTES -->
      <div id="adm-pend" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ”” SolicitaÃ§Ãµes Pendentes</div>
        <div id="pendCont" class="card cp"></div>
      </div>

      <!-- ALUNOS -->
      <div id="adm-alunos" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ‘¥ Gerenciar Alunos</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Criar Aluno</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="aNome" class="fi" placeholder="JoÃ£o da Silva"/></div>
            <div class="fg"><label class="fl">Email</label><input id="aEmail" class="fi" type="email" placeholder="joao@emp.com"/></div>
            <div class="fg"><label class="fl">Login</label><input id="aLogin" class="fi" placeholder="joao.silva"/></div>
            <div class="fg"><label class="fl">Senha</label><input id="aPass" class="fi" type="password" placeholder="Min. 6 chars"/></div>
            <div class="fg"><label class="fl">Turma</label><select id="aTurma" class="fi"><option value="">Sem turma</option></select></div>
            <div class="fg"><label class="fl">Meses de acesso</label><input id="aMes" class="fi" type="number" value="12" min="1"/></div>
          </div>
          <button id="bCA" class="btn bp" style="margin-top:13px">â• Criar Aluno</button>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ Todos os alunos</div>
          <div class="tw2"><table><thead><tr><th>Nome</th><th>Login</th><th>Turma</th><th>Validade</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="aAT"></tbody></table></div>
        </div>
      </div>

      <!-- TURMAS -->
      <div id="adm-turmas" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ« Turmas</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Nova Turma</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="tNome" class="fi" placeholder="B30 â€” Jan/2025"/></div>
            <div class="fg"><label class="fl">DescriÃ§Ã£o</label><input id="tDesc" class="fi" placeholder="Opcional"/></div>
          </div>
          <button id="bST" class="btn bp" style="margin-top:13px">ğŸ’¾ Salvar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ Turmas</div><div class="tw2"><table><thead><tr><th>Nome</th><th>Alunos</th><th>MÃ³dulos</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody id="aTT"></tbody></table></div></div>
      </div>

      <!-- MODULOS -->
      <div id="adm-mods" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ¬ MÃ³dulos</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Adicionar / Editar</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">TÃ­tulo</label><input id="mTit" class="fi" placeholder="IntroduÃ§Ã£o"/></div>
            <div class="fg"><label class="fl">Ãcone</label><input id="mIco" class="fi" placeholder="ğŸ“–" maxlength="4"/></div>
            <div class="fg"><label class="fl">Turma</label><select id="mTur" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">Tipo de vÃ­deo</label><select id="mVT" class="fi"><option value="youtube">YouTube</option><option value="vimeo">Vimeo</option><option value="mp4">MP4 direto</option></select></div>
            <div class="fg full"><label class="fl">URL do vÃ­deo</label><input id="mVU" class="fi" placeholder="https://www.youtube.com/watch?v=..."/></div>
            <div class="fg"><label class="fl">DuraÃ§Ã£o (min)</label><input id="mDur" class="fi" type="number" placeholder="15" min="1"/></div>
            <div class="fg"><label class="fl">Ordem</label><input id="mOrd" class="fi" type="number" placeholder="1" min="1"/></div>
            <div class="fg full"><label class="fl">TÃ³picos (um por linha)</label><textarea id="mTop" class="fi" rows="4" placeholder="Conceito de telemetria&#10;AnÃ¡lise de alarmes"></textarea></div>
            <input type="hidden" id="mEId"/>
          </div>
          <div style="display:flex;gap:10px;margin-top:13px"><button id="bSM" class="btn bp">ğŸ’¾ Salvar</button><button id="bCM" class="btn bg2">âœ– Limpar</button></div>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ MÃ³dulos</div><div class="tw2"><table><thead><tr><th>Ord</th><th>MÃ³dulo</th><th>Turma</th><th>Tipo</th><th>DuraÃ§Ã£o</th><th>AÃ§Ãµes</th></tr></thead><tbody id="aMT2"></tbody></table></div></div>
      </div>

      <!-- MATERIAIS -->
      <div id="adm-mats" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ“ Materiais</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Adicionar Material</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="matN" class="fi" placeholder="Slides da aula"/></div>
            <div class="fg"><label class="fl">Tipo</label><select id="matT" class="fi"><option value="pdf">ğŸ“Š PDF</option><option value="doc">ğŸ“‹ Doc</option><option value="xlsx">ğŸ“ˆ Planilha</option><option value="link">ğŸ”— Link</option><option value="other">ğŸ“¦ Outro</option></select></div>
            <div class="fg full"><label class="fl">URL</label><input id="matU" class="fi" placeholder="https://..."/></div>
            <div class="fg"><label class="fl">DescriÃ§Ã£o</label><input id="matD" class="fi" placeholder="Breve descriÃ§Ã£o"/></div>
            <div class="fg"><label class="fl">MÃ³dulo</label><select id="matM" class="fi"><option value="">Todos</option></select></div>
          </div>
          <button id="bSMat" class="btn bp" style="margin-top:13px">â• Adicionar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ Materiais</div><div class="tw2"><table><thead><tr><th>Nome</th><th>Tipo</th><th>MÃ³dulo</th><th>URL</th><th></th></tr></thead><tbody id="aMatT"></tbody></table></div></div>
      </div>

      <!-- QUIZ -->
      <div id="adm-quiz" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ¯ Quiz</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Nova QuestÃ£o</div>
          <div class="fgrid">
            <div class="fg full"><label class="fl">Enunciado</label><textarea id="qEn" class="fi" rows="2" placeholder="Qual mÃ©trica..."></textarea></div>
            <div class="fg full"><label class="fl">OpÃ§Ãµes (marque a correta)</label>
              <div style="display:flex;flex-direction:column;gap:7px;margin-top:5px">
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="0" style="accent-color:var(--cyan)"/><input id="qO0" class="fi" placeholder="OpÃ§Ã£o A"/></div>
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="1" style="accent-color:var(--cyan)"/><input id="qO1" class="fi" placeholder="OpÃ§Ã£o B"/></div>
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="2" style="accent-color:var(--cyan)"/><input id="qO2" class="fi" placeholder="OpÃ§Ã£o C"/></div>
              </div>
            </div>
            <div class="fg"><label class="fl">MÃ³dulo</label><select id="qMod" class="fi"><option value="">Geral</option></select></div>
          </div>
          <button id="bSQ" class="btn bp" style="margin-top:13px">â• Adicionar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ QuestÃµes</div><div id="aQL" style="display:flex;flex-direction:column;gap:9px"></div></div>
      </div>

      <!-- AULAS AO VIVO -->
      <div id="adm-live" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:6px">ğŸ”´ Aulas Ao Vivo</div>
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:20px">Configure a aula ao vivo e o contador da prÃ³xima aula por turma.</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ”´ Ativar / Desativar Aula Ao Vivo</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="lvTurma" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">TÃ­tulo da aula</label><input id="lvTit" class="fi" placeholder="Ex: MÃ³dulo 3 â€” Telemetria ao vivo"/></div>
            <div class="fg full"><label class="fl">Link (YouTube Live / Google Meet)</label><input id="lvLink" class="fi" placeholder="https://youtube.com/live/..."/></div>
            <div class="fg"><label class="fl">DescriÃ§Ã£o curta</label><input id="lvDesc" class="fi" placeholder="Ex: AnÃ¡lise de alarmes B30"/></div>
            <div class="fg"><label class="fl">Status</label>
              <select id="lvStatus" class="fi">
                <option value="1">ğŸ”´ Ativar â€” Aula ao vivo AGORA</option>
                <option value="0">âš« Desativar</option>
              </select>
            </div>
          </div>
          <button id="bSLV" class="btn bp" style="margin-top:13px">ğŸ’¾ Salvar configuraÃ§Ã£o</button>
        </div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--purple);margin-bottom:13px">â±ï¸ Contador â€” PrÃ³xima Aula</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="cdTurma" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">TÃ­tulo da prÃ³xima aula</label><input id="cdTit" class="fi" placeholder="Ex: Aula 4 â€” Dashboards"/></div>
            <div class="fg"><label class="fl">Data e hora</label><input id="cdDH" class="fi" type="datetime-local"/></div>
            <div class="fg"><label class="fl">Ativo?</label>
              <select id="cdAtivo" class="fi">
                <option value="1">âœ… Mostrar contador</option>
                <option value="0">âŒ Ocultar</option>
              </select>
            </div>
          </div>
          <button id="bSCD" class="btn bp" style="margin-top:13px">ğŸ’¾ Salvar contador</button>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ ConfiguraÃ§Ãµes ativas por turma</div>
          <div id="lvTable"></div>
        </div>
      </div>

      <!-- MURAL ADMIN -->
      <div id="adm-mural" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:6px">ğŸ“‹ Mural de Avisos</div>
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:20px">Poste comunicados visÃ­veis para alunos de cada turma.</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">â• Novo Aviso</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="mrTurma" class="fi"><option value="">Todas as turmas</option></select></div>
            <div class="fg"><label class="fl">Fixar no topo?</label><select id="mrFix" class="fi"><option value="0">NÃ£o</option><option value="1">ğŸ“Œ Sim</option></select></div>
            <div class="fg full"><label class="fl">TÃ­tulo</label><input id="mrTit" class="fi" placeholder="Ex: Aula cancelada â€” reagendada"/></div>
            <div class="fg full"><label class="fl">ConteÃºdo</label><textarea id="mrCont" class="fi" rows="4" placeholder="Texto do aviso..."></textarea></div>
          </div>
          <button id="bSMR" class="btn bp" style="margin-top:13px">ğŸ“¤ Publicar Aviso</button>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ“‹ Avisos publicados</div>
          <div id="aMuralList"></div>
        </div>
      </div>

      <!-- FORUM ADMIN -->
      <div id="adm-forum" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">ğŸ’¬ ModeraÃ§Ã£o do FÃ³rum</div>
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
          <select id="aFF" class="fi" style="width:auto"><option value="pending">â³ Aguardando</option><option value="approved">âœ… Aprovados</option><option value="all">Todos</option></select>
          <button id="bRF" class="btn bg2 btn-sm">ğŸ”„ Atualizar</button>
        </div>
        <div id="aFL"></div>
      </div>

    </div>
  </div>
</div>

<div id="mBg" class="mbg hidden"><div id="mCont" class="modal"></div></div>

<script>
let sb=null;
try{sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);}catch(e){}
let CU=null,CTurma=null,mods=[],actMod=null,wTimer=null,wSec=0,cdTimer=null;
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
function ft(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60,p=n=>String(n).padStart(2,'0');return h>0?`${h}:${p(m)}:${p(sec)}`:`${p(m)}:${p(sec)}`;}
function pct(a,b){return b>0?Math.round((a/b)*100):0;}
async function sha(s){const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));return Array.from(new Uint8Array(b)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function fd(d){return d?new Date(d).toLocaleDateString('pt-BR'):'â€”';}
function fdt(d){return d?new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'â€”';}
function du(d){return d?Math.ceil((new Date(d)-new Date())/(864e5)):null;}
function ti(t){return{pdf:'ğŸ“Š',doc:'ğŸ“‹',xlsx:'ğŸ“ˆ',link:'ğŸ”—',other:'ğŸ“¦'}[t]||'ğŸ“¦';}
function toast(msg,tp='i'){const el=document.createElement('div');el.className=`toast t${tp}`;el.textContent=msg;$('#tc').appendChild(el);setTimeout(()=>{el.style.animation='tIn .3s ease reverse';setTimeout(()=>el.remove(),300);},3000);}
function showModal(html){$('#mCont').innerHTML=html;$('#mBg').classList.remove('hidden');}
function closeModal(){$('#mBg').classList.add('hidden');}
$('#mBg').addEventListener('click',e=>{if(e.target===$('#mBg'))closeModal();});

/* LOGIN */
$$('.ltab').forEach(t=>t.addEventListener('click',()=>{
  $$('.ltab').forEach(x=>x.classList.remove('act'));t.classList.add('act');
  const tb=t.dataset.lt;
  $('#lf-login').classList.toggle('hidden',tb!=='login');
  $('#lf-reg').classList.toggle('hidden',tb!=='reg');
}));
$('#lBtn').addEventListener('click',doLogin);
$('#lPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
async function doLogin(){
  const lg=$('#lUser').value.trim(),pw=$('#lPass').value.trim(),err=$('#lErr');
  if(!lg||!pw){err.textContent='Preencha login e senha.';return;}
  err.textContent='';
  if(!sb){
    if(lg==='admin'&&pw==='admin2024'){CU={id:'da',nome:'Administrador',login:'admin',role:'admin',status:'active'};showAdmin();}
    else if(lg==='aluno1'&&pw==='123456'){CU={id:'ds1',nome:'Carlos Demo',login:'aluno1',role:'student',status:'active',turma_id:null,validade_acesso:'2027-01-01'};showStudent();}
    else{err.textContent='Demo: admin/admin2024 ou aluno1/123456';}
    return;
  }
  $('#lBtn').disabled=true;
  const hash=await sha(pw);
  const{data,error}=await sb.from('users').select('*').eq('login',lg).eq('senha',hash).single();
  $('#lBtn').disabled=false;
  if(error||!data){err.textContent='Login ou senha incorretos.';return;}
  if(data.status==='pending'){err.textContent='Cadastro aguardando aprovacao.';return;}
  if(data.status==='blocked'){err.textContent='Acesso bloqueado. Contate o admin.';return;}
  if(data.status==='expired'||(data.validade_acesso&&new Date(data.validade_acesso)<new Date())){err.textContent='Acesso expirado.';return;}
  CU=data;data.role==='admin'?showAdmin():showStudent();
}
$('#rBtn').addEventListener('click',async()=>{
  const n=$('#rNome').value.trim(),e=$('#rEmail').value.trim(),l=$('#rLogin').value.trim(),p=$('#rPass').value.trim(),err=$('#rErr');
  if(!n||!e||!l||!p){err.textContent='Preencha todos os campos.';return;}
  if(p.length<6){err.textContent='Senha minimo 6 caracteres.';return;}
  if(!sb){toast('Configure o Supabase.','w');return;}
  $('#rBtn').disabled=true;
  const hash=await sha(p);
  const{error}=await sb.from('users').insert({nome:n,email:e,login:l,senha:hash,role:'student',status:'pending'});
  $('#rBtn').disabled=false;
  if(error){$('#rErr').textContent=error.message.includes('unique')?'Login ou email ja em uso.':'Erro ao enviar.';return;}
  toast('Solicitacao enviada! Aguarde aprovacao.','s');document.querySelector('[data-lt="login"]').click();
});
function doLogout(){
  CU=null;CTurma=null;actMod=null;mods=[];
  if(wTimer)clearInterval(wTimer);if(cdTimer)clearInterval(cdTimer);
  $('#sa').classList.add('hidden');$('#aa').classList.add('hidden');
  $('#ls').style.display='flex';$('#lUser').value='';$('#lPass').value='';
}
$('#sOut').addEventListener('click',doLogout);
$('#aOut').addEventListener('click',doLogout);

/* STUDENT */
async function showStudent(){
  $('#ls').style.display='none';$('#sa').classList.remove('hidden');
  const ini=CU.nome.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  $('#sAv').textContent=ini;$('#sNm').textContent=CU.nome;$('#dWel').textContent=CU.nome.split(' ')[0];
  $('#cAU').textContent=fd(CU.validade_acesso);
  const d=du(CU.validade_acesso);
  if(d!==null&&d<=30&&d>0){$('#ew').classList.remove('hidden');$('#ed').textContent=d;}
  await loadMods();renderDash();renderSML();loadLiveSection();loadCountdown();
  $$('[data-pg]').forEach(item=>item.addEventListener('click',()=>{
    const pg=item.dataset.pg;
    $$('[data-pg]').forEach(x=>x.classList.remove('act'));item.classList.add('act');
    $$('#sa .page').forEach(p=>p.classList.remove('act'));
    document.querySelector(`#pg-${pg}`).classList.add('act');
    if(pg==='forum')loadFPage();if(pg==='mural')loadMural();
  }));
  $$('.tb').forEach(b=>b.addEventListener('click',()=>{
    const tab=b.dataset.tab;
    $$('.tb').forEach(x=>x.classList.remove('act'));b.classList.add('act');
    $$('.tp').forEach(p=>p.classList.remove('act'));
    document.querySelector(`#tab-${tab}`).classList.add('act');
    if(tab==='note')loadNote();if(tab==='fmod')loadFMod();if(tab==='quiz')loadQuiz();
  }));
}
async function loadLiveSection(){
  if(!sb||!CU.turma_id){$('#liveSection').classList.add('hidden');return;}
  const{data}=await sb.from('aulas_ao_vivo').select('*').eq('turma_id',CU.turma_id).eq('tipo','live').eq('ativa',true).single();
  if(!data){$('#liveSection').classList.add('hidden');return;}
  $('#liveTitulo').textContent=data.titulo||'Aula Ao Vivo';
  $('#liveDesc').textContent=data.descricao||'Sua turma esta em aula agora!';
  $('#liveBtn').href=data.link||'#';
  $('#liveSection').classList.remove('hidden');
}
async function loadCountdown(){
  if(cdTimer)clearInterval(cdTimer);
  if(!sb||!CU.turma_id){$('#cdSection').classList.add('hidden');return;}
  const{data}=await sb.from('aulas_ao_vivo').select('*').eq('turma_id',CU.turma_id).eq('tipo','countdown').eq('ativa',true).single();
  if(!data||!data.data_hora){$('#cdSection').classList.add('hidden');return;}
  const target=new Date(data.data_hora);
  if(target<new Date()){$('#cdSection').classList.add('hidden');return;}
  $('#cdTitulo').textContent=data.titulo||'Proxima Aula';
  $('#cdData').textContent=fdt(data.data_hora);
  $('#cdTurmaLabel').textContent=CTurma?.nome||'';
  $('#cdSection').classList.remove('hidden');
  function tick(){
    const now=new Date(),diff=target-now;
    if(diff<=0){$('#cdSection').classList.add('hidden');clearInterval(cdTimer);return;}
    const dd=Math.floor(diff/864e5),hh=Math.floor((diff%864e5)/36e5),mm=Math.floor((diff%36e5)/6e4),ss=Math.floor((diff%6e4)/1e3);
    const p=n=>String(n).padStart(2,'0');
    $('#cdD').textContent=p(dd);$('#cdH').textContent=p(hh);$('#cdM').textContent=p(mm);$('#cdS').textContent=p(ss);
  }
  tick();cdTimer=setInterval(tick,1000);
}
async function loadMods(){
  if(!sb){
    mods=[{id:'dm1',titulo:'Introducao',icone:'ğŸ“–',duracao_seg:720,video_type:'youtube',video_url:'',topicos:'Visao geral',ordem:1},{id:'dm2',titulo:'Parametros',icone:'ğŸ“Š',duracao_seg:840,video_type:'youtube',video_url:'',topicos:'Tipos',ordem:2}];
    CTurma={nome:'Demo'};$('#sTurmaHdr').textContent='Turma Demo';return;
  }
  if(CU.turma_id){
    const{data:t}=await sb.from('turmas').select('*').eq('id',CU.turma_id).single();
    CTurma=t;if(t)$('#sTurmaHdr').textContent=t.nome;
    const{data:m}=await sb.from('modules').select('*').eq('turma_id',CU.turma_id).eq('ativo',true).order('ordem');
    mods=m||[];
  }else{CTurma=null;mods=[];}
}
async function getProg(){
  if(!sb||!mods.length)return{};
  const{data}=await sb.from('progress').select('*').eq('user_id',CU.id).in('modulo_id',mods.map(m=>m.id));
  const r={};(data||[]).forEach(p=>{r[p.modulo_id]=p;});return r;
}
async function renderDash(){
  $('#dTurma').textContent=CTurma?.nome||'Sem turma';$('#cTn').textContent=CTurma?.nome||'â€”';
  const pm=await getProg();
  const done=mods.filter(m=>pm[m.id]?.concluido).length,total=mods.length;
  const p=pct(done,total),ts=Object.values(pm).reduce((s,x)=>s+(x.segundos_vistos||0),0);
  const qs=Object.values(pm).filter(x=>x.quiz_score!==null&&x.quiz_score!==undefined);
  $('#dPct').textContent=p+'%';$('#dDone').textContent=`${done}/${total}`;
  $('#dTime').textContent=(ts/3600).toFixed(1)+'h';$('#dQuiz').textContent=qs.length?`${qs[qs.length-1].quiz_score}/${qs[qs.length-1].quiz_total||'?'}`:'â€”';
  $('#sPct').textContent=p+'%';$('#sBar').style.width=p+'%';$('#sLbl').textContent=`${done} de ${total} modulos`;
  const tr=$('#trail');tr.innerHTML='';
  mods.forEach(m=>{
    const mp=pm[m.id]||{segundos_vistos:0,concluido:false},pp=pct(mp.segundos_vistos||0,m.duracao_seg||1),isDone=mp.concluido,isCur=actMod===m.id;
    const el=document.createElement('div');el.className='tri';
    el.innerHTML=`<div class="tdot ${isDone?'done':isCur?'cur':'lock'}">${isDone?'âœ…':m.icone}</div><div style="flex:1;padding-top:7px"><div style="font-weight:800;font-size:.97rem;margin-bottom:5px;color:${isDone?'var(--green)':isCur?'var(--cyan)':'var(--text)'}">${m.titulo}</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:.8rem;color:var(--muted)">â±ï¸ ${ft(m.duracao_seg)}</span>${isDone?'<span class="badge bg3">Concluido</span>':pp>0?`<span class="badge bc">Em andamento ${pp}%</span>`:'<span class="badge bw2">Nao iniciado</span>'}</div><div class="pw" style="max-width:260px"><div class="pf" style="width:${isDone?100:pp}%"></div></div><div style="margin-top:9px"><button class="btn bp btn-sm" onclick="openMod('${m.id}')">${isDone?'ğŸ” Rever':pp>0?'â–¶ï¸ Continuar':'â–¶ï¸ Iniciar'}</button></div></div>`;
    tr.appendChild(el);
  });
  if(!mods.length)tr.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum modulo disponivel para sua turma.</div>';
}
function renderSML(){
  const l=$('#sML');l.innerHTML='';
  mods.forEach(m=>{
    const el=document.createElement('div');el.className=`ni${actMod===m.id?' act':''}`;
    el.innerHTML=`<span class="nic">${m.icone}</span><span style="font-size:.84rem">${m.titulo}</span>`;
    el.addEventListener('click',()=>openMod(m.id));l.appendChild(el);
  });
}
window.openMod=function(id){
  actMod=id;
  $$('[data-pg]').forEach(x=>x.classList.remove('act'));
  document.querySelector('[data-pg="class"]').classList.add('act');
  $$('#sa .page').forEach(p=>p.classList.remove('act'));
  $('#pg-class').classList.add('act');
  const m=mods.find(x=>x.id===id);if(!m)return;
  $('#pMod').textContent=`${m.icone} ${m.titulo}`;$('#cMT').textContent=m.titulo;
  $('#cTop').innerHTML=(m.topicos||'').split('\n').filter(Boolean).map(t=>`â€¢ ${t}<br/>`).join('')||'<span style="color:var(--muted)">Sem topicos.</span>';
  loadVideo(m);renderCML();loadCMats(id);loadQuiz();
  $('#nta').oninput=()=>{$('#nch').textContent=$('#nta').value.length;};
  renderDash();renderSML();
};
function loadVideo(m){
  const vc=$('#vc');if(wTimer)clearInterval(wTimer);
  if(!m.video_url){vc.innerHTML='<div style="color:var(--muted)">ğŸ“¹ Video em breve</div>';startWT(m);return;}
  if(m.video_type==='youtube'){const vid=ytId(m.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://www.youtube.com/embed/${vid}?rel=0" allowfullscreen></iframe>`:'';}
  else if(m.video_type==='vimeo'){const vid=vmId(m.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://player.vimeo.com/video/${vid}" allowfullscreen></iframe>`:'';}
  else{vc.innerHTML=`<video class="vif" controls preload="metadata"><source src="${m.video_url}" type="video/mp4"/></video>`;}
  startWT(m);
}
function ytId(u){const m=u.match(/(?:v=|youtu\.be\/|embed\/)([^#&?]{11})/);return m?m[1]:null;}
function vmId(u){const m=u.match(/vimeo.*\/(\d+)/i);return m?m[1]:null;}
async function startWT(m){
  if(sb&&CU){const{data}=await sb.from('progress').select('*').eq('user_id',CU.id).eq('modulo_id',m.id).single();wSec=data?.segundos_vistos||0;}else wSec=0;
  updVP(m);wTimer=setInterval(async()=>{wSec=Math.min(wSec+1,m.duracao_seg);updVP(m);if(wSec%20===0)await svP(m);},1000);
}
function updVP(m){$('#vPct').textContent=pct(wSec,m.duracao_seg)+'%';}
async function svP(m,done=null){
  if(!sb||!CU)return;
  const pay={user_id:CU.id,modulo_id:m.id,segundos_vistos:wSec,atualizado_em:new Date().toISOString()};
  if(done!==null)pay.concluido=done;
  await sb.from('progress').upsert(pay,{onConflict:'user_id,modulo_id'});
}
$('#bDone').addEventListener('click',async()=>{
  const m=mods.find(x=>x.id===actMod);if(!m)return;
  const p=pct(wSec,m.duracao_seg);
  if(p<80&&!confirm(`Assistiu apenas ${p}%. Concluir mesmo assim?`))return;
  await svP(m,true);toast('Modulo concluido!','s');renderDash();
});
function renderCML(){
  const l=$('#cML');l.innerHTML='';
  mods.forEach(m=>{
    const el=document.createElement('div');
    el.style.cssText=`display:flex;align-items:center;gap:7px;padding:8px 10px;border-radius:var(--rs);cursor:pointer;transition:all .18s;border:1px solid ${m.id===actMod?'rgba(0,200,255,.28)':'transparent'};background:${m.id===actMod?'rgba(0,200,255,.07)':'transparent'}`;
    el.innerHTML=`<span>${m.icone}</span><span style="font-size:.85rem;font-weight:700">${m.titulo}</span>`;
    el.addEventListener('click',()=>openMod(m.id));l.appendChild(el);
  });
}
async function loadCMats(id){
  const l=$('#cMat');if(!sb){l.innerHTML='<div style="color:var(--muted)">Conecte o Supabase.</div>';return;}
  const{data}=await sb.from('materials').select('*').or(`modulo_id.eq.${id},modulo_id.is.null`);
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhum material.</div>';return;}
  l.innerHTML=data.map(mat=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:11px;border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;background:rgba(0,0,0,.18)"><div><div style="font-weight:700">${ti(mat.tipo)} ${mat.nome}</div><div style="font-size:.82rem;color:var(--muted)">${mat.descricao||''}</div></div><a class="btn bp btn-sm" href="${mat.url}" target="_blank" rel="noopener">Acessar</a></div>`).join('');
}
async function loadNote(){
  if(!actMod||!sb||!CU)return;
  const{data}=await sb.from('notes').select('*').eq('user_id',CU.id).eq('modulo_id',actMod).single();
  $('#nta').value=data?.conteudo||'';$('#nch').textContent=$('#nta').value.length;
  $('#nSv').textContent=data?.atualizado_em?new Date(data.atualizado_em).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'nunca';
}
$('#bNote').addEventListener('click',async()=>{
  if(!sb||!actMod||!CU)return;
  await sb.from('notes').upsert({user_id:CU.id,modulo_id:actMod,conteudo:$('#nta').value,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});
  $('#nSv').textContent=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});toast('Anotacoes salvas!','s');
});
setInterval(async()=>{
  if(sb&&CU&&actMod&&$('#nta').value)
    await sb.from('notes').upsert({user_id:CU.id,modulo_id:actMod,conteudo:$('#nta').value,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});
},30000);
async function loadQuiz(){
  const qc=$('#qCont');if(!actMod)return;
  if(sb&&CU){
    const{data:pr}=await sb.from('progress').select('quiz_score,quiz_total').eq('user_id',CU.id).eq('modulo_id',actMod).single();
    if(pr?.quiz_score!==null&&pr?.quiz_score!==undefined){qc.innerHTML=`<div style="padding:15px;border:1px solid var(--green);border-radius:var(--r);background:rgba(15,186,129,.07)"><div style="font-weight:800;color:var(--green);margin-bottom:5px">Quiz respondido!</div><div>Nota: <strong>${pr.quiz_score}/${pr.quiz_total}</strong></div></div>`;return;}
  }
  let qs=[];
  if(sb){const{data}=await sb.from('quiz').select('*').or(`modulo_id.eq.${actMod},modulo_id.is.null`).limit(10);qs=data||[];}
  if(!qs.length){qc.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma questao para este modulo.</div>';return;}
  qc.innerHTML=qs.map((q,i)=>`<div class="card cp" style="margin-bottom:12px" data-qid="${q.id}"><div style="font-weight:800;margin-bottom:11px">${i+1}. ${q.question}</div><div style="display:flex;flex-direction:column;gap:6px">${(q.options||[]).map((o,oi)=>`<label style="display:flex;align-items:center;gap:9px;padding:9px;border:1px solid var(--border);border-radius:var(--rs);cursor:pointer" class="qo"><input type="radio" name="q_${q.id}" value="${oi}" style="accent-color:var(--cyan)"/> ${o}</label>`).join('')}</div></div>`).join('')+`<button id="bSQ2" class="btn bp">Enviar Respostas</button>`;
  qc.querySelectorAll('.qo').forEach(o=>o.addEventListener('click',function(){
    const qb=this.closest('[data-qid]');
    qb.querySelectorAll('.qo').forEach(x=>{x.style.borderColor='var(--border)';x.style.background='';});
    this.style.borderColor='var(--cyan)';this.style.background='rgba(0,200,255,.08)';
  }));
  document.getElementById('bSQ2').addEventListener('click',async()=>{
    let sc=0,ok=true;
    qs.forEach(q=>{const s=qc.querySelector(`input[name="q_${q.id}"]:checked`);if(!s){ok=false;return;}if(parseInt(s.value)===parseInt(q.correct_option))sc++;});
    if(!ok){toast('Responda todas!','w');return;}
    if(sb&&CU)await sb.from('progress').upsert({user_id:CU.id,modulo_id:actMod,segundos_vistos:wSec,quiz_score:sc,quiz_total:qs.length,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});
    toast(`${sc}/${qs.length} corretas!`,sc===qs.length?'s':'i');loadQuiz();renderDash();
  });
}

/* MURAL ALUNO */
async function loadMural(){
  const l=$('#muralList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  if(!sb){l.innerHTML='<div style="color:var(--muted)">Configure o Supabase.</div>';return;}
  let q=sb.from('mural_avisos').select('*').eq('ativo',true).order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(CU.turma_id)q=q.or('turma_id.eq.'+CU.turma_id+',turma_id.is.null');else q=q.is('turma_id',null);
  const{data}=await q.limit(30);
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum aviso no momento.</div>';return;}
  l.innerHTML=data.map(av=>
    '<div class="muralcard'+(av.fixado?' fix':'')+'">'+
    (av.fixado?'<div class="muralfix">ğŸ“Œ FIXADO</div>':'')+
    '<div style="display:flex;align-items:start;gap:11px">'+
    '<div style="font-size:1.5rem;flex-shrink:0">ğŸ“¢</div>'+
    '<div style="flex:1">'+
    '<div style="font-weight:800;font-size:1rem;margin-bottom:5px">'+av.titulo+'</div>'+
    '<div style="color:var(--soft);font-size:.9rem;line-height:1.6;margin-bottom:9px">'+av.conteudo+'</div>'+
    '<div style="font-size:.75rem;color:var(--muted)">'+fdt(av.criado_em)+'</div>'+
    '</div></div></div>'
  ).join('');
}

/* FORUM ALUNO */
async function loadFPage(){
  $('#fMF').innerHTML='<option value="">Todos os modulos</option>'+mods.map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  await renderFL();
  $('#fMF').onchange=renderFL;$('#fSF').onchange=renderFL;
}
async function renderFL(){
  const l=$('#fList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  if(!sb){l.innerHTML='<div style="color:var(--muted)">Configure o Supabase.</div>';return;}
  const mi=$('#fMF').value,sf=$('#fSF').value;
  let q=sb.from('forum_posts').select('*,users(nome,login)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(sf==='mine'){q=q.eq('user_id',CU.id);}
  else{
    q=q.eq('aprovado',true);
    if(mi){q=q.eq('modulo_id',mi);}
    else if(CU.turma_id&&mods.length){
      const ids=mods.map(m=>m.id);
      q=q.or('modulo_id.is.null,'+ids.map(id=>'modulo_id.eq.'+id).join(','));
    }
  }
  const{data:posts}=await q.limit(50);
  l.innerHTML='';
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhuma postagem encontrada.</div>';return;}
  for(const p of posts){
    const ini=(p.users?.nome||'?').substring(0,2).toUpperCase();
    const mn=mods.find(m=>m.id===p.modulo_id)?.titulo||'Geral';
    const{data:rps}=await sb.from('forum_replies').select('*,users(nome)').eq('post_id',p.id).eq('aprovado',true).order('criado_em');
    const card=document.createElement('div');card.className='pc'+(p.fixado?' pin':'');
    let rpsHtml='';
    for(const r of(rps||[])){
      const rAv=r.is_admin?'ADM':(r.users?.nome||'?').substring(0,2).toUpperCase();
      const rNome=r.is_admin?'<span style="color:var(--purple)">ğŸ‘¨ Admin</span>':(r.users?.nome||'?');
      rpsHtml+='<div class="ri'+(r.is_admin?' adm-reply':'')+'"><div class="rav'+(r.is_admin?' adm':'')+'">'+rAv+'</div><div><div style="font-weight:700;font-size:.83rem">'+rNome+' <span style="font-weight:400;color:var(--muted)">'+fd(r.criado_em)+'</span></div><div style="font-size:.88rem;color:var(--soft);margin-top:2px">'+r.conteudo+'</div></div></div>';
    }
    card.innerHTML=
      '<div class="phead"><div class="pav">'+ini+'</div><div style="flex:1"><div style="font-weight:800;font-size:.95rem;margin-bottom:2px">'+(p.fixado?'ğŸ“Œ ':'')+p.titulo+'</div>'+
      '<div style="font-size:.78rem;color:var(--muted)">por <strong>'+(p.users?.nome||'?')+'</strong> Â· '+fd(p.criado_em)+' Â· <span class="badge bc" style="font-size:.68rem">'+mn+'</span>'+(!p.aprovado?'<span class="badge ba" style="font-size:.68rem;margin-left:5px">Pendente</span>':'')+'</div></div></div>'+
      '<div class="pbody">'+p.conteudo+'</div>'+
      '<div class="pfooter"><span style="font-size:.82rem;color:var(--muted)">ğŸ’¬ '+(rps||[]).length+'</span>'+
      '<button class="btn bg2 btn-xs tog-rep">Ver respostas</button>'+(p.user_id===CU.id?'<button class="btn bd btn-xs del-post">ğŸ—‘ï¸</button>':'')+'</div>'+
      '<div class="rlist hidden rep-area">'+rpsHtml+
      (p.aprovado?'<div style="padding:9px 14px;border-top:1px solid var(--border)"><textarea class="fi rep-ta" rows="2" placeholder="Sua resposta... (aguarda aprovacao)"></textarea><button class="btn bp btn-sm rep-send" style="margin-top:7px">Responder</button></div>':'')+
      '</div>';
    card.querySelector('.tog-rep').onclick=()=>card.querySelector('.rep-area').classList.toggle('hidden');
    const delBtn=card.querySelector('.del-post');
    if(delBtn)delBtn.onclick=async()=>{if(!confirm('Excluir?'))return;await sb.from('forum_posts').delete().eq('id',p.id);toast('Excluido.','i');renderFL();};
    const sendBtn=card.querySelector('.rep-send');
    if(sendBtn)sendBtn.onclick=async()=>{
      const ta=card.querySelector('.rep-ta'),txt=ta.value.trim();
      if(!txt){toast('Digite sua resposta.','w');return;}
      await sb.from('forum_replies').insert({post_id:p.id,user_id:CU.id,conteudo:txt,aprovado:false,is_admin:false});
      ta.value='';toast('Resposta enviada! Aguarda aprovacao.','i');renderFL();
    };
    l.appendChild(card);
  }
}
function openNP(mid){
  showModal('<div class="mtt">ğŸ’¬ Nova Duvida</div><div class="fg" style="margin-bottom:12px"><label class="fl">Titulo</label><input id="npT" class="fi" placeholder="Ex: Duvida sobre parametros"/></div><div class="fg" style="margin-bottom:14px"><label class="fl">Conteudo</label><textarea id="npC" class="fi" rows="5" placeholder="Descreva sua duvida..."></textarea></div><div style="padding:10px;border:1px solid rgba(245,158,11,.2);border-radius:var(--rs);background:rgba(245,158,11,.05);margin-bottom:14px;font-size:.83rem;color:var(--amber)">â³ Sua postagem sera revisada antes de ser publicada.</div><div style="display:flex;gap:9px"><button id="btnNPS" class="btn bp">ğŸ“¤ Enviar</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>');
  document.getElementById('btnNPS').onclick=()=>subPost(mid||'');
}
$('#bNP').addEventListener('click',()=>openNP(actMod||''));
$('#bNPM').addEventListener('click',()=>openNP(actMod||''));
async function subPost(mid){
  const t=$('#npT').value.trim(),c2=$('#npC').value.trim();
  if(!t||!c2){toast('Preencha tudo.','w');return;}
  await sb.from('forum_posts').insert({modulo_id:mid||null,user_id:CU.id,titulo:t,conteudo:c2,aprovado:false,fixado:false});
  toast('Enviado para aprovacao!','s');closeModal();
  if($('#pg-forum').classList.contains('act'))renderFL();
  if($('#tab-fmod').classList.contains('act'))loadFMod();
}
async function loadFMod(){
  const l=$('#fML');
  if(!actMod){l.innerHTML='<div style="color:var(--muted)">Selecione um modulo.</div>';return;}
  if(!sb)return;
  const{data:posts}=await sb.from('forum_posts').select('*,users(nome)').eq('aprovado',true).or('modulo_id.eq.'+actMod+',modulo_id.is.null').order('criado_em',{ascending:false}).limit(15);
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Sem duvidas. Seja o primeiro!</div>';return;}
  l.innerHTML=posts.map(p=>'<div class="pc"><div class="phead"><div class="pav" style="width:26px;height:26px;font-size:.72rem">'+(p.users?.nome||'?').substring(0,2).toUpperCase()+'</div><div><div style="font-weight:800;font-size:.9rem">'+p.titulo+'</div><div style="font-size:.76rem;color:var(--muted)">'+(p.users?.nome||'?')+' Â· '+fd(p.criado_em)+'</div></div></div><div class="pbody" style="font-size:.87rem">'+p.conteudo+'</div></div>').join('');
}

/* ADMIN */
async function showAdmin(){
  $('#ls').style.display='none';$('#aa').classList.remove('hidden');
  $$('.ani').forEach(i=>i.addEventListener('click',()=>{
    $$('.ani').forEach(x=>x.classList.remove('act'));i.classList.add('act');
    $$('#aa .page').forEach(p=>p.classList.remove('act'));
    const adm=i.dataset.adm;
    document.querySelector(`#adm-${adm}`).classList.add('act');
    const fns={dash:loadADash,pend:loadPend,alunos:loadAAlunos,turmas:loadATurmas,mods:loadAMods,mats:loadAMats,quiz:loadAQuiz,live:loadALive,mural:loadAMural,forum:loadAForum};
    if(fns[adm])fns[adm]();
  }));
  await loadADash();await loadPend();
}
async function loadADash(){
  if(!sb)return;
  const[{data:al},{data:pe},{data:mo}]=await Promise.all([
    sb.from('users').select('*,turmas(nome)').eq('role','student').eq('status','active'),
    sb.from('users').select('id').eq('status','pending'),
    sb.from('modules').select('id')
  ]);
  const alunos=al||[],pc=(pe||[]).length,mc=(mo||[]).length;
  $('#aA').textContent=alunos.length;$('#aP').textContent=pc;$('#aMo').textContent=mc;
  if(pc>0){$('#pBadge').textContent=pc;$('#pBadge').classList.remove('hidden');}else $('#pBadge').classList.add('hidden');
  let tot=0;
  for(const a of alunos){const{data:pr}=await sb.from('progress').select('concluido').eq('user_id',a.id);tot+=pct((pr||[]).filter(x=>x.concluido).length,mc);}
  $('#aMd').textContent=alunos.length?Math.round(tot/alunos.length)+'%':'0%';
  const tb=$('#aDT');tb.innerHTML='';
  for(const a of alunos){
    const{data:pr}=await sb.from('progress').select('concluido').eq('user_id',a.id);
    const dn=(pr||[]).filter(x=>x.concluido).length,p2=pct(dn,mc),d2=du(a.validade_acesso),dc=d2!==null&&d2<=30?'color:var(--amber)':'';
    tb.innerHTML+=`<tr><td><strong>${a.nome}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${a.login}</span></td><td><span class="badge bc">${a.turmas?.nome||'â€”'}</span></td><td><div style="display:flex;align-items:center;gap:7px"><div class="pw" style="width:75px"><div class="pf" style="width:${p2}%"></div></div><span style="font-size:.82rem;font-weight:700">${p2}%</span></div></td><td>${dn}/${mc}</td><td class="${dc}" style="font-size:.85rem">${fd(a.validade_acesso)}</td><td><span class="badge bg3">Ativo</span></td></tr>`;
  }
}
async function loadPend(){
  if(!sb)return;
  const{data}=await sb.from('users').select('*').eq('status','pending').order('criado_em');
  const c2=$('#pendCont');
  if(!data?.length){c2.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">âœ… Nenhuma solicitacao pendente.</div>';return;}
  const{data:turmas}=await sb.from('turmas').select('*').eq('ativa',true);
  const to=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  c2.innerHTML=`<div style="font-weight:800;color:var(--cyan);margin-bottom:13px">ğŸ”” ${data.length} solicitacao(oes)</div>`;
  data.forEach(u=>{
    const d2=document.createElement('div');d2.style.cssText='border:1px solid var(--border);border-radius:var(--r);padding:15px;margin-bottom:11px;background:rgba(0,0,0,.18)';
    d2.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:11px"><div><div style="font-weight:800">${u.nome}</div><div style="font-size:.82rem;color:var(--muted)">${u.email||''} Â· ${u.login}</div></div><div style="font-size:.75rem;color:var(--muted)">${fd(u.criado_em)}</div></div><div style="display:flex;gap:9px;flex-wrap:wrap;align-items:center"><select id="ts-${u.id}" class="fi" style="width:auto;min-width:180px"><option value="">Sem turma</option>${to}</select><input type="number" id="ms-${u.id}" class="fi" value="12" min="1" style="width:95px"/><button class="btn bs" onclick="aprovA('${u.id}')">âœ… Aprovar</button><button class="btn bd" onclick="rejA('${u.id}')">âŒ Rejeitar</button></div>`;
    c2.appendChild(d2);
  });
}
window.aprovA=async function(id){
  const ti=document.getElementById('ts-'+id)?.value||null,ms=parseInt(document.getElementById('ms-'+id)?.value)||12;
  const v=new Date();v.setMonth(v.getMonth()+ms);
  await sb.from('users').update({status:'active',turma_id:ti||null,validade_acesso:v.toISOString(),meses_acesso:ms}).eq('id',id);
  toast('âœ… Aluno aprovado!','s');loadPend();loadADash();
};
window.rejA=async function(id){if(!confirm('Rejeitar?'))return;await sb.from('users').update({status:'blocked'}).eq('id',id);toast('Rejeitado.','i');loadPend();};
async function loadAAlunos(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*');
  const opts=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  $('#aTurma').innerHTML='<option value="">Sem turma</option>'+opts;
  const{data:al}=await sb.from('users').select('*,turmas(nome)').eq('role','student').order('criado_em',{ascending:false});
  $('#aAT').innerHTML=(al||[]).map(a=>{
    const d2=du(a.validade_acesso),sb2={active:'bg3',pending:'ba',expired:'br',blocked:'br'}[a.status]||'bw2';
    return `<tr><td><strong>${a.nome}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${a.login}</span></td><td style="font-size:.85rem">${a.email||''}</td><td>${a.turmas?.nome||'â€”'}</td><td style="font-size:.85rem${d2!==null&&d2<=30?';color:var(--amber)':''}">${fd(a.validade_acesso)}</td><td><span class="badge ${sb2}">${a.status}</span></td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="editA('${a.id}')">âœï¸</button><button class="btn bd btn-xs" onclick="delA('${a.id}')">ğŸ—‘ï¸</button></td></tr>`;
  }).join('');
}
$('#bCA').addEventListener('click',async()=>{
  const n=$('#aNome').value.trim(),e=$('#aEmail').value.trim(),l=$('#aLogin').value.trim(),p=$('#aPass').value.trim(),ti=$('#aTurma').value,ms=parseInt($('#aMes').value)||12;
  if(!n||!e||!l||!p){toast('âš ï¸ Preencha todos os campos.','w');return;}
  if(!sb)return;
  const hash=await sha(p),v=new Date();v.setMonth(v.getMonth()+ms);
  const{error}=await sb.from('users').insert({nome:n,email:e,login:l,senha:hash,role:'student',status:'active',turma_id:ti||null,validade_acesso:v.toISOString(),meses_acesso:ms});
  if(error){toast('âŒ '+error.message,'e');return;}
  toast('âœ… Aluno criado!','s');['aNome','aEmail','aLogin','aPass'].forEach(id=>document.getElementById(id).value='');$('#aMes').value='12';loadAAlunos();
});
window.editA=async function(id){
  if(!sb)return;
  const{data:a}=await sb.from('users').select('*').eq('id',id).single();
  const{data:turmas}=await sb.from('turmas').select('*');
  const opts=(turmas||[]).map(t=>`<option value="${t.id}"${a.turma_id===t.id?' selected':''}>${t.nome}</option>`).join('');
  showModal('<div class="mtt">âœï¸ Editar: '+a.nome+'</div><div class="fg" style="margin-bottom:12px"><label class="fl">Turma</label><select id="eTurma" class="fi"><option value="">Sem turma</option>'+opts+'</select></div><div class="fg" style="margin-bottom:12px"><label class="fl">Status</label><select id="eStatus" class="fi"><option value="active"'+(a.status==='active'?' selected':'')+'>Ativo</option><option value="blocked"'+(a.status==='blocked'?' selected':'')+'>Bloqueado</option></select></div><div class="fg" style="margin-bottom:12px"><label class="fl">Meses de acesso</label><input id="eMes" class="fi" type="number" value="'+(a.meses_acesso||12)+'" min="1"/></div><div class="fg" style="margin-bottom:16px"><label class="fl">Nova senha (vazio = nao altera)</label><input id="ePass" class="fi" type="password" placeholder="Nova senha..."/></div><div style="display:flex;gap:9px"><button class="btn bp" onclick="saveA(\''+id+'\')">ğŸ’¾ Salvar</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>');
};
window.saveA=async function(id){
  const ti=$('#eTurma').value,st=$('#eStatus').value,ms=parseInt($('#eMes').value)||12,np=$('#ePass').value.trim();
  const v=new Date();v.setMonth(v.getMonth()+ms);
  const pay={turma_id:ti||null,status:st,validade_acesso:v.toISOString(),meses_acesso:ms};
  if(np&&np.length>=6)pay.senha=await sha(np);
  await sb.from('users').update(pay).eq('id',id);
  toast('âœ… Atualizado!','s');closeModal();loadAAlunos();loadADash();
};
window.delA=async function(id){
  if(!confirm('Remover aluno?'))return;
  await Promise.all([sb.from('progress').delete().eq('user_id',id),sb.from('notes').delete().eq('user_id',id)]);
  await sb.from('users').delete().eq('id',id);toast('ğŸ—‘ï¸ Removido.','i');loadAAlunos();loadADash();
};
async function loadATurmas(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*').order('criado_em');
  const tb=$('#aTT');tb.innerHTML='';
  for(const t of turmas||[]){
    const[{data:al},{data:mo}]=await Promise.all([sb.from('users').select('id').eq('turma_id',t.id).eq('status','active'),sb.from('modules').select('id').eq('turma_id',t.id)]);
    tb.innerHTML+=`<tr><td><strong>${t.nome}</strong><br/><span style="font-size:.78rem;color:var(--muted)">${t.descricao||''}</span></td><td>${(al||[]).length}</td><td>${(mo||[]).length}</td><td><span class="badge ${t.ativa?'bg3':'bw2'}">${t.ativa?'Ativa':'Inativa'}</span></td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="togT('${t.id}',${!t.ativa})">${t.ativa?'â¸ï¸':'â–¶ï¸'}</button><button class="btn bd btn-xs" onclick="delT('${t.id}')">ğŸ—‘ï¸</button></td></tr>`;
  }
}
$('#bST').addEventListener('click',async()=>{
  const n=$('#tNome').value.trim(),d=$('#tDesc').value.trim();
  if(!n){toast('âš ï¸ Nome obrigatorio.','w');return;}
  if(!sb)return;
  await sb.from('turmas').insert({nome:n,descricao:d,ativa:true});
  toast('âœ… Turma criada!','s');$('#tNome').value='';$('#tDesc').value='';loadATurmas();loadTurmaSelects();
});
window.togT=async function(id,a){await sb.from('turmas').update({ativa:a}).eq('id',id);loadATurmas();};
window.delT=async function(id){if(!confirm('Excluir turma?'))return;await sb.from('turmas').delete().eq('id',id);loadATurmas();};
async function loadTurmaSelects(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*').eq('ativa',true);
  const opts=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  ['mTur','aTurma','lvTurma','cdTurma','mrTurma'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const pre=id==='aTurma'?'<option value="">Sem turma</option>':id==='mrTurma'?'<option value="">Todas as turmas</option>':'<option value="">Selecione...</option>';
    el.innerHTML=pre+opts;
  });
}
async function loadAMods(){
  if(!sb)return;await loadTurmaSelects();
  const{data:mds}=await sb.from('modules').select('*,turmas(nome)').order('ordem');
  $('#aMT2').innerHTML=(mds||[]).map(m=>`<tr><td>${m.ordem}</td><td><strong>${m.icone} ${m.titulo}</strong></td><td><span class="badge bc">${m.turmas?.nome||'â€”'}</span></td><td><span class="badge bpp">${m.video_type}</span></td><td>${Math.round((m.duracao_seg||0)/60)}min</td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="editM('${m.id}')">âœï¸</button><button class="btn bd btn-xs" onclick="delM('${m.id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
}
$('#bSM').addEventListener('click',async()=>{
  const tt=$('#mTit').value.trim(),ic=$('#mIco').value.trim()||'ğŸ“–',tu=$('#mTur').value,vt=$('#mVT').value,vu=$('#mVU').value.trim(),dur=(parseInt($('#mDur').value)||10)*60,ord=parseInt($('#mOrd').value)||1,top=$('#mTop').value.trim(),eid=$('#mEId').value;
  if(!tt||!tu){toast('âš ï¸ Titulo e turma obrigatorios.','w');return;}
  if(!sb)return;
  if(eid){await sb.from('modules').update({titulo:tt,icone:ic,turma_id:tu,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true}).eq('id',eid);toast('âœ… Modulo atualizado!','s');}
  else{await sb.from('modules').insert({titulo:tt,icone:ic,turma_id:tu,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true});toast('âœ… Modulo criado!','s');}
  clearMF();loadAMods();loadAMats();loadAQuiz();
});
$('#bCM').addEventListener('click',clearMF);
function clearMF(){['mTit','mIco','mVU','mDur','mOrd','mTop','mEId'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});$('#mVT').value='youtube';}
window.editM=async function(id){
  const{data:m}=await sb.from('modules').select('*').eq('id',id).single();
  $('#mTit').value=m.titulo;$('#mIco').value=m.icone||'ğŸ“–';$('#mTur').value=m.turma_id||'';$('#mVT').value=m.video_type||'youtube';
  $('#mVU').value=m.video_url||'';$('#mDur').value=Math.round((m.duracao_seg||600)/60);$('#mOrd').value=m.ordem||1;$('#mTop').value=m.topicos||'';$('#mEId').value=m.id;
  toast('ğŸ“ Editando: '+m.titulo,'i');
};
window.delM=async function(id){if(!confirm('Excluir modulo?'))return;await sb.from('modules').delete().eq('id',id);toast('ğŸ—‘ï¸ Excluido.','i');loadAMods();};
async function loadAMats(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone');
  const opts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  $('#matM').innerHTML='<option value="">Todos os modulos</option>'+opts;
  const{data:mats}=await sb.from('materials').select('*,modules(titulo)').order('criado_em',{ascending:false});
  $('#aMatT').innerHTML=(mats||[]).map(m=>`<tr><td><strong>${ti(m.tipo)} ${m.nome}</strong><br/><span style="font-size:.78rem;color:var(--muted)">${m.descricao||''}</span></td><td><span class="badge bc">${m.tipo}</span></td><td>${m.modules?.titulo||'Todos'}</td><td><a href="${m.url}" target="_blank" style="color:var(--cyan);font-size:.78rem;word-break:break-all">${m.url.substring(0,40)}</a></td><td><button class="btn bd btn-xs" onclick="delMat('${m.id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
}
$('#bSMat').addEventListener('click',async()=>{
  const n=$('#matN').value.trim(),t2=$('#matT').value,u=$('#matU').value.trim(),d=$('#matD').value.trim(),m=$('#matM').value;
  if(!n||!u){toast('âš ï¸ Nome e URL obrigatorios.','w');return;}
  if(!sb)return;
  await sb.from('materials').insert({nome:n,tipo:t2,url:u,descricao:d,modulo_id:m||null});
  toast('âœ… Material adicionado!','s');['matN','matU','matD'].forEach(id=>document.getElementById(id).value='');$('#matM').value='';loadAMats();
});
window.delMat=async function(id){if(!confirm('Remover?'))return;await sb.from('materials').delete().eq('id',id);toast('ğŸ—‘ï¸ Removido.','i');loadAMats();};
async function loadAQuiz(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone');
  const opts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  $('#qMod').innerHTML='<option value="">Geral</option>'+opts;
  const{data:qs}=await sb.from('quiz').select('*,modules(titulo)').order('criado_em',{ascending:false});
  const l=$('#aQL');
  if(!qs?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma questao.</div>';return;}
  l.innerHTML=qs.map((q,i)=>`<div style="border:1px solid var(--border);border-radius:var(--r);padding:15px;background:rgba(0,0,0,.18);margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:11px"><div style="font-weight:800">${i+1}. ${q.question}</div><button class="btn bd btn-xs" onclick="delQ('${q.id}')">ğŸ—‘ï¸</button></div><div style="display:flex;flex-direction:column;gap:5px">${(q.options||[]).map((opt,oi)=>`<div style="padding:7px 11px;border-radius:6px;font-size:.88rem;border:1px solid ${oi===q.correct_option?'var(--green)':'var(--border)'};background:${oi===q.correct_option?'rgba(15,186,129,.1)':'rgba(0,0,0,.18)'}">${String.fromCharCode(65+oi)}) ${opt}${oi===q.correct_option?' âœ“':''}</div>`).join('')}</div><div style="font-size:.75rem;color:var(--muted);margin-top:8px">Modulo: ${q.modules?.titulo||'Geral'}</div></div>`).join('');
}
$('#bSQ').addEventListener('click',async()=>{
  const q=$('#qEn').value.trim(),o0=$('#qO0').value.trim(),o1=$('#qO1').value.trim(),o2=$('#qO2').value.trim(),cs=document.querySelector('input[name="qC"]:checked'),m=$('#qMod').value;
  if(!q||!o0||!o1||!o2){toast('âš ï¸ Preencha enunciado e 3 opcoes.','w');return;}
  if(!cs){toast('âš ï¸ Marque a opcao correta.','w');return;}
  if(!sb)return;
  await sb.from('quiz').insert({question:q,options:[o0,o1,o2],correct_option:parseInt(cs.value),modulo_id:m||null});
  toast('âœ… Questao adicionada!','s');['qEn','qO0','qO1','qO2'].forEach(id=>document.getElementById(id).value='');document.querySelectorAll('input[name="qC"]').forEach(r=>r.checked=false);loadAQuiz();
});
window.delQ=async function(id){if(!confirm('Excluir?'))return;await sb.from('quiz').delete().eq('id',id);loadAQuiz();};

/* ADMIN LIVE */
async function loadALive(){
  if(!sb)return;await loadTurmaSelects();
  const{data:rows}=await sb.from('aulas_ao_vivo').select('*,turmas(nome)').order('criado_em',{ascending:false});
  const tb=$('#lvTable');
  if(!rows?.length){tb.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma configuracao ainda.</div>';return;}
  tb.innerHTML='<div class="tw2"><table><thead><tr><th>Turma</th><th>Tipo</th><th>Titulo</th><th>Status</th><th></th></tr></thead><tbody>'+rows.map(r=>`<tr><td><span class="badge bc">${r.turmas?.nome||'â€”'}</span></td><td><span class="badge ${r.tipo==='live'?'br':'bpp'}">${r.tipo==='live'?'Ao vivo':'Contador'}</span></td><td style="font-size:.85rem">${r.titulo||'â€”'}</td><td><span class="badge ${r.ativa?'bg3':'bw2'}">${r.ativa?'Ativo':'Inativo'}</span></td><td style="display:flex;gap:5px"><button class="btn bg2 btn-xs" onclick="togLV('${r.id}',${!r.ativa})">${r.ativa?'Pausar':'Ativar'}</button><button class="btn bd btn-xs" onclick="delLV('${r.id}')">ğŸ—‘ï¸</button></td></tr>`).join('')+'</tbody></table></div>';
}
$('#bSLV').addEventListener('click',async()=>{
  const tu=$('#lvTurma').value,tt=$('#lvTit').value.trim(),lk=$('#lvLink').value.trim(),ds=$('#lvDesc').value.trim(),at=parseInt($('#lvStatus').value);
  if(!tu||!tt||!lk){toast('âš ï¸ Turma, titulo e link obrigatorios.','w');return;}
  if(!sb)return;
  await sb.from('aulas_ao_vivo').upsert({turma_id:tu,tipo:'live',titulo:tt,link:lk,descricao:ds,ativa:at===1,atualizado_em:new Date().toISOString()},{onConflict:'turma_id,tipo'});
  toast('âœ… Configuracao salva!','s');loadALive();
});
$('#bSCD').addEventListener('click',async()=>{
  const tu=$('#cdTurma').value,tt=$('#cdTit').value.trim(),dh=$('#cdDH').value,at=parseInt($('#cdAtivo').value);
  if(!tu||!tt||!dh){toast('âš ï¸ Preencha turma, titulo e data/hora.','w');return;}
  if(!sb)return;
  await sb.from('aulas_ao_vivo').upsert({turma_id:tu,tipo:'countdown',titulo:tt,data_hora:new Date(dh).toISOString(),ativa:at===1,atualizado_em:new Date().toISOString()},{onConflict:'turma_id,tipo'});
  toast('âœ… Contador salvo!','s');loadALive();
});
window.togLV=async function(id,a){await sb.from('aulas_ao_vivo').update({ativa:a}).eq('id',id);loadALive();};
window.delLV=async function(id){if(!confirm('Excluir?'))return;await sb.from('aulas_ao_vivo').delete().eq('id',id);loadALive();};

/* ADMIN MURAL */
async function loadAMural(){
  if(!sb)return;await loadTurmaSelects();
  const{data}=await sb.from('mural_avisos').select('*,turmas(nome)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  const l=$('#aMuralList');
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhum aviso publicado.</div>';return;}
  l.innerHTML=data.map(av=>
    '<div style="border:1px solid '+(av.fixado?'rgba(245,158,11,.4)':'var(--border)')+';border-radius:var(--r);padding:14px;margin-bottom:10px;background:rgba(0,0,0,.18)">'+
    '<div style="display:flex;align-items:start;justify-content:space-between;gap:10px;margin-bottom:7px">'+
    '<div><div style="font-weight:800">'+(av.fixado?'ğŸ“Œ ':'')+av.titulo+'</div>'+
    '<div style="font-size:.78rem;color:var(--muted);margin-top:2px">'+(av.turmas?.nome||'Todas as turmas')+' Â· '+fdt(av.criado_em)+'</div></div>'+
    '<div style="display:flex;gap:5px;flex-shrink:0"><button class="btn bg2 btn-xs" onclick="togMR(\''+av.id+'\','+!av.fixado+')">'+(av.fixado?'Desafixar':'Fixar')+'</button><button class="btn bd btn-xs" onclick="delMR(\''+av.id+'\')">ğŸ—‘ï¸</button></div></div>'+
    '<div style="font-size:.88rem;color:var(--soft);line-height:1.5">'+av.conteudo+'</div></div>'
  ).join('');
}
$('#bSMR').addEventListener('click',async()=>{
  const tu=$('#mrTurma').value,ti2=$('#mrTit').value.trim(),co=$('#mrCont').value.trim(),fi=parseInt($('#mrFix').value);
  if(!ti2||!co){toast('âš ï¸ Titulo e conteudo obrigatorios.','w');return;}
  if(!sb)return;
  await sb.from('mural_avisos').insert({turma_id:tu||null,titulo:ti2,conteudo:co,fixado:fi===1,ativo:true});
  toast('âœ… Aviso publicado!','s');['mrTit','mrCont'].forEach(id=>document.getElementById(id).value='');$('#mrFix').value='0';loadAMural();
});
window.togMR=async function(id,f){await sb.from('mural_avisos').update({fixado:f}).eq('id',id);loadAMural();};
window.delMR=async function(id){if(!confirm('Excluir aviso?'))return;await sb.from('mural_avisos').delete().eq('id',id);loadAMural();};

/* ADMIN FORUM */
async function loadAForum(){
  if(!sb)return;
  const f=$('#aFF').value;
  let q=sb.from('forum_posts').select('*,users(nome,login),modules(titulo)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(f==='pending')q=q.eq('aprovado',false);else if(f==='approved')q=q.eq('aprovado',true);
  const{data:posts}=await q.limit(100);
  const l=$('#aFL');l.innerHTML='';
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum post encontrado.</div>';return;}
  for(const p of posts){
    const ini=(p.users?.nome||'?').substring(0,2).toUpperCase();
    const{data:rps}=await sb.from('forum_replies').select('*,users(nome)').eq('post_id',p.id).order('criado_em');
    const pendReps=(rps||[]).filter(r=>!r.aprovado&&!r.is_admin).length;
    let rpsHtml='';
    for(const r of(rps||[])){
      const rAv=r.is_admin?'ADM':(r.users?.nome||'?').substring(0,2).toUpperCase();
      const rNome=r.is_admin?'<span style="color:var(--purple)">ğŸ‘¨ Admin</span>':(r.users?.nome||'?');
      rpsHtml+=
        '<div class="ri'+(r.is_admin?' adm-reply':!r.aprovado?' pending-reply':'')+'" data-rid="'+r.id+'">'+
        '<div class="rav'+(r.is_admin?' adm':'')+'">'+rAv+'</div>'+
        '<div style="flex:1"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px">'+
        '<div style="font-weight:700;font-size:.82rem">'+rNome+' <span style="font-weight:400;color:var(--muted)">'+fd(r.criado_em)+'</span>'+
        (!r.aprovado&&!r.is_admin?'<span class="badge ba" style="font-size:.66rem;margin-left:4px">Pendente</span>':'')+
        '</div><div style="display:flex;gap:4px">'+
        (!r.aprovado&&!r.is_admin?'<button class="btn bs btn-xs aprv-rep">âœ… Aprovar</button>':'')+
        '<button class="btn bd btn-xs del-rep">ğŸ—‘ï¸</button></div></div>'+
        '<div style="font-size:.87rem;color:var(--soft);margin-top:3px">'+r.conteudo+'</div></div></div>';
    }
    const card=document.createElement('div');card.className='pc'+(p.fixado?' pin':'');
    card.innerHTML=
      '<div class="phead"><div class="pav" style="width:30px;height:30px;font-size:.75rem">'+ini+'</div>'+
      '<div style="flex:1"><div style="font-weight:800;font-size:.93rem">'+(p.fixado?'ğŸ“Œ ':'')+p.titulo+'</div>'+
      '<div style="font-size:.76rem;color:var(--muted)">'+(p.users?.nome||'?')+' Â· '+(p.modules?.titulo||'Geral')+' Â· '+fd(p.criado_em)+
      (!p.aprovado?'<span class="badge ba" style="font-size:.68rem;margin-left:4px">Post pendente</span>':'')+
      (pendReps>0?'<span class="badge ba" style="font-size:.68rem;margin-left:4px">'+pendReps+' resp. pendente(s)</span>':'')+
      '</div></div>'+
      '<div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">'+
      (!p.aprovado?'<button class="btn bs btn-xs aprv-post">âœ… Aprovar</button>':'')+
      '<button class="btn bg2 btn-xs pin-post">'+(p.fixado?'Desafixar':'ğŸ“Œ Fixar')+'</button>'+
      '<button class="btn bd btn-xs del-post">ğŸ—‘ï¸</button></div></div>'+
      '<div class="pbody" style="font-size:.87rem;border-bottom:1px solid var(--border);padding-bottom:12px">'+p.conteudo+'</div>'+
      '<div style="padding:11px 15px">'+
      '<div style="font-size:.78rem;font-weight:800;color:var(--soft);margin-bottom:8px">ğŸ’¬ Respostas ('+((rps||[]).length)+')</div>'+
      '<div class="rep-con">'+rpsHtml+'</div>'+
      '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">'+
      '<div style="font-size:.75rem;font-weight:800;color:var(--purple);margin-bottom:6px">ğŸ‘¨ Responder como Admin</div>'+
      '<textarea class="fi adm-ta" rows="2" placeholder="Digite sua resposta (publicada imediatamente)..."></textarea>'+
      '<button class="btn bp btn-sm adm-rep" style="margin-top:7px">ğŸ“¤ Enviar resposta</button></div></div>';
    (function(post,cardEl,replies){
      const ap=cardEl.querySelector('.aprv-post');
      if(ap)ap.onclick=async()=>{await sb.from('forum_posts').update({aprovado:true}).eq('id',post.id);toast('âœ… Post aprovado!','s');loadAForum();};
      cardEl.querySelector('.pin-post').onclick=async()=>{await sb.from('forum_posts').update({fixado:!post.fixado}).eq('id',post.id);loadAForum();};
      cardEl.querySelector('.del-post').onclick=async()=>{if(!confirm('Excluir post e respostas?'))return;await sb.from('forum_replies').delete().eq('post_id',post.id);await sb.from('forum_posts').delete().eq('id',post.id);toast('ğŸ—‘ï¸ Excluido.','i');loadAForum();};
      replies.forEach(r=>{
        const rd=cardEl.querySelector('[data-rid="'+r.id+'"]');if(!rd)return;
        const ab=rd.querySelector('.aprv-rep');if(ab)ab.onclick=async()=>{await sb.from('forum_replies').update({aprovado:true}).eq('id',r.id);toast('âœ… Aprovado!','s');loadAForum();};
        const db=rd.querySelector('.del-rep');if(db)db.onclick=async()=>{if(!confirm('Excluir?'))return;await sb.from('forum_replies').delete().eq('id',r.id);loadAForum();};
      });
      cardEl.querySelector('.adm-rep').onclick=async()=>{
        const ta=cardEl.querySelector('.adm-ta'),txt=ta.value.trim();
        if(!txt){toast('âš ï¸ Digite uma resposta.','w');return;}
        const res=await sb.from('forum_replies').insert({post_id:post.id,user_id:CU.id,conteudo:txt,aprovado:true,is_admin:true});
        if(res.error){toast('âŒ Erro: '+res.error.message,'e');return;}
        ta.value='';toast('âœ… Resposta publicada!','s');loadAForum();
      };
    })(p,card,rps||[]);
    l.appendChild(card);
  }
}
$('#aFF').addEventListener('change',loadAForum);
$('#bRF').addEventListener('click',loadAForum);
</script>
</body>
</html>