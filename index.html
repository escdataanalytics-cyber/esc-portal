<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESC ‚Ä¢ Plataforma de Ensino</title>
<script>
  const SUPABASE_URL = 'https://zycxnizgauollnafyotk.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Y3huaXpnYXVvbGxuYWZ5b3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDM4MjIsImV4cCI6MjA4NzExOTgyMn0.t7YJAOoJ3qbthikkwBDIL5nyp-wBEJFkkPbZMrRFcRM';
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='14' fill='%23080b10'/><rect width='64' height='64' rx='14' fill='url(%23g)' opacity='.9'/><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300c8ff' stop-opacity='.25'/><stop offset='1' stop-color='%237c5cfc' stop-opacity='.25'/></linearGradient></defs><rect x='3' y='3' width='58' height='58' rx='12' fill='none' stroke='%2300c8ff' stroke-width='1.5' stroke-opacity='.5'/><text x='32' y='42' font-family='Arial Black,sans-serif' font-weight='900' font-size='22' fill='%2300c8ff' text-anchor='middle' letter-spacing='-1'>ESC</text></svg>"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
:root{
  --black:#080b10;--dark:#0f1318;--surface:#161c24;--surface2:#1e2630;
  --border:rgba(0,200,255,.14);--border-hi:rgba(0,200,255,.38);
  --cyan:#00c8ff;--purple:#7c5cfc;--green:#0fba81;--amber:#f59e0b;--red:#ef4444;
  --text:#ddeeff;--muted:#6b8fa8;--soft:#9ab8cc;
  --fd:'Orbitron',monospace;--fb:'Rajdhani',system-ui;--fm:'JetBrains Mono',monospace;
  --r:12px;--rs:8px;
}
body{font-family:var(--fb);color:var(--text);background:var(--black);min-height:100vh;
  background-image:radial-gradient(ellipse 80% 50% at 20% -10%,rgba(0,200,255,.06),transparent 60%),
  radial-gradient(ellipse 60% 40% at 90% 10%,rgba(124,92,252,.06),transparent 50%);}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:rgba(0,0,0,.15)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
.hidden{display:none!important}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r)}
.cp{padding:20px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 17px;border-radius:999px;border:none;cursor:pointer;font-family:var(--fb);font-weight:700;font-size:.92rem;transition:all .22s;white-space:nowrap}
.bp{background:linear-gradient(135deg,var(--cyan),var(--purple));color:#050d14;box-shadow:0 6px 20px rgba(0,200,255,.18)}
.bp:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,200,255,.32)}
.bp:disabled{opacity:.4;cursor:not-allowed;transform:none}
.bo{background:transparent;border:1px solid var(--border-hi);color:var(--cyan)}
.bo:hover{background:rgba(0,200,255,.08)}
.bg2{background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--soft)}
.bg2:hover{background:rgba(255,255,255,.08);color:var(--text)}
.bd{background:rgba(239,68,68,.1);border:1px solid var(--red);color:var(--red);border-radius:var(--rs);padding:5px 11px;font-size:.82rem}
.bd:hover{background:rgba(239,68,68,.2)}
.bs{background:rgba(15,186,129,.1);border:1px solid var(--green);color:var(--green);border-radius:var(--rs);padding:5px 11px;font-size:.82rem}
.bs:hover{background:rgba(15,186,129,.2)}
.blv{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;box-shadow:0 6px 24px rgba(239,68,68,.4);animation:livePulse 2s ease-in-out infinite}
.blv:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(239,68,68,.6)}
@keyframes livePulse{0%,100%{box-shadow:0 6px 24px rgba(239,68,68,.4)}50%{box-shadow:0 6px 32px rgba(239,68,68,.7),0 0 0 6px rgba(239,68,68,.1)}}
.livedot{width:8px;height:8px;background:#fff;border-radius:50%;animation:dotBlink 1s ease-in-out infinite}
@keyframes dotBlink{0%,100%{opacity:1}50%{opacity:.3}}
.btn-sm{padding:6px 13px;font-size:.85rem}.btn-xs{padding:4px 9px;font-size:.78rem}
.fg{display:flex;flex-direction:column;gap:5px}
.fl{font-size:.78rem;font-weight:700;color:var(--soft);letter-spacing:.5px;text-transform:uppercase}
.fi{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--rs);padding:10px 13px;color:var(--text);font-family:var(--fb);font-size:.95rem;outline:none;transition:border .22s;width:100%}
.fi:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,200,255,.1)}
.fi::placeholder{color:var(--muted)}
select.fi{cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2300c8ff' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:34px}
textarea.fi{resize:vertical}
select.fi option{background:#0f1318;color:#ddeeff;padding:8px}
select.fi option:hover,select.fi option:checked{background:#1a2535;color:#00c8ff}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.fgrid .full{grid-column:1/-1}
.ferr{font-size:.82rem;color:var(--red);font-weight:700}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:999px;font-size:.74rem;font-weight:700}
.bc{background:rgba(0,200,255,.1);color:var(--cyan);border:1px solid rgba(0,200,255,.25)}
.bg3{background:rgba(15,186,129,.1);color:var(--green);border:1px solid rgba(15,186,129,.25)}
.ba{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.25)}
.br{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.bpp{background:rgba(124,92,252,.1);color:var(--purple);border:1px solid rgba(124,92,252,.25)}
.bw2{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--border)}
.pw{height:6px;background:rgba(0,0,0,.35);border-radius:999px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:999px;transition:width .5s}
.pw.lg{height:10px}
#tc{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:7px;max-width:340px}
.toast{padding:11px 16px;border:1px solid var(--border);background:rgba(12,16,22,.97);border-radius:var(--r);font-weight:700;font-size:.9rem;animation:tIn .3s ease}
.ts{border-color:var(--green);color:var(--green)}.te{border-color:var(--red);color:var(--red)}
.ti{border-color:var(--cyan);color:var(--cyan)}.tw{border-color:var(--amber);color:var(--amber)}
@keyframes tIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fi .2s}
.modal{background:var(--surface);border:1px solid var(--border-hi);border-radius:16px;padding:26px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,.6);animation:mi .28s ease}
.mtt{font-family:var(--fd);font-size:1.05rem;color:var(--cyan);margin-bottom:18px}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes mi{from{opacity:0;transform:translateY(-18px)}to{opacity:1;transform:translateY(0)}}
.hdr{position:sticky;top:0;z-index:100;display:flex;align-items:center;gap:14px;padding:0 20px;height:58px;background:rgba(8,11,16,.93);border-bottom:1px solid var(--border);backdrop-filter:blur(12px)}
.brand{display:flex;align-items:center;gap:10px}
.blog{width:34px;height:34px;border-radius:9px;display:grid;place-items:center;background:linear-gradient(135deg,rgba(0,200,255,.15),rgba(124,92,252,.15));border:1px solid rgba(0,200,255,.3);font-family:var(--fd);font-weight:900;font-size:.72rem;color:#bff6ff}
.bname{font-family:var(--fd);font-size:.9rem;font-weight:700;color:#bff6ff}
.bsub{font-size:.75rem;color:var(--muted)}
.hright{margin-left:auto;display:flex;align-items:center;gap:9px}
.uchip{display:flex;align-items:center;gap:7px;padding:4px 11px 4px 5px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.28)}
.uav{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-size:.78rem;font-weight:900;color:#050d14;background:linear-gradient(135deg,var(--cyan),var(--purple));flex-shrink:0}
.uname{font-size:.86rem;font-weight:700}
.expw{display:flex;align-items:center;gap:5px;padding:5px 11px;border:1px solid var(--amber);border-radius:999px;background:rgba(245,158,11,.07);color:var(--amber);font-size:.8rem;font-weight:700;animation:wp 3s ease-in-out infinite}
@keyframes wp{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,.2)}50%{box-shadow:0 0 0 5px rgba(245,158,11,0)}}
.l2{display:grid;grid-template-columns:255px 1fr;min-height:calc(100vh - 58px)}
.sbar{border-right:1px solid var(--border);padding:14px;overflow-y:auto;max-height:calc(100vh - 58px);background:rgba(0,0,0,.1)}
.nsect{font-size:.7rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;padding:3px 7px;margin:14px 0 5px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 11px;border-radius:var(--rs);color:var(--soft);font-weight:600;cursor:pointer;transition:all .18s;margin-bottom:2px;border:1px solid transparent;font-size:.9rem}
.ni:hover{color:var(--text);background:rgba(255,255,255,.04)}
.ni.act{color:var(--cyan);background:rgba(0,200,255,.07);border-color:rgba(0,200,255,.18)}
.nic{font-size:.95rem;width:19px;text-align:center;flex-shrink:0}
/* ‚îÄ‚îÄ NOTIFICATION BELL ‚îÄ‚îÄ */
.nbell{position:relative;display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:rgba(0,0,0,.25);cursor:pointer;transition:all .2s;flex-shrink:0}
.nbell:hover{border-color:var(--cyan);background:rgba(0,200,255,.08)}
.nbell svg{width:17px;height:17px;stroke:var(--soft);transition:stroke .2s}
.nbell:hover svg{stroke:var(--cyan)}
.nbell-dot{position:absolute;top:4px;right:4px;background:var(--red);border-radius:50%;width:8px;height:8px;border:2px solid var(--black);display:none}
.nbell-dot.show{display:block;animation:pulse 1.8s ease infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}}
.nbell-count{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;border-radius:999px;font-size:.58rem;font-weight:900;padding:1px 5px;min-width:16px;text-align:center;border:1.5px solid var(--black);display:none}
.nbell-count.show{display:block}
/* Notification dropdown */
.ndrop{position:absolute;top:calc(100% + 10px);right:-10px;width:340px;background:var(--surface);border:1px solid var(--border-hi);border-radius:var(--r);box-shadow:0 20px 60px rgba(0,0,0,.6);z-index:1000;display:none;max-height:420px;overflow-y:auto}
.ndrop.open{display:block;animation:fadeDown .18s ease}
@keyframes fadeDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.ndrop-hdr{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:800;font-size:.88rem;color:var(--cyan);display:flex;align-items:center;justify-content:space-between}
.ndrop-item{padding:11px 14px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .15s;display:flex;gap:10px;align-items:flex-start}
.ndrop-item:hover{background:rgba(255,255,255,.04)}
.ndrop-item.unread{background:rgba(0,200,255,.04)}
.ndrop-ic{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;font-size:1rem;flex-shrink:0}
.ndrop-body{flex:1;min-width:0}
.ndrop-title{font-size:.83rem;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ndrop-sub{font-size:.75rem;color:var(--muted);line-height:1.4}
.ndrop-empty{padding:28px 14px;text-align:center;color:var(--muted);font-size:.85rem}
.nbell-wrap{position:relative}
.nbadge{background:var(--red);color:#fff;border-radius:999px;font-size:.66rem;font-weight:900;padding:2px 5px;margin-left:auto}
.mcont{overflow-y:auto;max-height:calc(100vh - 58px);padding:22px}
.ladm{display:grid;grid-template-columns:215px 1fr;min-height:calc(100vh - 58px)}
.abar{border-right:1px solid var(--border);padding:14px;background:rgba(0,0,0,.18)}
.ani{display:flex;align-items:center;gap:9px;padding:10px 13px;border-radius:var(--rs);color:var(--muted);font-weight:700;cursor:pointer;transition:all .18s;margin-bottom:3px;border:1px solid transparent;font-size:.9rem}
.ani:hover{color:var(--text);background:rgba(255,255,255,.04)}
.ani.act{color:#c9f2ff;border-color:rgba(0,200,255,.25);background:rgba(0,200,255,.07)}
.page{display:none}.page.act{display:block;animation:fi .28s}
.tw2{overflow-x:auto;border-radius:var(--r);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
thead tr{background:rgba(0,200,255,.03)}
th{padding:10px 13px;text-align:left;font-size:.75rem;font-weight:800;color:var(--soft);letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border)}
td{padding:10px 13px;border-bottom:1px solid rgba(255,255,255,.04);font-size:.9rem;vertical-align:middle}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(255,255,255,.02)}
.sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:12px}
.sc{padding:17px;border:1px solid var(--border);border-radius:var(--r);background:rgba(0,0,0,.18);transition:all .28s}
.sc:hover{border-color:var(--border-hi);transform:translateY(-2px)}
.sval{font-size:1.7rem;font-weight:900;line-height:1;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.slbl{font-size:.78rem;color:var(--muted);margin-top:5px}
.trail{display:flex;flex-direction:column}
.tri{display:flex;gap:15px;padding:15px 0;position:relative}
.tri:not(:last-child)::after{content:'';position:absolute;left:18px;top:48px;bottom:-5px;width:2px;background:linear-gradient(180deg,var(--border-hi),var(--border))}
.tdot{width:38px;height:38px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-size:1rem;border:2px solid var(--border);background:var(--surface2);position:relative;z-index:1;transition:all .28s}
.tdot.done{border-color:var(--green);background:rgba(15,186,129,.12);box-shadow:0 0 14px rgba(15,186,129,.25)}
.tdot.cur{border-color:var(--cyan);background:rgba(0,200,255,.12);box-shadow:0 0 14px rgba(0,200,255,.25)}
.tdot.lock{opacity:.4}
.cgrid{display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
.plwr{border-radius:14px 14px 0 0;overflow:hidden;background:#000;aspect-ratio:16/9;position:relative}
.vif{width:100%;height:100%;border:none;display:block}
.pov{position:absolute;top:11px;left:11px;display:flex;gap:7px;z-index:5}
.ptag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.13);background:rgba(0,0,0,.72);backdrop-filter:blur(8px);font-size:.8rem;font-weight:700;color:#c9f2ff}
.tbar{display:flex;gap:5px;padding:11px;border-top:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap}
.tb{padding:7px 13px;border-radius:var(--rs);border:1px solid var(--border);background:rgba(0,0,0,.22);color:var(--soft);font-weight:700;cursor:pointer;white-space:nowrap;transition:all .18s;font-family:var(--fb);font-size:.86rem}
.tb:hover{color:var(--text);border-color:var(--border-hi)}
.tb.act{background:rgba(0,200,255,.1);border-color:var(--cyan);color:var(--cyan)}
.tp{display:none;padding:17px;min-height:240px}.tp.act{display:block;animation:fi .28s}
.pc{border:1px solid var(--border);border-radius:var(--r);background:rgba(0,0,0,.18);margin-bottom:11px;overflow:hidden;transition:border .18s}
.pc:hover{border-color:var(--border-hi)}.pc.pin{border-color:rgba(245,158,11,.28)}
.phead{padding:13px 15px;display:flex;align-items:flex-start;gap:11px}
.pav{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-weight:900;font-size:.82rem;color:#050d14;background:linear-gradient(135deg,var(--cyan),var(--purple))}
.pbody{padding:0 15px 12px;color:var(--soft);font-size:.9rem;line-height:1.55}
.pfooter{padding:9px 15px;border-top:1px solid var(--border);display:flex;gap:7px;align-items:center}
.rlist{background:rgba(0,0,0,.18);border-top:1px solid var(--border)}
.ri{padding:11px 15px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:9px}
.ri:last-child{border-bottom:none}
.rav{width:24px;height:24px;border-radius:50%;flex-shrink:0;display:grid;place-items:center;font-size:.65rem;font-weight:900;color:#050d14;background:linear-gradient(135deg,var(--purple),var(--cyan))}
.rav.adm{background:linear-gradient(135deg,var(--red),var(--purple));width:28px;height:28px;font-size:.7rem}
.ri.adm-reply{background:rgba(124,92,252,.05);border-left:3px solid var(--purple)}
.ri.pending-reply{background:rgba(245,158,11,.04);border-left:3px solid rgba(245,158,11,.4);opacity:.75}
.nta{width:100%;min-height:170px;background:rgba(0,0,0,.28);border:1px solid var(--border);border-radius:var(--rs);padding:12px;color:var(--text);font-family:var(--fb);font-size:.93rem;resize:vertical;outline:none;transition:border .22s}
.nta:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,200,255,.09)}
/* LIVE CARD */
.livecard{border:2px solid var(--red);border-radius:16px;padding:22px;background:linear-gradient(135deg,rgba(239,68,68,.07),rgba(220,38,38,.03));position:relative;overflow:hidden;margin-bottom:16px}
.livecard::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(239,68,68,.1),transparent 70%)}
.livecard-inner{position:relative;z-index:1}
.livebadge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;background:var(--red);color:#fff;font-size:.78rem;font-weight:900;letter-spacing:.5px;margin-bottom:11px}
/* COUNTDOWN */
.cdcard{border:1px solid rgba(124,92,252,.3);border-radius:16px;padding:20px;background:linear-gradient(135deg,rgba(124,92,252,.06),rgba(0,200,255,.04));margin-bottom:16px}
.cdgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:13px}
.cdu{text-align:center;padding:13px 8px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--rs)}
.cdv{font-family:var(--fd);font-size:1.6rem;font-weight:900;color:var(--cyan);line-height:1}
.cdl{font-size:.68rem;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
/* MURAL */
.muralcard{border:1px solid rgba(245,158,11,.25);border-radius:var(--r);padding:16px;background:rgba(245,158,11,.04);margin-bottom:11px;position:relative}
.muralcard.fix{border-color:rgba(245,158,11,.5);background:rgba(245,158,11,.07)}
.muralfix{position:absolute;top:11px;right:11px;font-size:.75rem;color:var(--amber);font-weight:800}
/* LOGIN */
#ls{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.lwrap{width:100%;max-width:430px}
.llogobox{width:58px;height:58px;border-radius:15px;margin:0 auto 13px;display:grid;place-items:center;background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(124,92,252,.18));border:1px solid rgba(0,200,255,.38);font-family:var(--fd);font-weight:900;font-size:1.05rem;color:#bff6ff;box-shadow:0 0 28px rgba(0,200,255,.18)}
.lcard{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:30px;box-shadow:0 40px 90px rgba(0,0,0,.5)}
.ltabs{display:flex;gap:3px;margin-bottom:22px;background:rgba(0,0,0,.28);border-radius:var(--rs);padding:3px}
.ltab{flex:1;padding:8px;text-align:center;border-radius:var(--rs);font-weight:700;cursor:pointer;transition:all .22s;font-family:var(--fb);font-size:.88rem;color:var(--muted)}
.ltab.act{background:linear-gradient(135deg,rgba(0,200,255,.18),rgba(124,92,252,.18));color:var(--cyan)}
.lbtn{width:100%;padding:12px;border:none;border-radius:var(--r);cursor:pointer;font-family:var(--fb);font-size:.97rem;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--purple));color:#050d14;box-shadow:0 8px 22px rgba(0,200,255,.22);transition:all .28s;margin-top:7px}
.lbtn:hover{transform:translateY(-2px);box-shadow:0 14px 34px rgba(0,200,255,.38)}
.lbtn:disabled{opacity:.4;cursor:not-allowed;transform:none}
hr.div{border:none;border-top:1px solid var(--border);margin:14px 0}
@media(max-width:1080px){.cgrid{grid-template-columns:1fr}}
@media(max-width:880px){.l2,.ladm{grid-template-columns:1fr}.sbar,.abar{display:none}.fgrid{grid-template-columns:1fr}}
@media(max-width:580px){.hdr{padding:0 12px}.bname{display:none}.mcont{padding:14px}.cdv{font-size:1.2rem}}
</style>
</head>
<body>
<div id="tc"></div>

<!-- LOGIN -->
<div id="ls" style="display:none">
  <div class="lwrap">
    <div style="text-align:center;margin-bottom:28px">
      <div class="llogobox">ESC</div>
      <div style="font-family:var(--fd);font-size:1.15rem;font-weight:700;color:#bff6ff">Plataforma de Ensino</div>
      <div style="font-size:.85rem;color:var(--muted);margin-top:3px">Dos dados ao Dashboard üìä</div>
    </div>
    <div class="lcard">
      <div class="ltabs">
        <div class="ltab act" data-lt="login">üîê Entrar</div>
        <div class="ltab" data-lt="reg">üóùÔ∏è Solicitar Acesso</div>
      </div>
      <div id="lf-login">
        <div class="fg" style="margin-bottom:13px"><label class="fl">Login</label><input id="lUser" class="fi" type="text" placeholder="seu.login" autocomplete="username"/></div>
        <div class="fg" style="margin-bottom:13px"><label class="fl">Senha</label><input id="lPass" class="fi" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
        <div id="lErr" class="ferr" style="min-height:18px;margin-bottom:8px"></div>
        <button id="lBtn" class="lbtn">ENTRAR</button>
        <div style="text-align:center;margin-top:12px">
          <button id="bForgot" style="background:none;border:none;color:rgba(0,200,255,.6);font-size:.8rem;cursor:pointer;text-decoration:underline;font-family:inherit">Esqueci minha senha</button>
        </div>
      </div>
      <div id="lf-reg" class="hidden">
        <div style="padding:10px;border:1px solid rgba(0,200,255,.18);border-radius:var(--rs);background:rgba(0,200,255,.04);margin-bottom:14px;font-size:.84rem;color:var(--soft)">
          ‚ÑπÔ∏è Preencha seus dados. Ap√≥s aprova√ß√£o do admin, voc√™ receber√° acesso.
        </div>
        <div class="fgrid" style="margin-bottom:13px">
          <div class="fg"><label class="fl">Nome completo</label><input id="rNome" class="fi" placeholder="Jo√£o da Silva"/></div>
          <div class="fg"><label class="fl">Email</label><input id="rEmail" class="fi" type="email" placeholder="joao@empresa.com"/></div>
          <div class="fg"><label class="fl">Login desejado</label><input id="rLogin" class="fi" placeholder="joao.silva"/></div>
          <div class="fg"><label class="fl">Senha</label><input id="rPass" class="fi" type="password" placeholder="M√≠nimo 6 caracteres"/></div>
        </div>
        <div id="rErr" class="ferr" style="min-height:18px;margin-bottom:8px"></div>
        <button id="rBtn" class="lbtn">SOLICITAR ACESSO</button>
      </div>
    </div>
  </div>
</div>

<!-- STUDENT APP -->
<div id="sa" class="hidden">
  <header class="hdr">
    <div class="brand"><div class="blog">ESC</div><div><div class="bname">ESC Plataforma</div><div class="bsub" id="sTurmaHdr">Telemetria B30</div></div></div>
    <div class="hright">
      <div id="ew" class="expw hidden">‚ö†Ô∏è Expira em <span id="ed"></span>d</div>
      <div class="nbell-wrap">
        <div class="nbell" id="sBell" title="Notifica√ß√µes">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span class="nbell-count" id="sBellCount">0</span>
        </div>
        <div class="ndrop" id="sBellDrop">
          <div class="ndrop-hdr"><span>üîî Notifica√ß√µes</span><span id="sBellMarkAll" style="font-size:.75rem;font-weight:400;color:var(--cyan);cursor:pointer">Marcar tudo lido</span></div>
          <div id="sBellList"><div class="ndrop-empty">Sem notifica√ß√µes</div></div>
        </div>
      </div>
      <div class="uchip"><div id="sAv" class="uav">?</div><span id="sNm" class="uname"></span></div>
      <button id="sOut" class="btn bg2 btn-sm">Sair</button>
    </div>
  </header>
  <div class="l2">
    <nav class="sbar">
      <div class="nsect">Navega√ß√£o</div>
      <div class="ni act" data-pg="dash"><span class="nic">üè†</span>Meu Progresso</div>
      <div class="ni" data-pg="class"><span class="nic">üéì</span>Sala de Aula</div>
      <div class="ni" data-pg="mural"><span class="nic">üìã</span>Mural</div>
      <div class="ni" data-pg="forum"><span class="nic">üí¨</span>F√≥rum</div>
      <div class="ni" id="navProjeto" data-pg="projeto" style="display:none"><span class="nic">üéì</span>Projeto Final</div>
      <div class="ni" id="navAval" data-pg="aval" style="display:none"><span class="nic">‚≠ê</span>Avaliar Curso</div>
      <div class="nsect">M√≥dulos</div>
      <div id="sML"></div>
      <div class="nsect" style="margin-top:18px">Progresso</div>
      <div style="padding:4px">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:.83rem;color:var(--soft)">Conclu√≠do</span><span style="font-size:.83rem;font-weight:800;color:var(--cyan)" id="sPct">0%</span></div>
        <div class="pw lg"><div id="sBar" class="pf" style="width:0%"></div></div>
        <div style="font-size:.75rem;color:var(--muted);margin-top:6px" id="sLbl">0 de 0 m√≥dulos</div>
      </div>
    </nav>
    <div class="mcont">

      <!-- DASHBOARD -->
      <div id="pg-dash" class="page act">
        <div style="margin-bottom:22px">
          <h1 style="font-family:var(--fd);font-size:1.3rem;color:#bff6ff;margin-bottom:3px">Ol√°, <span id="dWel"></span>! üëã</h1>
          <div style="color:var(--soft);font-size:.93rem">Continue de onde parou.</div>
        </div>

        <!-- LIVE CARD -->
        <div id="liveSection" class="hidden">
          <div class="livecard">
            <div class="livecard-inner">
              <div class="livebadge"><div class="livedot"></div> AO VIVO AGORA</div>
              <div style="font-family:var(--fd);font-size:1.05rem;color:#fff;margin-bottom:6px" id="liveTitulo">Aula ao Vivo</div>
              <div style="font-size:.88rem;color:rgba(255,255,255,.7);margin-bottom:16px" id="liveDesc">Sua turma est√° em aula agora!</div>
              <a id="liveBtn" href="#" target="_blank" rel="noopener" class="btn blv">
                <div class="livedot"></div> ENTRAR NA AULA
              </a>
            </div>
          </div>
        </div>

        <!-- COUNTDOWN -->
        <div id="cdSection" class="hidden">
          <div class="cdcard">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
              <div>
                <div style="font-family:var(--fd);font-size:.88rem;color:var(--purple);margin-bottom:3px">‚è±Ô∏è PR√ìXIMA AULA</div>
                <div style="font-weight:800;font-size:1rem" id="cdTitulo">‚Äî</div>
                <div style="font-size:.82rem;color:var(--muted);margin-top:2px" id="cdData">‚Äî</div>
              </div>
              <span class="badge bpp" id="cdTurmaLabel"></span>
            </div>
            <div class="cdgrid">
              <div class="cdu"><div class="cdv" id="cdD">00</div><div class="cdl">Dias</div></div>
              <div class="cdu"><div class="cdv" id="cdH">00</div><div class="cdl">Horas</div></div>
              <div class="cdu"><div class="cdv" id="cdM">00</div><div class="cdl">Min</div></div>
              <div class="cdu"><div class="cdv" id="cdS">00</div><div class="cdl">Seg</div></div>
            </div>
          </div>
        </div>

        <div class="sgrid" style="margin-bottom:20px">
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">üìö</div><div class="sval" id="dPct">0%</div><div class="slbl">Conclu√≠do</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">‚úÖ</div><div class="sval" id="dDone">0/0</div><div class="slbl">M√≥dulos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">‚è±Ô∏è</div><div class="sval" id="dTime">0h</div><div class="slbl">Tempo total</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">üéØ</div><div class="sval" id="dQuiz">‚Äî</div><div class="slbl">√öltimo quiz</div></div>
        </div>
        <div class="card cp">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div style="font-family:var(--fd);font-size:.95rem;color:#bff6ff">üó∫Ô∏è Trilha de Aprendizado</div>
            <span id="dTurma" class="badge bc"></span>
          </div>
          <div id="trail" class="trail"></div>
        </div>
      </div>

      <!-- CLASSROOM -->
      <div id="pg-class" class="page">
        <div class="cgrid">
          <div class="card">
            <div style="padding:11px 11px 0">
              <div class="plwr">
                <div id="vc" style="width:100%;height:100%;display:grid;place-items:center;color:var(--muted)">Selecione um m√≥dulo</div>
                <div class="pov"><span class="ptag" id="pMod">üìñ M√≥dulo</span><span class="ptag">üé¨ HD</span></div>
              </div>
            </div>
            <div class="tbar">
              <button class="tb" data-tab="aulas" id="tabAulas">üìö Aulas</button>
              <button class="tb act" data-tab="cont">üìñ Conte√∫do</button>
              <button class="tb" data-tab="mat">üìé Materiais</button>
              <button class="tb" data-tab="quiz">üéØ Quiz</button>
              <button class="tb" data-tab="note">üìù Anota√ß√µes</button>
              <button class="tb" data-tab="fmod">üí¨ F√≥rum</button>
            </div>
            <div>
              <div id="tab-aulas" class="tp">
                <h3 style="color:var(--cyan);margin-bottom:14px">üìö Aulas deste M√≥dulo</h3>
                <div id="aulasList"></div>
              </div>
              <div id="tab-cont" class="tp act">
                <h3 style="color:var(--cyan);margin-bottom:11px" id="cMT">‚Äî</h3>
                <div id="cTop" style="color:var(--soft);line-height:2"></div>
                <hr class="div"/>
                <div style="border:1px solid var(--border);border-radius:var(--r);padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
                  <div><div style="font-size:.83rem;color:var(--soft);margin-bottom:4px">Progresso do v√≠deo</div><div id="vPct" style="font-size:1.7rem;font-weight:900;color:#bff6ff">0%</div></div>
                  <button id="bDone" class="btn bp btn-sm">‚úÖ Concluir</button>
                </div>
              </div>
              <div id="tab-mat" class="tp"><h3 style="color:var(--cyan);margin-bottom:12px">üìé Materiais</h3><div id="cMat"></div></div>
              <div id="tab-quiz" class="tp"><h3 style="color:var(--cyan);margin-bottom:12px">üéØ Quiz</h3><div id="qCont"></div></div>
              <div id="tab-note" class="tp">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:11px">
                  <h3 style="color:var(--cyan)">üìù Anota√ß√µes</h3>
                  <button id="bNote" class="btn bo btn-sm">üíæ Salvar</button>
                </div>
                <textarea id="nta" class="nta" placeholder="Suas anota√ß√µes...&#10;&#10;üí° Salvas automaticamente a cada 30s."></textarea>
                <div style="font-size:.75rem;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between"><span><span id="nch">0</span> chars</span><span>Salvo: <span id="nSv">nunca</span></span></div>
              </div>
              <div id="tab-fmod" class="tp">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:11px">
                  <h3 style="color:var(--cyan)">üí¨ F√≥rum deste m√≥dulo</h3>
                  <button id="bNPM" class="btn bp btn-sm">+ D√∫vida</button>
                </div>
                <div id="fML"></div>
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:15px">
            <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:12px">üìö M√≥dulos</div><div id="cML" style="display:flex;flex-direction:column;gap:7px"></div></div>
            <div class="card cp">
              <div style="font-weight:800;color:var(--cyan);margin-bottom:11px">‚ÑπÔ∏è Detalhes</div>
              <div style="display:flex;flex-direction:column;gap:7px">
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Professor</span><span style="font-size:.85rem;font-weight:700">Equipe ESC</span></div>
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Acesso at√©</span><span style="font-size:.85rem;font-weight:700" id="cAU">‚Äî</span></div>
                <div style="display:flex;justify-content:space-between"><span style="font-size:.85rem;color:var(--soft)">Turma</span><span id="cTn" class="badge bc">‚Äî</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PROJETO -->
      <div id="pg-projeto" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üéì Projeto Final</div>
        <div id="projetoContent"></div>
      </div>

      <!-- AVALIA√á√ÉO -->
      <div id="pg-aval" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:6px">‚≠ê Avalia√ß√£o do Curso</div>
        <div style="font-size:.88rem;color:var(--muted);margin-bottom:22px">Sua opini√£o √© muito importante para continuarmos melhorando!</div>
        <div id="avalContent"></div>
      </div>

      <!-- MURAL -->
      <div id="pg-mural" class="page">
        <div style="margin-bottom:20px">
          <h1 style="font-family:var(--fd);font-size:1.2rem;color:#bff6ff;margin-bottom:3px">üìã Mural de Avisos</h1>
          <div style="color:var(--soft);font-size:.88rem">Comunicados da sua turma</div>
        </div>
        <div id="muralList"></div>
      </div>

      <!-- FORUM -->
      <div id="pg-forum" class="page">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
          <div><h1 style="font-family:var(--fd);font-size:1.2rem;color:#bff6ff;margin-bottom:3px">üí¨ F√≥rum</h1><div style="color:var(--soft);font-size:.88rem">Tire d√∫vidas e interaja</div></div>
          <button id="bNP" class="btn bp">+ Nova D√∫vida</button>
        </div>
        <div style="display:flex;gap:11px;margin-bottom:18px;flex-wrap:wrap">
          <select id="fMF" class="fi" style="width:auto;min-width:190px"></select>
          <select id="fSF" class="fi" style="width:auto"><option value="approved">Publicadas</option><option value="mine">Minhas postagens</option></select>
        </div>
        <div id="fList"></div>
      </div>

    </div>
  </div>
</div>

<!-- ADMIN APP -->
<div id="aa" class="hidden">
  <header class="hdr">
    <div class="brand"><div class="blog">ESC</div><div><div class="bname">Painel Admin</div><div class="bsub">Gerenciamento</div></div></div>
    <div class="hright">
      <span class="badge br" style="padding:5px 11px;font-size:.8rem">üîß ADMIN</span>
      <div class="nbell-wrap">
        <div class="nbell" id="aBell" title="Notifica√ß√µes de alunos">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span class="nbell-count" id="aBellCount">0</span>
        </div>
        <div class="ndrop" id="aBellDrop">
          <div class="ndrop-hdr"><span>üîî Atividades dos Alunos</span><span id="aBellMarkAll" style="font-size:.75rem;font-weight:400;color:var(--cyan);cursor:pointer">Limpar tudo</span></div>
          <div id="aBellList"><div class="ndrop-empty">Sem atividades recentes</div></div>
        </div>
      </div>
      <div class="uchip"><div class="uav" style="background:linear-gradient(135deg,var(--red),var(--purple))">A</div><span class="uname">Administrador</span></div>
      <button id="aOut" class="btn bg2 btn-sm">Sair</button>
    </div>
  </header>
  <div class="ladm">
    <nav class="abar">
      <div class="nsect" style="margin-top:0">Menu</div>
      <div class="ani act" data-adm="dash">üìä Dashboard</div>
      <div class="ani" data-adm="pend">üîî Pendentes <span id="pBadge" class="nbadge hidden" style="margin-left:5px">0</span></div>
      <div class="ani" data-adm="alunos">üë• Alunos</div>
      <div class="ani" data-adm="turmas">üè´ Turmas</div>
      <div class="ani" data-adm="mods">üé¨ M√≥dulos</div>
      <div class="ani" data-adm="aulas">üìö Aulas</div>
      <div class="ani" data-adm="mats">üìé Materiais</div>
      <div class="ani" data-adm="quiz">üéØ Quiz</div>
      <div class="ani" data-adm="qstats">üìä Analytics Quiz</div>
      <div class="ani" data-adm="projetos">üéì Projetos</div>
      <div class="ani" data-adm="live">üî¥ Aulas Ao Vivo</div>
      <div class="ani" data-adm="mural">üìã Mural</div>
      <div class="ani" data-adm="forum">üí¨ F√≥rum</div>
      <div class="ani" data-adm="aval">‚≠ê Avalia√ß√µes</div>
    </nav>
    <div class="mcont">

      <!-- ADM DASHBOARD -->
      <div id="adm-dash" class="page act">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üìä Dashboard</div>
        <div class="sgrid" style="margin-bottom:20px">
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">üë•</div><div class="sval" id="aA">0</div><div class="slbl">Alunos ativos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">‚è≥</div><div class="sval" id="aP">0</div><div class="slbl">Pendentes</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">üé¨</div><div class="sval" id="aMo">0</div><div class="slbl">M√≥dulos</div></div>
          <div class="sc"><div style="font-size:1.4rem;margin-bottom:8px">üìà</div><div class="sval" id="aMd">0%</div><div class="slbl">Progresso m√©dio</div></div>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üë• Progresso dos Alunos</div>
          <div class="tw2"><table><thead><tr><th>Aluno</th><th>Turma</th><th>Progresso</th><th>M√≥dulos</th><th>Validade</th><th>Status</th></tr></thead><tbody id="aDT"></tbody></table></div>
        </div>
      </div>

      <!-- PENDENTES -->
      <div id="adm-pend" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üîî Solicita√ß√µes Pendentes</div>
        <div id="pendCont" class="card cp"></div>
      </div>

      <!-- ALUNOS -->
      <div id="adm-alunos" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üë• Gerenciar Alunos</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Criar Aluno</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="aNome" class="fi" placeholder="Jo√£o da Silva"/></div>
            <div class="fg"><label class="fl">Email</label><input id="aEmail" class="fi" type="email" placeholder="joao@emp.com"/></div>
            <div class="fg"><label class="fl">Login</label><input id="aLogin" class="fi" placeholder="joao.silva"/></div>
            <div class="fg"><label class="fl">Senha</label><input id="aPass" class="fi" type="password" placeholder="Min. 6 chars"/></div>
            <div class="fg"><label class="fl">Turma</label><select id="aTurma" class="fi"><option value="">Sem turma</option></select></div>
            <div class="fg"><label class="fl">Meses de acesso</label><input id="aMes" class="fi" type="number" value="12" min="1"/></div>
          </div>
          <button id="bCA" class="btn bp" style="margin-top:13px">‚ûï Criar Aluno</button>
        </div>
        <div class="card cp" style="margin-bottom:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px">
            <div style="font-weight:800;color:var(--cyan)">üìã Todos os alunos</div>
            <div style="display:flex;gap:8px">
              <button class="btn bg2 btn-sm alunoTab act" data-at="lista">üë• Lista</button>
              <button class="btn bg2 btn-sm alunoTab" data-at="certs">üèÜ Certificados</button>
              <button class="btn bg2 btn-sm alunoTab" data-at="historico">üìö Hist√≥rico</button>
              <button class="btn bg2 btn-sm alunoTab" data-at="upsell">üí° Interesse</button>
            </div>
          </div>
          <div id="at-lista">
            <div class="tw2"><table><thead><tr><th>Nome</th><th>Login</th><th>Turma</th><th>Validade</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="aAT"></tbody></table></div>
          </div>
          <div id="at-certs" style="display:none">
            <div id="certList"></div>
          </div>
          <div id="at-historico" style="display:none">
            <div id="histList"></div>
          </div>
          <div id="at-upsell" style="display:none">
            <div id="upsellList"></div>
          </div>
        </div>
      </div>

      <!-- TURMAS -->
      <div id="adm-turmas" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üè´ Turmas</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Nova Turma</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="tNome" class="fi" placeholder="B30 ‚Äî Jan/2025"/></div>
            <div class="fg"><label class="fl">Descri√ß√£o</label><input id="tDesc" class="fi" placeholder="Opcional"/></div>
            <div class="fg full" style="display:flex;align-items:center;gap:10px;padding-top:4px">
              <input type="checkbox" id="tProjeto" style="accent-color:var(--cyan);width:18px;height:18px"/>
              <label for="tProjeto" class="fl" style="margin:0">Possui m√≥dulo de projeto final (habilita certificado)</label>
            </div>
          </div>
          <button id="bST" class="btn bp" style="margin-top:13px">üíæ Salvar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Turmas</div><div class="tw2"><table><thead><tr><th>Nome</th><th>Alunos</th><th>M√≥dulos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="aTT"></tbody></table></div></div>
      </div>

      <!-- MODULOS -->
      <div id="adm-mods" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üé¨ M√≥dulos</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Adicionar / Editar</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">T√≠tulo</label><input id="mTit" class="fi" placeholder="Introdu√ß√£o"/></div>
            <div class="fg"><label class="fl">√çcone</label><input id="mIco" class="fi" placeholder="üìñ" maxlength="4"/></div>
            <div class="fg"><label class="fl">Turma</label><select id="mTur" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">Tipo de v√≠deo</label><select id="mVT" class="fi"><option value="youtube">YouTube</option><option value="vimeo">Vimeo</option><option value="mp4">MP4 direto</option></select></div>
            <div class="fg full"><label class="fl">URL do v√≠deo</label><input id="mVU" class="fi" placeholder="https://www.youtube.com/watch?v=..."/></div>
            <div class="fg"><label class="fl">Dura√ß√£o (min)</label><input id="mDur" class="fi" type="number" placeholder="15" min="1"/></div>
            <div class="fg"><label class="fl">Ordem</label><input id="mOrd" class="fi" type="number" placeholder="1" min="1"/></div>
            <div class="fg full"><label class="fl">T√≥picos (um por linha)</label><textarea id="mTop" class="fi" rows="4" placeholder="Conceito de telemetria&#10;An√°lise de alarmes"></textarea></div>
            <input type="hidden" id="mEId"/>
          </div>
          <div style="display:flex;gap:10px;margin-top:13px"><button id="bSM" class="btn bp">üíæ Salvar</button><button id="bCM" class="btn bg2">‚úñ Limpar</button></div>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã M√≥dulos</div><div class="tw2"><table><thead><tr><th>Ord</th><th>M√≥dulo</th><th>Turma</th><th>Tipo</th><th>Dura√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="aMT2"></tbody></table></div></div>
      </div>

      <!-- MATERIAIS -->
      <div id="adm-mats" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üìé Materiais</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Adicionar Material</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Nome</label><input id="matN" class="fi" placeholder="Slides da aula"/></div>
            <div class="fg"><label class="fl">Tipo</label><select id="matT" class="fi"><option value="pdf">üìä PDF</option><option value="doc">üìã Doc</option><option value="xlsx">üìà Planilha</option><option value="link">üîó Link</option><option value="other">üì¶ Outro</option></select></div>
            <div class="fg full"><label class="fl">URL</label><input id="matU" class="fi" placeholder="https://..."/></div>
            <div class="fg"><label class="fl">Descri√ß√£o</label><input id="matD" class="fi" placeholder="Breve descri√ß√£o"/></div>
            <div class="fg"><label class="fl">M√≥dulo</label><select id="matM" class="fi"><option value="">Todos</option></select></div>
          </div>
          <button id="bSMat" class="btn bp" style="margin-top:13px">‚ûï Adicionar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Materiais</div><div class="tw2"><table><thead><tr><th>Nome</th><th>Tipo</th><th>M√≥dulo</th><th>URL</th><th></th></tr></thead><tbody id="aMatT"></tbody></table></div></div>
      </div>

      <!-- QUIZ -->
      <div id="adm-quiz" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üéØ Quiz</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Nova Quest√£o</div>
          <div class="fgrid">
            <div class="fg full"><label class="fl">Enunciado</label><textarea id="qEn" class="fi" rows="2" placeholder="Qual m√©trica..."></textarea></div>
            <div class="fg full"><label class="fl">Op√ß√µes (marque a correta)</label>
              <div style="display:flex;flex-direction:column;gap:7px;margin-top:5px">
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="0" style="accent-color:var(--cyan)"/><input id="qO0" class="fi" placeholder="Op√ß√£o A"/></div>
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="1" style="accent-color:var(--cyan)"/><input id="qO1" class="fi" placeholder="Op√ß√£o B"/></div>
                <div style="display:flex;align-items:center;gap:8px"><input type="radio" name="qC" value="2" style="accent-color:var(--cyan)"/><input id="qO2" class="fi" placeholder="Op√ß√£o C"/></div>
              </div>
            </div>
            <div class="fg"><label class="fl">M√≥dulo</label><select id="qMod" class="fi"><option value="">Geral</option></select></div>
          </div>
          <button id="bSQ" class="btn bp" style="margin-top:13px">‚ûï Adicionar</button>
        </div>
        <div class="card cp"><div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Quest√µes</div><div id="aQL" style="display:flex;flex-direction:column;gap:9px"></div></div>
      </div>

      <!-- AULAS AO VIVO -->
      <div id="adm-live" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:6px">üî¥ Aulas Ao Vivo</div>
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:20px">Configure a aula ao vivo e o contador da pr√≥xima aula por turma.</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üî¥ Ativar / Desativar Aula Ao Vivo</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="lvTurma" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">T√≠tulo da aula</label><input id="lvTit" class="fi" placeholder="Ex: M√≥dulo 3 ‚Äî Telemetria ao vivo"/></div>
            <div class="fg full"><label class="fl">Link (YouTube Live / Google Meet)</label><input id="lvLink" class="fi" placeholder="https://youtube.com/live/..."/></div>
            <div class="fg"><label class="fl">Descri√ß√£o curta</label><input id="lvDesc" class="fi" placeholder="Ex: An√°lise de alarmes B30"/></div>
            <div class="fg"><label class="fl">Status</label>
              <select id="lvStatus" class="fi">
                <option value="1">üî¥ Ativar ‚Äî Aula ao vivo AGORA</option>
                <option value="0">‚ö´ Desativar</option>
              </select>
            </div>
          </div>
          <button id="bSLV" class="btn bp" style="margin-top:13px">üíæ Salvar configura√ß√£o</button>
        </div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--purple);margin-bottom:13px">‚è±Ô∏è Contador ‚Äî Pr√≥xima Aula</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="cdTurma" class="fi"><option value="">Selecione...</option></select></div>
            <div class="fg"><label class="fl">T√≠tulo da pr√≥xima aula</label><input id="cdTit" class="fi" placeholder="Ex: Aula 4 ‚Äî Dashboards"/></div>
            <div class="fg"><label class="fl">Data e hora</label><input id="cdDH" class="fi" type="datetime-local"/></div>
            <div class="fg"><label class="fl">Ativo?</label>
              <select id="cdAtivo" class="fi">
                <option value="1">‚úÖ Mostrar contador</option>
                <option value="0">‚ùå Ocultar</option>
              </select>
            </div>
          </div>
          <button id="bSCD" class="btn bp" style="margin-top:13px">üíæ Salvar contador</button>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Configura√ß√µes ativas por turma</div>
          <div id="lvTable"></div>
        </div>
      </div>

      <!-- MURAL ADMIN -->
      <div id="adm-mural" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:6px">üìã Mural de Avisos</div>
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:20px">Poste comunicados vis√≠veis para alunos de cada turma.</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Novo Aviso</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">Turma</label><select id="mrTurma" class="fi"><option value="">Todas as turmas</option></select></div>
            <div class="fg"><label class="fl">Fixar no topo?</label><select id="mrFix" class="fi"><option value="0">N√£o</option><option value="1">üìå Sim</option></select></div>
            <div class="fg full"><label class="fl">T√≠tulo</label><input id="mrTit" class="fi" placeholder="Ex: Aula cancelada ‚Äî reagendada"/></div>
            <div class="fg full"><label class="fl">Conte√∫do</label><textarea id="mrCont" class="fi" rows="4" placeholder="Texto do aviso..."></textarea></div>
          </div>
          <button id="bSMR" class="btn bp" style="margin-top:13px">üì§ Publicar Aviso</button>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Avisos publicados</div>
          <div id="aMuralList"></div>
        </div>
      </div>

      <!-- FORUM ADMIN -->
      <div id="adm-forum" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üí¨ Modera√ß√£o do F√≥rum</div>
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
          <select id="aFF" class="fi" style="width:auto"><option value="pending">‚è≥ Aguardando</option><option value="approved">‚úÖ Aprovados</option><option value="all">Todos</option></select>
          <button id="bRF" class="btn bg2 btn-sm">üîÑ Atualizar</button>
        </div>
        <div id="aFL"></div>
      </div>

      <!-- AULAS ADMIN -->
      <div id="adm-aulas" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üìö Gerenciar Aulas</div>
        <div class="card cp" style="margin-bottom:16px">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">‚ûï Adicionar / Editar Aula</div>
          <div class="fgrid">
            <div class="fg"><label class="fl">M√≥dulo</label><select id="aulaModulo" class="fi"><option value="">Selecione o m√≥dulo...</option></select></div>
            <div class="fg"><label class="fl">T√≠tulo da Aula</label><input id="aulaTit" class="fi" placeholder="Aula 01 ‚Äî Introdu√ß√£o"/></div>
            <div class="fg"><label class="fl">√çcone</label><input id="aulaIco" class="fi" placeholder="üé¨" maxlength="4"/></div>
            <div class="fg"><label class="fl">Tipo de v√≠deo</label><select id="aulaVT" class="fi"><option value="youtube">YouTube</option><option value="vimeo">Vimeo</option><option value="mp4">MP4 direto</option></select></div>
            <div class="fg full"><label class="fl">URL do v√≠deo</label><input id="aulaVU" class="fi" placeholder="https://www.youtube.com/watch?v=..."/></div>
            <div class="fg"><label class="fl">Dura√ß√£o (min)</label><input id="aulaDur" class="fi" type="number" placeholder="15" min="1"/></div>
            <div class="fg"><label class="fl">Ordem</label><input id="aulaOrd" class="fi" type="number" placeholder="1" min="1"/></div>
            <div class="fg full"><label class="fl">T√≥picos (um por linha)</label><textarea id="aulaTop" class="fi" rows="3" placeholder="Conceito&#10;An√°lise"></textarea></div>
            <input type="hidden" id="aulaEId"/>
          </div>
          <div style="display:flex;gap:10px;margin-top:13px">
            <button id="bSAula" class="btn bp">üíæ Salvar Aula</button>
            <button id="bCAula" class="btn bg2">‚úñ Limpar</button>
          </div>
        </div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Aulas por M√≥dulo</div>
          <div class="fg" style="margin-bottom:12px"><label class="fl">Filtrar por m√≥dulo</label><select id="aulaFiltro" class="fi"><option value="">Todos os m√≥dulos</option></select></div>
          <div class="tw2"><table><thead><tr><th>Ord</th><th>Aula</th><th>M√≥dulo</th><th>Tipo</th><th>Dura√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="aulasTable"></tbody></table></div>
        </div>
      </div>

      <!-- ANALYTICS QUIZ -->
      <div id="adm-qstats" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üìä Analytics do Quiz</div>
        <div class="card cp" style="margin-bottom:14px">
          <div class="fgrid">
            <div class="fg"><label class="fl">Filtrar por m√≥dulo</label><select id="qsFiltroMod" class="fi"><option value="">Todos os m√≥dulos</option></select></div>
            <div class="fg" style="align-items:flex-end;display:flex"><button id="bQStats" class="btn bp btn-sm">üîç Analisar</button></div>
          </div>
        </div>
        <div id="qStatsResume" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px"></div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Desempenho por Quest√£o</div>
          <div id="qStatsList"></div>
        </div>
      </div>

      <!-- PROJETOS ADMIN -->
      <div id="adm-projetos" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">üéì Projetos dos Alunos</div>
        <div class="card cp" style="margin-bottom:14px">
          <div class="fgrid">
            <div class="fg"><label class="fl">Filtrar por turma</label><select id="projFiltro" class="fi"><option value="">Todas as turmas</option></select></div>
            <div class="fg"><label class="fl">Status</label><select id="projStatus" class="fi"><option value="">Todos</option><option value="enviado">Enviados</option><option value="em_revisao">Em revis√£o</option><option value="aprovado">Aprovados</option><option value="reprovado">Reprovados</option></select></div>
            <div class="fg" style="align-items:flex-end;display:flex"><button id="bLoadProj" class="btn bp btn-sm">üîç Filtrar</button></div>
          </div>
        </div>
        <div id="projList"></div>
      </div>




      <!-- AVALIA√á√ïES ADM -->
      <div id="adm-aval" class="page">
        <div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);margin-bottom:18px">‚≠ê Avalia√ß√µes do Curso</div>
        <div id="avalResume" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px"></div>
        <div class="card cp" style="margin-bottom:14px">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <select id="avalFiltroTurma" class="fi" style="width:auto;min-width:180px"><option value="">Todas as turmas</option></select>
            <select id="avalFiltroNota" class="fi" style="width:auto;min-width:140px">
              <option value="">Todas as notas</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 estrelas</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 estrelas</option>
              <option value="3">‚≠ê‚≠ê‚≠ê 3 estrelas</option>
              <option value="2">‚≠ê‚≠ê 2 estrelas</option>
              <option value="1">‚≠ê 1 estrela</option>
            </select>
            <button id="bLoadAval" class="btn bp btn-sm">üîç Filtrar</button>
            <button id="bExportAval" class="btn bg2 btn-sm">üì• Exportar CSV</button>
          </div>
        </div>
        <div id="avalGrafico" style="margin-bottom:18px"></div>
        <div class="card cp">
          <div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üìã Todas as avalia√ß√µes</div>
          <div id="avalList"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="mBg" class="mbg hidden"><div id="mCont" class="modal"></div></div>


<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ESC PLATAFORMA ‚Äî JS COMPLETO
   Vers√£o: 3.0 | Todas as funcionalidades
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let sb=null;
try{sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);}catch(e){}
let CU=null,CTurma=null,mods=[],actMod=null,actAula=null,wTimer=null,wSec=0,cdTimer=null,inactTimer=null,userIdleSec=0;
// Track user idle time for progress (pauses if truly idle >2min)
setInterval(()=>{userIdleSec++;},1000);
['click','keydown','mousemove','scroll','touchstart'].forEach(ev=>document.addEventListener(ev,()=>{userIdleSec=0;},{passive:true}));
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const INACT_LIMIT=30*60*1000; // 30 min

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function ft(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60,p=n=>String(n).padStart(2,'0');return h>0?`${h}:${p(m)}:${p(sec)}`:`${p(m)}:${p(sec)}`;}
function pct(a,b){return b>0?Math.round((a/b)*100):0;}
async function sha(s){const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');}
function fd(d){return d?new Date(d).toLocaleDateString('pt-BR'):'‚Äî';}
function fdt(d){return d?new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';}
function du(d){return d?Math.ceil((new Date(d)-new Date())/(864e5)):null;}
function ti(t){return{pdf:'üìä',doc:'üìã',xlsx:'üìà',link:'üîó',other:'üì¶'}[t]||'üì¶';}
function toast(msg,tp='i'){const el=document.createElement('div');el.className=`toast t${tp}`;el.textContent=msg;$('#tc').appendChild(el);setTimeout(()=>{el.style.animation='tIn .3s ease reverse';setTimeout(()=>el.remove(),300);},3200);}
function showModal(html){$('#mCont').innerHTML=html;$('#mBg').classList.remove('hidden');}
function closeModal(){$('#mBg').classList.add('hidden');}
$('#mBg').addEventListener('click',e=>{if(e.target===$('#mBg'))closeModal();});
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}

/* ‚îÄ‚îÄ SESSION PERSISTENCE ‚îÄ‚îÄ */
function saveSession(){if(CU)sessionStorage.setItem('esc_user',JSON.stringify(CU));}
function clearSession(){sessionStorage.removeItem('esc_user');sessionStorage.removeItem('esc_mod');sessionStorage.removeItem('esc_aula');}
// Inactivity logout (30 min no interaction)
function resetInactTimer(){
  clearTimeout(inactTimer);
  inactTimer=setTimeout(()=>{
    toast('Sess√£o expirada por inatividade.','w');
    setTimeout(doLogout,2000);
  },INACT_LIMIT);
}
['click','keydown','mousemove','touchstart'].forEach(ev=>document.addEventListener(ev,resetInactTimer,{passive:true}));

/* ‚îÄ‚îÄ CONCURRENT LOGIN ‚îÄ‚îÄ */
let sessionToken=null;
async function checkConcurrent(){
  if(!sb||!CU||CU.role==='admin')return true;
  const{data}=await sb.from('users').select('session_token').eq('id',CU.id).single();
  if(data&&data.session_token&&data.session_token!==sessionToken){
    toast('Sua conta foi acessada em outro dispositivo.','e');
    setTimeout(doLogout,2500);
    return false;
  }
  return true;
}
async function setSessionToken(){
  if(!sb||!CU||CU.role==='admin')return;
  sessionToken=genId();
  await sb.from('users').update({session_token:sessionToken,ultimo_acesso:new Date().toISOString()}).eq('id',CU.id);
  setInterval(async()=>{await checkConcurrent();},60000);
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
$$('.ltab').forEach(t=>t.addEventListener('click',()=>{
  $$('.ltab').forEach(x=>x.classList.remove('act'));t.classList.add('act');
  const tb=t.dataset.lt;
  $('#lf-login').classList.toggle('hidden',tb!=='login');
  $('#lf-reg').classList.toggle('hidden',tb!=='reg');
}));
$('#lBtn').addEventListener('click',doLogin);
$('#lPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

/* Forgot password */
document.getElementById('bForgot').addEventListener('click',()=>{
  showModal(
    '<div class="mtt">üîë Redefinir Senha</div>'+
    '<p style="font-size:.88rem;color:var(--soft);margin-bottom:14px;line-height:1.6">Digite seu login ou e-mail. Se o cadastro existir, um link de redefini√ß√£o ser√° enviado por e-mail ou o administrador ser√° notificado.</p>'+
    '<div class="fg" style="margin-bottom:14px"><label class="fl">Login ou e-mail</label><input id="forgotInput" class="fi" placeholder="seu.login ou email@empresa.com"/></div>'+
    '<div id="forgotMsg" style="min-height:18px;margin-bottom:10px;font-size:.84rem"></div>'+
    '<div style="display:flex;gap:9px"><button id="forgotBtn" class="btn bp">Enviar</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>'
  );
  document.getElementById('forgotBtn').addEventListener('click',async()=>{
    const val=document.getElementById('forgotInput').value.trim();
    const msg=document.getElementById('forgotMsg');
    if(!val){msg.style.color='var(--amber)';msg.textContent='Digite seu login ou e-mail.';return;}
    document.getElementById('forgotBtn').disabled=true;
    if(!sb){msg.style.color='var(--green)';msg.textContent='‚úÖ Solicita√ß√£o registrada. O administrador ir√° redefinir sua senha.';return;}
    // Try to find user by login or email
    const{data:byLogin}=await sb.from('users').select('id,email,nome').eq('login',val).single();
    const{data:byEmail}=byLogin?{data:null}:await sb.from('users').select('id,email,nome').eq('email',val).single();
    const user=byLogin||byEmail;
    if(!user){msg.style.color='var(--amber)';msg.textContent='Nenhuma conta encontrada com esses dados.';document.getElementById('forgotBtn').disabled=false;return;}
    // Insert reset request (admin will see it)
    await sb.from('reset_requests').insert({user_id:user.id,email:user.email,nome:user.nome,solicitado_em:new Date().toISOString(),resolvido:false});
    msg.style.color='var(--green)';msg.textContent='‚úÖ Solicita√ß√£o enviada! O administrador ir√° redefinir sua senha em breve.';
  });
});

async function doLogin(){
  const lg=$('#lUser').value.trim(),pw=$('#lPass').value.trim(),err=$('#lErr');
  if(!lg||!pw){err.textContent='Preencha login e senha.';return;}
  err.textContent='';
  if(!sb){
    if(lg==='admin'&&pw==='admin2024'){CU={id:'da',nome:'Administrador',login:'admin',role:'admin',status:'active'};showAdmin();}
    else if(lg==='aluno1'&&pw==='123456'){CU={id:'ds1',nome:'Carlos Demo',login:'aluno1',role:'student',status:'active',turma_id:null,validade_acesso:'2027-01-01'};showStudent();}
    else{err.textContent='Demo: admin/admin2024 ou aluno1/123456';}
    return;
  }
  $('#lBtn').disabled=true;$('#lBtn').textContent='Entrando...';
  const hash=await sha(pw);
  const{data,error}=await sb.from('users').select('*').eq('login',lg).eq('senha',hash).single();
  $('#lBtn').disabled=false;$('#lBtn').textContent='Entrar';
  if(error||!data){err.textContent='Login ou senha incorretos.';return;}
  if(data.status==='pending'){err.textContent='Cadastro aguardando aprova√ß√£o.';return;}
  if(data.status==='blocked'){err.textContent='Acesso bloqueado. Contate o administrador.';return;}
  if(data.status==='expired'||(data.validade_acesso&&new Date(data.validade_acesso)<new Date())){err.textContent='Acesso expirado. Contate o administrador.';return;}
  CU=data;
  saveSession();
  resetInactTimer();
  if(data.role==='admin')showAdmin();else{await setSessionToken();showStudent();}
}

$('#rBtn').addEventListener('click',async()=>{
  const n=$('#rNome').value.trim(),e=$('#rEmail').value.trim(),l=$('#rLogin').value.trim(),p=$('#rPass').value.trim(),err=$('#rErr');
  if(!n||!e||!l||!p){err.textContent='Preencha todos os campos.';return;}
  if(p.length<6){err.textContent='Senha m√≠nimo 6 caracteres.';return;}
  if(!sb){toast('Configure o Supabase.','w');return;}
  $('#rBtn').disabled=true;
  const hash=await sha(p);
  const{error}=await sb.from('users').insert({nome:n,email:e,login:l,senha:hash,role:'student',status:'pending'});
  $('#rBtn').disabled=false;
  if(error){$('#rErr').textContent=error.message.includes('unique')?'Login ou e-mail j√° em uso.':'Erro ao enviar.';return;}
  toast('Solicita√ß√£o enviada! Aguarde aprova√ß√£o.','s');document.querySelector('[data-lt="login"]').click();
});

function doLogout(){
  CU=null;CTurma=null;actMod=null;actAula=null;mods=[];
  if(wTimer)clearInterval(wTimer);if(cdTimer)clearInterval(cdTimer);clearTimeout(inactTimer);
  clearSession();
  if(sb&&sessionToken){sb.from('users').update({session_token:null}).eq('id',CU?.id||'');}
  $('#sa').classList.add('hidden');$('#aa').classList.add('hidden');
  $('#ls').style.display='flex';$('#lUser').value='';$('#lPass').value='';$('#lErr').textContent='';
}
$('#sOut').addEventListener('click',doLogout);
$('#aOut').addEventListener('click',doLogout);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SISTEMA DE NOTIFICA√á√ïES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ Toggle bells on click ‚îÄ‚îÄ
document.addEventListener('click',e=>{
  const sbell=document.getElementById('sBell');
  const sbell_drop=document.getElementById('sBellDrop');
  const abell=document.getElementById('aBell');
  const abell_drop=document.getElementById('aBellDrop');
  if(sbell&&sbell.contains(e.target)){sbell_drop.classList.toggle('open');}
  else if(sbell_drop&&!sbell_drop.contains(e.target)){sbell_drop?.classList.remove('open');}
  if(abell&&abell.contains(e.target)){abell_drop.classList.toggle('open');if(abell_drop.classList.contains('open'))pollAdminNotifs();}
  else if(abell_drop&&!abell_drop.contains(e.target)){abell_drop?.classList.remove('open');}
});

// ‚îÄ‚îÄ STUDENT: Mural notifications ‚îÄ‚îÄ
async function pollStudentNotifs(){
  if(!sb||!CU||CU.role==='admin')return;
  const lastSeen=localStorage.getItem('mural_seen_'+CU.id)||'1970-01-01';
  let q=sb.from('mural_avisos').select('id,titulo,criado_em,fixado').eq('ativo',true).gt('criado_em',lastSeen).order('criado_em',{ascending:false}).limit(20);
  if(CU.turma_id)q=q.or('turma_id.eq.'+CU.turma_id+',turma_id.is.null');else q=q.is('turma_id',null);
  const{data:novos}=await q;
  const count=(novos||[]).length;
  const countEl=document.getElementById('sBellCount');
  if(countEl){countEl.textContent=count>9?'9+':count;countEl.classList.toggle('show',count>0);}
  const list=document.getElementById('sBellList');
  if(!list)return;
  if(!count){list.innerHTML='<div class="ndrop-empty">Sem comunicados novos üéâ</div>';return;}
  list.innerHTML=novos.map(av=>`<div class="ndrop-item unread" onclick="irParaMural('${av.id}')">
    <div class="ndrop-ic" style="background:rgba(0,200,255,.1)">üì¢</div>
    <div class="ndrop-body">
      <div class="ndrop-title">${av.fixado?'üìå ':''}${av.titulo}</div>
      <div class="ndrop-sub">${fdt(av.criado_em)}</div>
    </div>
  </div>`).join('');
  // Mark all button
  const markAll=document.getElementById('sBellMarkAll');
  if(markAll)markAll.onclick=()=>{
    localStorage.setItem('mural_seen_'+CU.id,new Date().toISOString());
    pollStudentNotifs();
    document.getElementById('sBellDrop')?.classList.remove('open');
    toast('‚úÖ Notifica√ß√µes marcadas como lidas.','s');
  };
}
window.irParaMural=function(id){
  document.getElementById('sBellDrop')?.classList.remove('open');
  $$('[data-pg]').forEach(x=>x.classList.remove('act'));
  const muralNav=document.querySelector('[data-pg="mural"]');
  if(muralNav){muralNav.classList.add('act');}
  $$('#sa .page').forEach(p=>p.classList.remove('act'));
  document.getElementById('pg-mural')?.classList.add('act');
  loadMural();
  // Mark as seen
  localStorage.setItem('mural_seen_'+CU.id,new Date().toISOString());
  const countEl=document.getElementById('sBellCount');
  if(countEl){countEl.textContent='0';countEl.classList.remove('show');}
};

// ‚îÄ‚îÄ ADMIN: Activity notifications ‚îÄ‚îÄ
let adminNotifsSeen=localStorage.getItem('admin_notifs_seen')||'1970-01-01';
async function pollAdminNotifs(){
  if(!sb||!CU||CU.role!=='admin')return;
  const items=[];
  // New forum posts (pending)
  const{data:fposts}=await sb.from('forum_posts').select('id,titulo,criado_em,users(nome)').eq('aprovado',false).gt('criado_em',adminNotifsSeen).order('criado_em',{ascending:false}).limit(10);
  (fposts||[]).forEach(p=>items.push({ic:'üí¨',color:'rgba(0,200,255,.15)',title:`Nova d√∫vida pendente`,sub:`${p.users?.nome||'?'}: "${p.titulo.substring(0,45)}${p.titulo.length>45?'...':''}"`,ts:p.criado_em,action:"goAdm('forum')"}));
  // New projects submitted
  const{data:projs}=await sb.from('projetos').select('id,enviado_em,users(nome),turmas(nome)').eq('status','enviado').gt('enviado_em',adminNotifsSeen).order('enviado_em',{ascending:false}).limit(10);
  (projs||[]).forEach(p=>items.push({ic:'üéì',color:'rgba(124,92,252,.15)',title:`Projeto enviado para revis√£o`,sub:`${p.users?.nome||'?'} ‚Äî ${p.turmas?.nome||'?'}`,ts:p.enviado_em,action:"goAdm('projetos')"}));
  // New avaliacoes
  const{data:avals}=await sb.from('avaliacoes').select('id,criado_em,nome_aluno,nota_geral').gt('criado_em',adminNotifsSeen).order('criado_em',{ascending:false}).limit(10);
  (avals||[]).forEach(a=>items.push({ic:'‚≠ê',color:'rgba(245,158,11,.15)',title:`Nova avalia√ß√£o recebida`,sub:`${a.anonimo?'An√¥nimo':a.nome_aluno||'?'} ‚Äî ${'‚≠ê'.repeat(a.nota_geral||0)} ${a.nota_geral}/5`,ts:a.criado_em,action:"goAdm('aval')"}));
  // New pending students
  const{data:pends}=await sb.from('users').select('id,nome,criado_em').eq('status','pending').gt('criado_em',adminNotifsSeen).order('criado_em',{ascending:false}).limit(5);
  (pends||[]).forEach(u=>items.push({ic:'üë§',color:'rgba(15,186,129,.15)',title:`Novo aluno aguardando aprova√ß√£o`,sub:u.nome,ts:u.criado_em,action:"goAdm('pend')"}));
  // New reset requests
  const{data:resets}=await sb.from('reset_requests').select('id,nome,solicitado_em').eq('resolvido',false).gt('solicitado_em',adminNotifsSeen).order('solicitado_em',{ascending:false}).limit(5);
  (resets||[]).forEach(r=>items.push({ic:'üîë',color:'rgba(239,68,68,.15)',title:`Solicita√ß√£o de redefini√ß√£o de senha`,sub:r.nome||'?',ts:r.solicitado_em,action:"goAdm('pend')"}));
  // Sort by most recent
  items.sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  const count=items.length;
  const countEl=document.getElementById('aBellCount');
  if(countEl){countEl.textContent=count>9?'9+':count;countEl.classList.toggle('show',count>0);}
  const list=document.getElementById('aBellList');
  if(!list)return;
  if(!count){list.innerHTML='<div class="ndrop-empty">Sem atividades novas üéâ</div>';return;}
  list.innerHTML=items.map(n=>`<div class="ndrop-item unread" onclick="${n.action}">
    <div class="ndrop-ic" style="background:${n.color}">${n.ic}</div>
    <div class="ndrop-body">
      <div class="ndrop-title">${n.title}</div>
      <div class="ndrop-sub">${n.sub}<br/><span style="color:var(--muted);font-size:.7rem">${fdt(n.ts)}</span></div>
    </div>
  </div>`).join('');
  const markAll=document.getElementById('aBellMarkAll');
  if(markAll)markAll.onclick=()=>{
    adminNotifsSeen=new Date().toISOString();
    localStorage.setItem('admin_notifs_seen',adminNotifsSeen);
    pollAdminNotifs();
    document.getElementById('aBellDrop')?.classList.remove('open');
    toast('‚úÖ Notifica√ß√µes limpas.','s');
  };
}
window.goAdm=function(panel){
  document.getElementById('aBellDrop')?.classList.remove('open');
  const navItem=document.querySelector(`.ani[data-adm="${panel}"]`);
  if(navItem)navItem.click();
};
// Notify admin when forum reply is sent
async function criarNotifAdmin(tipo,titulo,desc,extra){
  // This just triggers a poll ‚Äî the data is already in the DB
  // Poll will pick it up via timestamp comparison
  pollAdminNotifs();
}
// ‚îÄ‚îÄ Auto-poll intervals ‚îÄ‚îÄ
setInterval(()=>{if(CU?.role!=='admin')pollStudentNotifs();},60000);
setInterval(()=>{if(CU?.role==='admin')pollAdminNotifs();},90000);

/* ‚îÄ‚îÄ AUTO-RESTORE SESSION ‚îÄ‚îÄ */
window.addEventListener('load',async()=>{
  const saved=sessionStorage.getItem('esc_user');
  if(!saved){
    // No session: show login screen
    $('#ls').style.display='flex';
    return;
  }
  // Session found: keep login hidden, try to restore
  try{
    const u=JSON.parse(saved);
    if(!sb){
      CU=u;
      if(u.role==='admin')showAdmin();else showStudent();
      return;
    }
    const{data}=await sb.from('users').select('*').eq('id',u.id).single();
    if(!data||data.status==='blocked'||data.status==='expired'){
      clearSession();
      $('#ls').style.display='flex';
      return;
    }
    CU=data;resetInactTimer();
    const savedMod=sessionStorage.getItem('esc_mod');
    const savedAula=sessionStorage.getItem('esc_aula');
    if(data.role==='admin')showAdmin();
    else{
      await setSessionToken();
      await showStudent();
      if(savedMod)setTimeout(()=>openMod(savedMod),300);
    }
  }catch(e){
    clearSession();
    $('#ls').style.display='flex';
  }
});

/* ‚îÄ‚îÄ STUDENT ‚îÄ‚îÄ */
async function showStudent(){
  $('#ls').style.display='none';$('#sa').classList.remove('hidden');
  const ini=CU.nome.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  $('#sAv').textContent=ini;$('#sNm').textContent=CU.nome;$('#dWel').textContent=CU.nome.split(' ')[0];
  $('#cAU').textContent=fd(CU.validade_acesso);
  const d=du(CU.validade_acesso);
  if(d!==null&&d<=30&&d>0){$('#ew').classList.remove('hidden');$('#ed').textContent=d;}
  await loadMods();renderDash();renderSML();loadLiveSection();loadCountdown();
  // Check if student has projeto turma
  await checkProjetoTurma();
  await checkAvalNav();
  // Start notification polling
  setTimeout(pollStudentNotifs,1500);
  $$('[data-pg]').forEach(item=>item.addEventListener('click',()=>{
    const pg=item.dataset.pg;
    $$('[data-pg]').forEach(x=>x.classList.remove('act'));item.classList.add('act');
    $$('#sa .page').forEach(p=>p.classList.remove('act'));
    document.getElementById(`pg-${pg}`).classList.add('act');
    if(pg==='forum')loadFPage();if(pg==='mural')loadMural();if(pg==='projeto')loadProjetoAluno();if(pg==='aval')loadAvalAluno();
  }));
  $$('.tb').forEach(b=>b.addEventListener('click',()=>{
    const tab=b.dataset.tab;
    $$('.tb').forEach(x=>x.classList.remove('act'));b.classList.add('act');
    $$('.tp').forEach(p=>p.classList.remove('act'));
    document.getElementById(`tab-${tab}`).classList.add('act');
    if(tab==='note')loadNote();if(tab==='fmod')loadFMod();if(tab==='quiz')loadQuiz();if(tab==='aulas')loadAulasList();
  }));
}
async function checkProjetoTurma(){
  if(!sb||!CU.turma_id)return;
  const{data}=await sb.from('turmas').select('tem_projeto').eq('id',CU.turma_id).single();
  if(data?.tem_projeto){
    const nav=document.getElementById('navProjeto');
    if(nav)nav.style.display='';
  }
}
async function loadLiveSection(){
  if(!sb||!CU.turma_id){$('#liveSection').classList.add('hidden');return;}
  const{data}=await sb.from('aulas_ao_vivo').select('*').eq('turma_id',CU.turma_id).eq('tipo','live').eq('ativa',true).single();
  if(!data){$('#liveSection').classList.add('hidden');return;}
  $('#liveTitulo').textContent=data.titulo||'Aula Ao Vivo';
  $('#liveDesc').textContent=data.descricao||'';
  $('#liveBtn').href=data.link||'#';
  $('#liveSection').classList.remove('hidden');
}
async function loadCountdown(){
  if(cdTimer)clearInterval(cdTimer);
  if(!sb||!CU.turma_id){$('#cdSection').classList.add('hidden');return;}
  const{data}=await sb.from('aulas_ao_vivo').select('*').eq('turma_id',CU.turma_id).eq('tipo','countdown').eq('ativa',true).single();
  if(!data?.data_hora){$('#cdSection').classList.add('hidden');return;}
  const target=new Date(data.data_hora);
  if(target<new Date()){$('#cdSection').classList.add('hidden');return;}
  $('#cdTitulo').textContent=data.titulo||'Pr√≥xima Aula';
  $('#cdData').textContent=fdt(data.data_hora);
  $('#cdTurmaLabel').textContent=CTurma?.nome||'';
  $('#cdSection').classList.remove('hidden');
  function tick(){
    const diff=target-new Date();
    if(diff<=0){$('#cdSection').classList.add('hidden');clearInterval(cdTimer);return;}
    const p=n=>String(n).padStart(2,'0');
    $('#cdD').textContent=p(Math.floor(diff/864e5));
    $('#cdH').textContent=p(Math.floor((diff%864e5)/36e5));
    $('#cdM').textContent=p(Math.floor((diff%36e5)/6e4));
    $('#cdS').textContent=p(Math.floor((diff%6e4)/1e3));
  }
  tick();cdTimer=setInterval(tick,1000);
}
async function loadMods(){
  if(!sb){mods=[{id:'dm1',titulo:'Introdu√ß√£o',icone:'üìñ',duracao_seg:720,video_type:'youtube',video_url:'',topicos:'Vis√£o geral',ordem:1}];CTurma={nome:'Demo'};$('#sTurmaHdr').textContent='Turma Demo';return;}
  if(CU.turma_id){
    const{data:t}=await sb.from('turmas').select('*').eq('id',CU.turma_id).single();
    CTurma=t;if(t)$('#sTurmaHdr').textContent=t.nome;
    const{data:m}=await sb.from('modules').select('*').eq('turma_id',CU.turma_id).eq('ativo',true).order('ordem');
    mods=m||[];
  }else{CTurma=null;mods=[];}
}
async function getProg(){
  if(!sb||!mods.length)return{};
  const{data}=await sb.from('progress').select('*').eq('user_id',CU.id).in('modulo_id',mods.map(m=>m.id));
  const r={};(data||[]).forEach(p=>{r[p.modulo_id]=p;});return r;
}
async function renderDash(){
  $('#dTurma').textContent=CTurma?.nome||'Sem turma';$('#cTn').textContent=CTurma?.nome||'‚Äî';
  const pm=await getProg();
  const done=mods.filter(m=>pm[m.id]?.concluido).length,total=mods.length;
  const p=pct(done,total),ts=Object.values(pm).reduce((s,x)=>s+(x.segundos_vistos||0),0);
  const qs=Object.values(pm).filter(x=>x.quiz_score!=null);
  $('#dPct').textContent=p+'%';$('#dDone').textContent=`${done}/${total}`;
  $('#dTime').textContent=(ts/3600).toFixed(1)+'h';
  $('#dQuiz').textContent=qs.length?`${qs[qs.length-1].quiz_score}/${qs[qs.length-1].quiz_total||'?'}`:'‚Äî';
  $('#sPct').textContent=p+'%';$('#sBar').style.width=p+'%';$('#sLbl').textContent=`${done} de ${total} m√≥dulos`;
  const tr=$('#trail');tr.innerHTML='';
  mods.forEach(m=>{
    const mp=pm[m.id]||{segundos_vistos:0,concluido:false},pp=pct(mp.segundos_vistos||0,m.duracao_seg||1),isDone=mp.concluido,isCur=actMod===m.id;
    const el=document.createElement('div');el.className='tri';
    el.innerHTML=`<div class="tdot ${isDone?'done':isCur?'cur':'lock'}">${isDone?'‚úÖ':m.icone}</div><div style="flex:1;padding-top:7px"><div style="font-weight:800;font-size:.97rem;margin-bottom:5px;color:${isDone?'var(--green)':isCur?'var(--cyan)':'var(--text)'}">${m.titulo}</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:7px"><span style="font-size:.8rem;color:var(--muted)">‚è±Ô∏è ${ft(m.duracao_seg||0)}</span>${isDone?'<span class="badge bg3">Conclu√≠do</span>':pp>0?`<span class="badge bc">Em andamento ${pp}%</span>`:'<span class="badge bw2">N√£o iniciado</span>'}</div><div class="pw" style="max-width:260px"><div class="pf" style="width:${isDone?100:pp}%"></div></div><div style="margin-top:9px"><button class="btn bp btn-sm" onclick="openMod('${m.id}')">${isDone?'üîÅ Rever':pp>0?'‚ñ∂Ô∏è Continuar':'‚ñ∂Ô∏è Iniciar'}</button></div></div>`;
    tr.appendChild(el);
  });
  if(!mods.length)tr.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum m√≥dulo dispon√≠vel para sua turma.</div>';
}
function renderSML(){
  const l=$('#sML');l.innerHTML='';
  mods.forEach(m=>{
    const el=document.createElement('div');el.className=`ni${actMod===m.id?' act':''}`;
    el.innerHTML=`<span class="nic">${m.icone}</span><span style="font-size:.84rem">${m.titulo}</span>`;
    el.addEventListener('click',()=>openMod(m.id));l.appendChild(el);
  });
}
window.openMod=function(id){
  actMod=id;actAula=null;
  sessionStorage.setItem('esc_mod',id);sessionStorage.removeItem('esc_aula');
  $$('[data-pg]').forEach(x=>x.classList.remove('act'));
  document.querySelector('[data-pg="class"]').classList.add('act');
  $$('#sa .page').forEach(p=>p.classList.remove('act'));
  $('#pg-class').classList.add('act');
  const m=mods.find(x=>x.id===id);if(!m)return;
  $('#pMod').textContent=`${m.icone} ${m.titulo}`;$('#cMT').textContent=m.titulo;
  $('#cTop').innerHTML=(m.topicos||'').split('\n').filter(Boolean).map(t=>`‚Ä¢ ${t}<br/>`).join('')||'<span style="color:var(--muted)">Sem t√≥picos.</span>';
  // Switch to aulas tab first
  $$('.tb').forEach(x=>x.classList.remove('act'));
  $$('.tp').forEach(p=>p.classList.remove('act'));
  const tabAulas=document.getElementById('tabAulas');
  if(tabAulas){tabAulas.classList.add('act');document.getElementById('tab-aulas').classList.add('act');loadAulasList();}
  else{document.querySelector('[data-tab="cont"]').classList.add('act');document.getElementById('tab-cont').classList.add('act');loadVideo(m);}
  renderCML();loadCMats(id);$('#nta').oninput=()=>{$('#nch').textContent=$('#nta').value.length;};renderDash();renderSML();
};

/* ‚îÄ‚îÄ AULAS (STUDENT) ‚îÄ‚îÄ */
async function loadAulasList(){
  const l=$('#aulasList');
  if(!actMod){l.innerHTML='<div style="color:var(--muted)">Selecione um m√≥dulo.</div>';return;}
  if(!sb){l.innerHTML='<div style="color:var(--muted)">Nenhuma aula cadastrada.</div>';return;}
  const{data:aulas}=await sb.from('aulas').select('*').eq('modulo_id',actMod).eq('ativo',true).order('ordem');
  if(!aulas?.length){l.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üì≠ Nenhuma aula neste m√≥dulo ainda.</div>';return;}
  const{data:prog}=await sb.from('progress').select('*').eq('user_id',CU.id).in('aula_id',aulas.map(a=>a.id));
  const pm={};(prog||[]).forEach(p=>{pm[p.aula_id]=p;});
  l.innerHTML='';
  aulas.forEach((aula,i)=>{
    const ap=pm[aula.id]||{},pp=pct(ap.segundos_vistos||0,aula.duracao_seg||1),isDone=ap.concluido;
    const el=document.createElement('div');
    el.style.cssText=`display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--r);border:1px solid ${actAula===aula.id?'var(--cyan)':'var(--border)'};background:${actAula===aula.id?'rgba(0,200,255,.07)':'rgba(0,0,0,.14)'};margin-bottom:8px;cursor:pointer;transition:all .2s`;
    el.innerHTML=
      `<div style="width:36px;height:36px;border-radius:50%;background:${isDone?'rgba(15,186,129,.2)':actAula===aula.id?'rgba(0,200,255,.15)':'rgba(255,255,255,.05)'};display:grid;place-items:center;font-size:1.1rem;flex-shrink:0">${isDone?'‚úÖ':aula.icone||'üé¨'}</div>`+
      `<div style="flex:1"><div style="font-weight:700;font-size:.92rem">${i+1}. ${aula.titulo}</div>`+
      `<div style="display:flex;gap:8px;align-items:center;margin-top:3px"><span style="font-size:.76rem;color:var(--muted)">‚è±Ô∏è ${ft(aula.duracao_seg||0)}</span>${isDone?'<span class="badge bg3" style="font-size:.67rem">Conclu√≠da</span>':pp>0?`<span class="badge bc" style="font-size:.67rem">${pp}%</span>`:''}</div></div>`+
      `<div class="btn bp btn-sm" style="flex-shrink:0">${isDone?'‚ñ∂Ô∏è Rever':pp>0?'‚ñ∂Ô∏è Continuar':'‚ñ∂Ô∏è Assistir'}</div>`;
    el.addEventListener('click',()=>openAula(aula.id));
    l.appendChild(el);
  });
}
window.openAula=async function(id){
  if(!sb)return;
  const{data:aula}=await sb.from('aulas').select('*').eq('id',id).single();
  if(!aula)return;
  actAula=id;sessionStorage.setItem('esc_aula',id);
  // Switch to cont tab
  $$('.tb').forEach(x=>x.classList.remove('act'));$$('.tp').forEach(p=>p.classList.remove('act'));
  document.querySelector('[data-tab="cont"]').classList.add('act');
  document.getElementById('tab-cont').classList.add('act');
  $('#pMod').textContent=`${aula.icone||'üé¨'} ${aula.titulo}`;
  $('#cMT').textContent=aula.titulo;
  $('#cTop').innerHTML=(aula.topicos||'').split('\n').filter(Boolean).map(t=>`‚Ä¢ ${t}<br/>`).join('')||'<span style="color:var(--muted)">Sem t√≥picos.</span>';
  loadVideoAula(aula);loadAulasList();
};
function loadVideoAula(aula){
  const vc=$('#vc');if(wTimer)clearInterval(wTimer);
  if(!aula.video_url){vc.innerHTML='<div style="color:var(--muted)">üìπ V√≠deo em breve</div>';startWTAula(aula);return;}
  if(aula.video_type==='youtube'){const vid=ytId(aula.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://www.youtube.com/embed/${vid}?rel=0" allowfullscreen></iframe>`:'<div style="color:var(--muted)">URL inv√°lida</div>';}
  else if(aula.video_type==='vimeo'){const vid=vmId(aula.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://player.vimeo.com/video/${vid}" allowfullscreen></iframe>`:'<div style="color:var(--muted)">URL inv√°lida</div>';}
  else{vc.innerHTML=`<video class="vif" controls preload="metadata"><source src="${aula.video_url}" type="video/mp4"/></video>`;}
  startWTAula(aula);
}
async function startWTAula(aula){
  if(sb&&CU){const{data}=await sb.from('progress').select('*').eq('user_id',CU.id).eq('aula_id',aula.id).single();wSec=data?.segundos_vistos||0;}else wSec=0;
  updVP(aula);
  if(wTimer)clearInterval(wTimer);
  wTimer=setInterval(async()=>{
    if(document.hidden)return;
    if(userIdleSec>120)return;
    wSec=Math.min(wSec+1,aula.duracao_seg||36000);
    updVP(aula);
    if(wSec%20===0)await svProgressAula(aula);
  },1000);
}
function updVP(m){$('#vPct').textContent=pct(wSec,(m.duracao_seg||1))+'%';}
async function svProgressAula(aula,done=null){
  if(!sb||!CU)return;
  const pay={user_id:CU.id,aula_id:aula.id,modulo_id:actMod,segundos_vistos:wSec,atualizado_em:new Date().toISOString()};
  if(done!==null)pay.concluido=done;
  await sb.from('progress').upsert(pay,{onConflict:'user_id,aula_id'});
}
$('#bDone').addEventListener('click',async()=>{
  if(actAula&&sb){
    const{data:aula}=await sb.from('aulas').select('*').eq('id',actAula).single();
    if(aula){
      const p=pct(wSec,aula.duracao_seg||1);
      if(p<70&&!confirm(`Assistiu apenas ${p}%. Concluir mesmo assim?`))return;
      await svProgressAula(aula,true);toast('‚úÖ Aula conclu√≠da!','s');
      loadAulasList();renderDash();return;
    }
  }
  // fallback: module done
  const m=mods.find(x=>x.id===actMod);if(!m)return;
  const p2=pct(wSec,m.duracao_seg||1);
  if(p2<70&&!confirm(`Assistiu apenas ${p2}%. Concluir mesmo assim?`))return;
  await svP(m,true);toast('‚úÖ M√≥dulo conclu√≠do!','s');renderDash();
});

/* ‚îÄ‚îÄ MODULE VIDEO (fallback when no aulas) ‚îÄ‚îÄ */
function loadVideo(m){
  const vc=$('#vc');if(wTimer)clearInterval(wTimer);
  if(!m.video_url){vc.innerHTML='<div style="color:var(--muted)">üìπ V√≠deo em breve</div>';startWT(m);return;}
  if(m.video_type==='youtube'){const vid=ytId(m.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://www.youtube.com/embed/${vid}?rel=0" allowfullscreen></iframe>`:'<div style="color:var(--muted)">URL inv√°lida</div>';}
  else if(m.video_type==='vimeo'){const vid=vmId(m.video_url);vc.innerHTML=vid?`<iframe class="vif" src="https://player.vimeo.com/video/${vid}" allowfullscreen></iframe>`:'<div style="color:var(--muted)">URL inv√°lida</div>';}
  else{vc.innerHTML=`<video class="vif" controls preload="metadata"><source src="${m.video_url}" type="video/mp4"/></video>`;}
  startWT(m);
}
function ytId(u){const m=u.match(/(?:v=|youtu\.be\/|embed\/)([^#&?]{11})/);return m?m[1]:null;}
function vmId(u){const m=u.match(/vimeo.*\/(\d+)/i);return m?m[1]:null;}
async function startWT(m){
  if(sb&&CU){const{data}=await sb.from('progress').select('*').eq('user_id',CU.id).eq('modulo_id',m.id).single();wSec=data?.segundos_vistos||0;}else wSec=0;
  updVP(m);
  if(wTimer)clearInterval(wTimer);
  wTimer=setInterval(async()=>{
    // Only count when tab is visible and user is not idle
    if(document.hidden)return;
    if(userIdleSec>120)return; // pausa se inativo >2 min
    wSec=Math.min(wSec+1,m.duracao_seg||36000);
    updVP(m);
    if(wSec%20===0)await svP(m);
  },1000);
}
async function svP(m,done=null){
  if(!sb||!CU)return;
  const pay={user_id:CU.id,modulo_id:m.id,segundos_vistos:wSec,atualizado_em:new Date().toISOString()};
  if(done!==null)pay.concluido=done;
  await sb.from('progress').upsert(pay,{onConflict:'user_id,modulo_id'});
}
function renderCML(){
  const l=$('#cML');l.innerHTML='';
  mods.forEach(m=>{
    const el=document.createElement('div');
    el.style.cssText=`display:flex;align-items:center;gap:7px;padding:8px 10px;border-radius:var(--rs);cursor:pointer;transition:all .18s;border:1px solid ${m.id===actMod?'rgba(0,200,255,.28)':'transparent'};background:${m.id===actMod?'rgba(0,200,255,.07)':'transparent'}`;
    el.innerHTML=`<span>${m.icone}</span><span style="font-size:.85rem;font-weight:700">${m.titulo}</span>`;
    el.addEventListener('click',()=>openMod(m.id));l.appendChild(el);
  });
}
async function loadCMats(id){
  const l=$('#cMat');if(!sb){l.innerHTML='<div style="color:var(--muted)">Conecte o Supabase.</div>';return;}
  const{data}=await sb.from('materials').select('*').or(`modulo_id.eq.${id},modulo_id.is.null`);
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhum material.</div>';return;}
  l.innerHTML=data.map(mat=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:11px;border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;background:rgba(0,0,0,.18)"><div><div style="font-weight:700">${ti(mat.tipo)} ${mat.nome}</div><div style="font-size:.82rem;color:var(--muted)">${mat.descricao||''}</div></div><a class="btn bp btn-sm" href="${mat.url}" target="_blank" rel="noopener">Acessar</a></div>`).join('');
}
async function loadNote(){
  if(!actMod||!sb||!CU)return;
  const{data}=await sb.from('notes').select('*').eq('user_id',CU.id).eq('modulo_id',actMod).single();
  $('#nta').value=data?.conteudo||'';$('#nch').textContent=$('#nta').value.length;
  $('#nSv').textContent=data?.atualizado_em?new Date(data.atualizado_em).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'nunca';
}
$('#bNote').addEventListener('click',async()=>{
  if(!sb||!actMod||!CU)return;
  await sb.from('notes').upsert({user_id:CU.id,modulo_id:actMod,conteudo:$('#nta').value,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});
  $('#nSv').textContent=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});toast('üìù Anota√ß√µes salvas!','s');
});
setInterval(async()=>{if(sb&&CU&&actMod&&$('#nta').value)await sb.from('notes').upsert({user_id:CU.id,modulo_id:actMod,conteudo:$('#nta').value,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});},30000);

/* ‚îÄ‚îÄ QUIZ (STUDENT) ‚îÄ‚îÄ */
async function loadQuiz(){
  const qc=$('#qCont');if(!actMod)return;
  if(sb&&CU){
    const{data:pr}=await sb.from('progress').select('quiz_score,quiz_total').eq('user_id',CU.id).eq('modulo_id',actMod).single();
    if(pr?.quiz_score!=null){qc.innerHTML=`<div style="padding:15px;border:1px solid var(--green);border-radius:var(--r);background:rgba(15,186,129,.07)"><div style="font-weight:800;color:var(--green);margin-bottom:5px">‚úÖ Quiz respondido!</div><div>Nota: <strong>${pr.quiz_score}/${pr.quiz_total}</strong></div><button class="btn bg2 btn-sm" style="margin-top:10px" onclick="retakeQuiz()">üîÑ Refazer quiz</button></div>`;return;}
  }
  let qs=[];if(sb){const{data}=await sb.from('quiz').select('*').or(`modulo_id.eq.${actMod},modulo_id.is.null`).limit(10);qs=data||[];}
  if(!qs.length){qc.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma quest√£o para este m√≥dulo.</div>';return;}
  qc.innerHTML=qs.map((q,i)=>`<div class="card cp" style="margin-bottom:12px" data-qid="${q.id}"><div style="font-weight:800;margin-bottom:11px">${i+1}. ${q.question}</div><div style="display:flex;flex-direction:column;gap:6px">${(q.options||[]).map((o,oi)=>`<label style="display:flex;align-items:center;gap:9px;padding:9px;border:1px solid var(--border);border-radius:var(--rs);cursor:pointer" class="qo"><input type="radio" name="q_${q.id}" value="${oi}" style="accent-color:var(--cyan)"/> ${o}</label>`).join('')}</div></div>`).join('')+`<button id="bSQ2" class="btn bp">Enviar Respostas</button>`;
  qc.querySelectorAll('.qo').forEach(o=>o.addEventListener('click',function(){const qb=this.closest('[data-qid]');qb.querySelectorAll('.qo').forEach(x=>{x.style.borderColor='var(--border)';x.style.background='';});this.style.borderColor='var(--cyan)';this.style.background='rgba(0,200,255,.08)';}));
  document.getElementById('bSQ2').addEventListener('click',async()=>{
    let sc=0,ok=true,answers=[];
    qs.forEach(q=>{const s=qc.querySelector(`input[name="q_${q.id}"]:checked`);if(!s){ok=false;return;}const ans=parseInt(s.value);answers.push({qid:q.id,answer:ans,correct:q.correct_option,wrong:ans!==q.correct_option});if(ans===parseInt(q.correct_option))sc++;});
    if(!ok){toast('Responda todas as quest√µes!','w');return;}
    if(sb&&CU){
      await sb.from('progress').upsert({user_id:CU.id,modulo_id:actMod,segundos_vistos:wSec,quiz_score:sc,quiz_total:qs.length,atualizado_em:new Date().toISOString()},{onConflict:'user_id,modulo_id'});
      // Save per-question answers for analytics
      for(const a of answers){
        await sb.from('quiz_respostas').upsert({user_id:CU.id,quiz_id:a.qid,modulo_id:actMod,resposta:a.answer,correta:!a.wrong,criado_em:new Date().toISOString()},{onConflict:'user_id,quiz_id'});
      }
    }
    toast(`${sc}/${qs.length} corretas!`,sc===qs.length?'s':'i');loadQuiz();renderDash();
  });
}
window.retakeQuiz=async function(){
  if(!sb||!CU)return;
  await sb.from('progress').update({quiz_score:null,quiz_total:null}).eq('user_id',CU.id).eq('modulo_id',actMod);
  loadQuiz();
};

/* ‚îÄ‚îÄ MURAL (STUDENT) ‚îÄ‚îÄ */
async function loadMural(){
  const l=$('#muralList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  if(!sb){l.innerHTML='<div style="color:var(--muted)">Configure o Supabase.</div>';return;}
  let q=sb.from('mural_avisos').select('*').eq('ativo',true).order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(CU.turma_id)q=q.or('turma_id.eq.'+CU.turma_id+',turma_id.is.null');else q=q.is('turma_id',null);
  const{data}=await q.limit(30);
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">üì≠ Nenhum aviso no momento.</div>';return;}
  l.innerHTML=data.map(av=>'<div class="muralcard'+(av.fixado?' fix':'')+'">'+
    (av.fixado?'<div class="muralfix">üìå FIXADO</div>':'')+
    '<div style="display:flex;align-items:start;gap:11px"><div style="font-size:1.5rem;flex-shrink:0">üì¢</div><div style="flex:1">'+
    '<div style="font-weight:800;font-size:1rem;margin-bottom:5px">'+av.titulo+'</div>'+
    '<div style="color:var(--soft);font-size:.9rem;line-height:1.6;margin-bottom:9px">'+av.conteudo+'</div>'+
    '<div style="font-size:.75rem;color:var(--muted)">'+fdt(av.criado_em)+'</div>'+
    '</div></div></div>').join('');
}

/* ‚îÄ‚îÄ FORUM (STUDENT) ‚îÄ‚îÄ */
async function loadFPage(){
  $('#fMF').innerHTML='<option value="">Todos os m√≥dulos</option>'+mods.map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  await renderFL();
  $('#fMF').onchange=renderFL;$('#fSF').onchange=renderFL;
}
async function renderFL(){
  const l=$('#fList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  if(!sb)return;
  const mi=$('#fMF').value,sf=$('#fSF').value;
  let q=sb.from('forum_posts').select('*,users(nome,login)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(sf==='mine')q=q.eq('user_id',CU.id);
  else{q=q.eq('aprovado',true);if(mi)q=q.eq('modulo_id',mi);else if(CU.turma_id&&mods.length)q=q.or('modulo_id.is.null,'+mods.map(m=>'modulo_id.eq.'+m.id).join(','));}
  const{data:posts}=await q.limit(50);
  l.innerHTML='';
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhuma postagem encontrada.</div>';return;}
  for(const p of posts){
    const ini=(p.users?.nome||'?').substring(0,2).toUpperCase();
    const mn=mods.find(m=>m.id===p.modulo_id)?.titulo||'Geral';
    const{data:rps}=await sb.from('forum_replies').select('*,users(nome)').eq('post_id',p.id).eq('aprovado',true).order('criado_em');
    const card=document.createElement('div');card.className='pc'+(p.fixado?' pin':'');
    let rpsHtml='';
    for(const r of(rps||[])){
      const rAv=r.is_admin?'ADM':(r.users?.nome||'?').substring(0,2).toUpperCase();
      rpsHtml+='<div class="ri'+(r.is_admin?' adm-reply':'')+'"><div class="rav'+(r.is_admin?' adm':'')+'">'+rAv+'</div><div><div style="font-weight:700;font-size:.83rem">'+(r.is_admin?'<span style="color:var(--purple)">üë® Admin</span>':(r.users?.nome||'?'))+' <span style="font-weight:400;color:var(--muted)">'+fd(r.criado_em)+'</span></div><div style="font-size:.88rem;color:var(--soft);margin-top:2px">'+r.conteudo+'</div></div></div>';
    }
    card.innerHTML='<div class="phead"><div class="pav">'+ini+'</div><div style="flex:1"><div style="font-weight:800;font-size:.95rem;margin-bottom:2px">'+(p.fixado?'üìå ':'')+p.titulo+'</div><div style="font-size:.78rem;color:var(--muted)">por <strong>'+(p.users?.nome||'?')+'</strong> ¬∑ '+fd(p.criado_em)+' ¬∑ <span class="badge bc" style="font-size:.68rem">'+mn+'</span>'+(!p.aprovado?'<span class="badge ba" style="font-size:.68rem;margin-left:5px">Pendente</span>':'')+'</div></div></div><div class="pbody">'+p.conteudo+'</div><div class="pfooter"><span style="font-size:.82rem;color:var(--muted)">üí¨ '+(rps||[]).length+'</span><button class="btn bg2 btn-xs tog-rep">Ver respostas</button>'+(p.user_id===CU.id?'<button class="btn bd btn-xs del-post">üóëÔ∏è</button>':'')+'</div><div class="rlist hidden rep-area">'+rpsHtml+(p.aprovado?'<div style="padding:9px 14px;border-top:1px solid var(--border)"><textarea class="fi rep-ta" rows="2" placeholder="Sua resposta... (aguarda aprova√ß√£o)"></textarea><button class="btn bp btn-sm rep-send" style="margin-top:7px">Responder</button></div>':'')+'</div>';
    card.querySelector('.tog-rep').onclick=()=>card.querySelector('.rep-area').classList.toggle('hidden');
    const delBtn=card.querySelector('.del-post');if(delBtn)delBtn.onclick=async()=>{if(!confirm('Excluir?'))return;await sb.from('forum_posts').delete().eq('id',p.id);toast('Exclu√≠do.','i');renderFL();};
    const sendBtn=card.querySelector('.rep-send');if(sendBtn)sendBtn.onclick=async()=>{const ta=card.querySelector('.rep-ta'),txt=ta.value.trim();if(!txt){toast('Digite sua resposta.','w');return;}await sb.from('forum_replies').insert({post_id:p.id,user_id:CU.id,conteudo:txt,aprovado:false,is_admin:false});ta.value='';toast('Resposta enviada! Aguarda aprova√ß√£o.','i');renderFL();};
    l.appendChild(card);
  }
}
function openNP(mid,aulaid){
  const modOpts=mods.map(m=>`<option value="${m.id}"${m.id===mid?' selected':''}>${m.icone} ${m.titulo}</option>`).join('');
  showModal(
    '<div class="mtt">üí¨ Nova D√∫vida no F√≥rum</div>'+
    '<div class="fgrid" style="margin-bottom:4px">'+
      '<div class="fg"><label class="fl">M√≥dulo <span style="color:var(--red)">*</span></label>'+
        '<select id="npMod" class="fi"><option value="">‚Äî Selecione o m√≥dulo ‚Äî</option>'+modOpts+'</select></div>'+
      '<div class="fg"><label class="fl">Aula <span style="color:var(--muted);font-size:.75rem">(opcional)</span></label>'+
        '<select id="npAula" class="fi" disabled><option value="">Selecione o m√≥dulo primeiro</option></select></div>'+
    '</div>'+
    '<div class="fg" style="margin-bottom:12px"><label class="fl">T√≠tulo da d√∫vida <span style="color:var(--red)">*</span></label>'+
      '<input id="npT" class="fi" placeholder="Ex: Como funciona o PROCV com m√∫ltiplos crit√©rios?"/></div>'+
    '<div class="fg" style="margin-bottom:14px"><label class="fl">Descreva sua d√∫vida <span style="color:var(--red)">*</span></label>'+
      '<textarea id="npC" class="fi" rows="5" placeholder="Descreva com detalhes..."></textarea></div>'+
    '<div style="padding:10px;border:1px solid rgba(245,158,11,.2);border-radius:var(--rs);background:rgba(245,158,11,.05);margin-bottom:14px;font-size:.83rem;color:var(--amber)">‚è≥ Sua postagem ser√° revisada antes de ser publicada.</div>'+
    '<div style="display:flex;gap:9px"><button id="btnNPS" class="btn bp">üì§ Enviar D√∫vida</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>'
  );
  const modEl=document.getElementById('npMod');
  const aulaEl=document.getElementById('npAula');
  modEl.addEventListener('change',async function(){
    const modId=this.value;
    if(!modId){aulaEl.innerHTML='<option value="">Selecione o m√≥dulo primeiro</option>';aulaEl.disabled=true;return;}
    aulaEl.innerHTML='<option value="">Carregando aulas...</option>';aulaEl.disabled=true;
    if(sb){
      const{data:aulas}=await sb.from('aulas').select('id,titulo,icone,ordem').eq('modulo_id',modId).eq('ativo',true).order('ordem');
      if(aulas?.length){
        aulaEl.innerHTML='<option value="">D√∫vida geral do m√≥dulo</option>'+aulas.map(a=>`<option value="${a.id}"${a.id===aulaid?' selected':''}>${a.icone||'üé¨'} ${a.titulo}</option>`).join('');
        aulaEl.disabled=false;
      }else{aulaEl.innerHTML='<option value="">Sem aulas neste m√≥dulo</option>';aulaEl.disabled=true;}
    }
  });
  if(mid)modEl.dispatchEvent(new Event('change'));
  document.getElementById('btnNPS').onclick=async()=>{
    const modId=modEl.value,aulaId=aulaEl.value;
    if(!modId){toast('‚ö†Ô∏è Selecione um m√≥dulo.','w');return;}
    subPost(modId,aulaId);
  };
}
$('#bNP').addEventListener('click',()=>openNP(actMod||''));
$('#bNPM').addEventListener('click',()=>openNP(actMod||''));
async function subPost(mid,aulaId){
  const t=$('#npT').value.trim(),c2=$('#npC').value.trim();
  if(!t||!c2){toast('Preencha tudo.','w');return;}
  if(!mid){toast('‚ö†Ô∏è Selecione um m√≥dulo.','w');return;}
  const modName=mods.find(m=>m.id===mid)?.titulo||'';
  await sb.from('forum_posts').insert({modulo_id:mid||null,aula_id:aulaId||null,user_id:CU.id,titulo:t,conteudo:c2,aprovado:false,fixado:false});
  // Create notification for admin
  await criarNotifAdmin('forum',`üì© Nova d√∫vida no f√≥rum`,`${CU.nome} perguntou sobre "${modName}": ${t.substring(0,60)}${t.length>60?'...':''}`,{tipo:'forum',user:CU.nome});
  toast('‚úÖ Enviado para aprova√ß√£o!','s');closeModal();
  if($('#pg-forum').classList.contains('act'))renderFL();
  if($('#tab-fmod').classList.contains('act'))loadFMod();
}
async function loadFMod(){
  const l=$('#fML');if(!actMod||!sb)return;
  const{data:posts}=await sb.from('forum_posts').select('*,users(nome)').eq('aprovado',true).or('modulo_id.eq.'+actMod+',modulo_id.is.null').order('criado_em',{ascending:false}).limit(15);
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Sem d√∫vidas. Seja o primeiro!</div>';return;}
  l.innerHTML=posts.map(p=>'<div class="pc"><div class="phead"><div class="pav" style="width:26px;height:26px;font-size:.72rem">'+(p.users?.nome||'?').substring(0,2).toUpperCase()+'</div><div><div style="font-weight:800;font-size:.9rem">'+p.titulo+'</div><div style="font-size:.76rem;color:var(--muted)">'+(p.users?.nome||'?')+' ¬∑ '+fd(p.criado_em)+'</div></div></div><div class="pbody" style="font-size:.87rem">'+p.conteudo+'</div></div>').join('');
}

/* ‚îÄ‚îÄ PROJETO FINAL (STUDENT) ‚îÄ‚îÄ */
async function loadProjetoAluno(){
  const c2=$('#projetoContent');c2.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  if(!sb||!CU.turma_id)return;
  const{data:turma}=await sb.from('turmas').select('*').eq('id',CU.turma_id).single();
  if(!turma?.tem_projeto){c2.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Sua turma n√£o possui m√≥dulo de projeto.</div>';return;}
  // Verificar se todos m√≥dulos regulares conclu√≠dos
  const pm=await getProg();
  const modsReg=mods.filter(m=>!m.is_projeto);
  const todosConc=modsReg.length>0&&modsReg.every(m=>pm[m.id]?.concluido);
  // Carregar envio de projeto do aluno
  const{data:proj}=await sb.from('projetos').select('*').eq('user_id',CU.id).eq('turma_id',CU.turma_id).single();
  const status=proj?.status||'pendente';
  const bloqueado=!todosConc;
  c2.innerHTML='';
  // Card status
  const statusCard=document.createElement('div');
  statusCard.className='card cp';statusCard.style.marginBottom='16px';
  const statusColors={pendente:'var(--muted)',enviado:'var(--amber)',em_revisao:'var(--cyan)',aprovado:'var(--green)',reprovado:'var(--red)'};
  const statusLabels={pendente:'N√£o enviado',enviado:'Aguardando revis√£o',em_revisao:'Em revis√£o pelo professor',aprovado:'‚úÖ Aprovado!',reprovado:'‚ùå Reprovado ‚Äî veja os coment√°rios'};
  statusCard.innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:${proj?'16px':'0'}"><div style="width:48px;height:48px;border-radius:50%;background:${statusColors[status]||'var(--muted)'};opacity:.2;position:absolute"></div><div style="position:relative;font-size:2rem">${{pendente:'üìã',enviado:'üì§',em_revisao:'üîç',aprovado:'üèÜ',reprovado:'üìù'}[status]||'üìã'}</div><div><div style="font-weight:900;font-size:1.05rem">Projeto Final ‚Äî ${turma.nome}</div><div style="font-size:.88rem;color:${statusColors[status]||'var(--muted)'};font-weight:700;margin-top:3px">${statusLabels[status]||status}</div></div></div>${proj?.comentario_admin?`<div style="padding:12px;border:1px solid var(--border);border-radius:var(--rs);background:rgba(0,0,0,.2);font-size:.88rem;color:var(--soft);margin-top:12px"><div style="font-weight:800;color:var(--cyan);margin-bottom:5px">üí¨ Coment√°rio do Professor</div>${proj.comentario_admin}</div>`:''}`;
  c2.appendChild(statusCard);
  // Certificado dispon√≠vel
  if(status==='aprovado'){
    const certCard=document.createElement('div');certCard.className='card cp';certCard.style.cssText='margin-bottom:16px;border:1px solid var(--green);background:rgba(15,186,129,.05)';
    certCard.innerHTML='<div style="text-align:center;padding:20px"><div style="font-size:3rem;margin-bottom:8px">üèÜ</div><div style="font-weight:900;font-size:1.15rem;color:var(--green);margin-bottom:8px">Parab√©ns! Certificado dispon√≠vel!</div><div style="font-size:.9rem;color:var(--soft);margin-bottom:18px">Seu projeto foi aprovado. Voc√™ pode emitir seu certificado de conclus√£o.</div><button class="btn bp" onclick="emitirCertificado()">üéì Emitir Certificado</button></div>';
    c2.appendChild(certCard);
  }
  // Envio bloqueado se n√£o concluiu m√≥dulos
  if(bloqueado&&status==='pendente'){
    const blCard=document.createElement('div');blCard.className='card cp';
    blCard.innerHTML=`<div style="text-align:center;padding:24px;color:var(--muted)"><div style="font-size:2rem;margin-bottom:8px">üîí</div><div style="font-weight:800;margin-bottom:6px">Conclua todos os m√≥dulos primeiro</div><div style="font-size:.88rem">${modsReg.filter(m=>pm[m.id]?.concluido).length} de ${modsReg.length} m√≥dulos conclu√≠dos.</div></div>`;
    c2.appendChild(blCard);return;
  }
  // Form de envio (se n√£o aprovado)
  if(status!=='aprovado'){
    const formCard=document.createElement('div');formCard.className='card cp';
    const descricaoInstrucoes=turma.projeto_instrucoes||'Envie o link do seu projeto (Google Drive, GitHub, etc.) e uma descri√ß√£o do trabalho realizado.';
    formCard.innerHTML=`<div style="font-weight:800;color:var(--cyan);margin-bottom:12px">${status==='pendente'?'üì§ Enviar Projeto':'üîÑ Reenviar Projeto'}</div><div style="padding:12px;border:1px solid rgba(0,200,255,.15);border-radius:var(--rs);background:rgba(0,200,255,.04);font-size:.87rem;color:var(--soft);margin-bottom:14px;line-height:1.6">${descricaoInstrucoes}</div><div class="fgrid"><div class="fg full"><label class="fl">Link do projeto</label><input id="projLink" class="fi" placeholder="https://drive.google.com/..." value="${proj?.link||''}"/></div><div class="fg full"><label class="fl">Descri√ß√£o do projeto</label><textarea id="projDesc" class="fi" rows="5" placeholder="Descreva o que foi desenvolvido...">${proj?.descricao||''}</textarea></div></div><div style="margin-top:13px"><button class="btn bp" onclick="enviarProjeto()">üì§ Enviar para revis√£o</button></div>`;
    c2.appendChild(formCard);
  }
}
window.enviarProjeto=async function(){
  const link=$('#projLink').value.trim(),desc=$('#projDesc').value.trim();
  if(!link||!desc){toast('Preencha o link e a descri√ß√£o.','w');return;}
  if(!sb)return;
  await sb.from('projetos').upsert({user_id:CU.id,turma_id:CU.turma_id,link,descricao:desc,status:'enviado',enviado_em:new Date().toISOString()},{onConflict:'user_id,turma_id'});
  await criarNotifAdmin('projeto','üéì Projeto enviado',`${CU.nome} enviou o projeto final para revis√£o.`,{});
  toast('‚úÖ Projeto enviado para revis√£o!','s');loadProjetoAluno();
};
window.emitirCertificado=async function(){
  if(!sb||!CU)return;
  const{data:proj}=await sb.from('projetos').select('*').eq('user_id',CU.id).eq('turma_id',CU.turma_id).single();
  if(proj?.status!=='aprovado'){toast('Projeto ainda n√£o aprovado.','w');return;}
  const{data:turma}=await sb.from('turmas').select('*').eq('id',CU.turma_id).single();
  const dataAprov=fd(proj.aprovado_em||new Date());
  const totalHoras=Math.round(mods.reduce((s,m)=>s+(m.duracao_seg||0),0)/3600);
  const certId=genId().toUpperCase();
  // Save certificate record
  await sb.from('certificados').upsert({
    user_id:CU.id,turma_id:CU.turma_id,
    cert_id:certId,nome_aluno:CU.nome,nome_turma:turma?.nome||'',
    carga_horaria:totalHoras,emitido_em:new Date().toISOString(),aprovado_em:proj.aprovado_em
  },{onConflict:'user_id,turma_id'});
  // Open certificate
  gerarCertificadoHTML(CU.nome,turma?.nome||'',dataAprov,totalHoras,proj.aprovado_em,certId);
  // Check if Excel course ‚Üí show upsell
  const nomeT=(turma?.nome||'').toLowerCase();
  const isExcel=nomeT.includes('excel');
  if(isExcel){
    setTimeout(()=>mostrarUpsell(turma?.nome||''),1200);
  }
};
function mostrarUpsell(turmaOrigem){
  showModal(
    '<div style="text-align:center;padding:8px 0 16px">' +
    '<div style="font-size:2.5rem;margin-bottom:8px">üéâ</div>' +
    '<div style="font-family:var(--fd);font-size:1.2rem;color:var(--cyan);font-weight:800;margin-bottom:6px">Parab√©ns pelo certificado!</div>' +
    '<div style="font-size:.9rem;color:var(--soft);margin-bottom:22px;line-height:1.7">Voc√™ concluiu o Excel. Que tal dar o pr√≥ximo passo?</div>' +
    '</div>' +
    '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px">' +
    '<div style="border:1px solid rgba(0,200,255,.25);border-radius:var(--r);padding:14px;background:rgba(0,200,255,.05);cursor:pointer" onclick="registrarInteresse(\'powerbi\',\''+turmaOrigem+'\')">' +
    '<div style="font-weight:800;color:var(--cyan);margin-bottom:4px">üìä Power BI ‚Äî Dashboards Profissionais</div>' +
    '<div style="font-size:.84rem;color:var(--soft)">Aprenda a criar dashboards interativos com Power BI e transforme seus dados em decis√µes.</div>' +
    '<div style="font-size:.8rem;color:var(--cyan);margin-top:8px;font-weight:700">üëÜ Tenho interesse</div>' +
    '</div>' +
    '<div style="border:1px solid rgba(124,92,252,.25);border-radius:var(--r);padding:14px;background:rgba(124,92,252,.05);cursor:pointer" onclick="registrarInteresse(\'mentoria\',\''+turmaOrigem+'\')">' +
    '<div style="font-weight:800;color:var(--purple);margin-bottom:4px">üöÄ Mentoria em Projetos de An√°lise de Dados</div>' +
    '<div style="font-size:.84rem;color:var(--soft)">Acompanhamento personalizado para criar projetos reais de an√°lise e montar seu portf√≥lio.</div>' +
    '<div style="font-size:.8rem;color:var(--purple);margin-top:8px;font-weight:700">üëÜ Tenho interesse</div>' +
    '</div>' +
    '</div>' +
    '<button class="btn bg2" style="width:100%" onclick="closeModal()">Agora n√£o, obrigado</button>'
  );
}
window.registrarInteresse=async function(curso,turmaOrigem){
  if(sb&&CU){
    await sb.from('upsell_interesse').insert({user_id:CU.id,nome_aluno:CU.nome,turma_origem:turmaOrigem,curso_interesse:curso,registrado_em:new Date().toISOString()});
  }
  closeModal();
  const nomes={powerbi:'Power BI',mentoria:'Mentoria em Projetos'};
  showModal(
    '<div style="text-align:center;padding:16px 0">' +
    '<div style="font-size:2.5rem;margin-bottom:10px">‚úÖ</div>' +
    '<div style="font-family:var(--fd);font-size:1.1rem;color:var(--green);font-weight:800;margin-bottom:8px">Interesse registrado!</div>' +
    '<div style="font-size:.9rem;color:var(--soft);line-height:1.7">Registramos seu interesse em <strong style="color:var(--cyan)">' + (nomes[curso]||curso) + '</strong>.<br/>Em breve entraremos em contato com mais detalhes.</div>' +
    '<button class="btn bp" style="margin-top:18px;width:100%" onclick="closeModal()">Perfeito!</button>' +
    '</div>'
  );
};
function gerarCertificadoHTML(nome,turma,dataAprov,horas,dataEmissao,certId){
  certId=certId||genId().toUpperCase();
  const w=window.open('','_blank','width=1050,height=750');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"/><title>Certificado ESC ‚Äî ${nome}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#0a0a14;display:grid;place-items:center;min-height:100vh;font-family:'EB Garamond',serif}
    .cert{width:960px;min-height:660px;background:linear-gradient(135deg,#0d0d20 0%,#0f0f24 50%,#0b0b1a 100%);border:2px solid rgba(0,200,255,.25);border-radius:4px;padding:58px 72px;position:relative;overflow:hidden}
    .cert::before{content:'';position:absolute;inset:-1px;background:linear-gradient(135deg,rgba(0,200,255,.3),transparent 40%,transparent 60%,rgba(124,92,252,.3));border-radius:4px;z-index:0;pointer-events:none}
    .cert::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;height:500px;background:radial-gradient(ellipse,rgba(0,200,255,.04) 0%,transparent 70%);pointer-events:none}
    .inner{position:relative;z-index:1;text-align:center}
    .logo-area{margin-bottom:28px;display:flex;align-items:center;justify-content:center;gap:12px}
    .logo-icon{width:48px;height:48px;background:linear-gradient(135deg,#00c8ff,#7c5cfc);border-radius:10px;display:grid;place-items:center;font-size:1.5rem;font-weight:900;color:#fff;font-family:'Cinzel',serif}
    .logo-txt{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:800;background:linear-gradient(90deg,#00c8ff,#7c5cfc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .border-line{width:240px;height:1px;background:linear-gradient(90deg,transparent,rgba(0,200,255,.5),transparent);margin:0 auto 32px}
    .cert-title{font-family:'Cinzel',serif;font-size:.9rem;letter-spacing:.4em;color:rgba(0,200,255,.7);text-transform:uppercase;margin-bottom:18px}
    .cert-declares{font-size:1rem;color:rgba(255,255,255,.55);margin-bottom:12px;font-style:italic}
    .cert-name{font-family:'Cinzel',serif;font-size:2.6rem;font-weight:800;background:linear-gradient(90deg,#00c8ff,#bff6ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:14px;line-height:1.2}
    .cert-text{font-size:1.05rem;color:rgba(255,255,255,.7);line-height:1.8;max-width:640px;margin:0 auto 20px}
    .cert-course{font-size:1.3rem;font-weight:600;color:#bff6ff;font-style:italic;margin-bottom:6px}
    .cert-detail{font-size:.9rem;color:rgba(255,255,255,.45);margin-bottom:36px}
    .border-line2{width:380px;height:1px;background:linear-gradient(90deg,transparent,rgba(124,92,252,.4),rgba(0,200,255,.4),transparent);margin:0 auto 32px}
    .cert-footer{display:flex;justify-content:space-between;align-items:flex-end;padding-top:24px;border-top:1px solid rgba(255,255,255,.07)}
    .sign-block{text-align:center}
    .sign-line{width:160px;height:1px;background:rgba(255,255,255,.3);margin-bottom:8px}
    .sign-name{font-family:'Cinzel',serif;font-size:.82rem;color:rgba(255,255,255,.7);letter-spacing:.1em}
    .sign-role{font-size:.75rem;color:rgba(255,255,255,.35);margin-top:3px}
    .cert-id{font-size:.7rem;color:rgba(255,255,255,.2);letter-spacing:.05em}
    .ornament{position:absolute;opacity:.04;font-size:280px;color:#00c8ff;font-family:'Cinzel',serif;top:50%;left:50%;transform:translate(-50%,-52%);pointer-events:none;user-select:none;font-weight:800}
    @media print{body{background:#fff}.cert{border-color:#ddd}.cert::before,.cert::after,.ornament{display:none}}
  </style></head><body>
  <div class="cert">
    <div class="ornament">ESC</div>
    <div class="inner">
      <div class="logo-area"><div class="logo-icon">E</div><div class="logo-txt">ESC Plataforma</div></div>
      <div class="border-line"></div>
      <div class="cert-title">Certificado de Conclus√£o</div>
      <div class="cert-declares">Este certificado atesta que</div>
      <div class="cert-name">${nome}</div>
      <div class="cert-text">concluiu com √™xito o curso de forma√ß√£o, apresentou e teve aprovado o projeto final referente √† turma</div>
      <div class="cert-course">${turma}</div>
      <div class="cert-detail">Carga hor√°ria: ${horas}h ‚Ä¢ Projeto aprovado em ${dataAprov}</div>
      <div class="border-line2"></div>
      <div class="cert-footer">
        <div class="sign-block"><div class="sign-line"></div><div class="sign-name">ESC Educa√ß√£o</div><div class="sign-role">Coordena√ß√£o</div></div>
        <div class="cert-id">Emitido em ${fd(dataEmissao||new Date())}<br/>ID: ${certId}</div>
        <div class="sign-block"><div class="sign-line"></div><div class="sign-name">${nome}</div><div class="sign-role">Concluinte</div></div>
      </div>
    </div>
  </div>
  <div style="text-align:center;margin-top:18px"><button onclick="window.print()" style="background:linear-gradient(135deg,#00c8ff,#7c5cfc);border:none;color:#fff;padding:10px 28px;border-radius:8px;font-size:.95rem;cursor:pointer;font-weight:700">üñ®Ô∏è Imprimir / Salvar PDF</button></div>
  </body></html>`);
  w.document.close();
}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
async function showAdmin(){
  $('#ls').style.display='none';$('#aa').classList.remove('hidden');
  $$('.ani').forEach(i=>i.addEventListener('click',()=>{
    $$('.ani').forEach(x=>x.classList.remove('act'));i.classList.add('act');
    $$('#aa .page').forEach(p=>p.classList.remove('act'));
    const adm=i.dataset.adm;document.getElementById(`adm-${adm}`).classList.add('act');
    const fns={dash:loadADash,pend:loadPend,alunos:loadAAlunos,turmas:loadATurmas,mods:loadAMods,aulas:loadAAulas,mats:loadAMats,quiz:loadAQuiz,qstats:loadQStats,projetos:loadAProjetos,live:loadALive,mural:loadAMural,forum:loadAForum,aval:loadAvalAdmin};
    if(fns[adm])fns[adm]();
  }));
  await loadADash();await loadPend();await checkResetRequests();
  // Start admin notification polling
  setTimeout(pollAdminNotifs,1500);
}

/* ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ */
async function loadADash(){
  if(!sb)return;
  const[{data:al},{data:pe},{data:mo}]=await Promise.all([sb.from('users').select('*,turmas(nome)').eq('role','student').eq('status','active'),sb.from('users').select('id').eq('status','pending'),sb.from('modules').select('id')]);
  const alunos=al||[],pc=(pe||[]).length,mc=(mo||[]).length;
  $('#aA').textContent=alunos.length;$('#aP').textContent=pc;$('#aMo').textContent=mc;
  if(pc>0){$('#pBadge').textContent=pc;$('#pBadge').classList.remove('hidden');}else $('#pBadge').classList.add('hidden');
  let tot=0;
  for(const a of alunos){const{data:pr}=await sb.from('progress').select('concluido').eq('user_id',a.id);tot+=pct((pr||[]).filter(x=>x.concluido).length,mc);}
  $('#aMd').textContent=alunos.length?Math.round(tot/alunos.length)+'%':'0%';
  const tb=$('#aDT');tb.innerHTML='';
  for(const a of alunos){
    const{data:pr}=await sb.from('progress').select('concluido').eq('user_id',a.id);
    const dn=(pr||[]).filter(x=>x.concluido).length,p2=pct(dn,mc),d2=du(a.validade_acesso),dc=d2!==null&&d2<=30?'color:var(--amber)':'';
    tb.innerHTML+=`<tr><td><strong>${a.nome}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${a.login}</span></td><td><span class="badge bc">${a.turmas?.nome||'‚Äî'}</span></td><td><div style="display:flex;align-items:center;gap:7px"><div class="pw" style="width:75px"><div class="pf" style="width:${p2}%"></div></div><span style="font-size:.82rem;font-weight:700">${p2}%</span></div></td><td>${dn}/${mc}</td><td class="${dc}" style="font-size:.85rem">${fd(a.validade_acesso)}</td><td><span class="badge bg3">Ativo</span></td></tr>`;
  }
}

/* ‚îÄ‚îÄ ADMIN PENDENTES ‚îÄ‚îÄ */
async function loadPend(){
  if(!sb)return;
  const{data}=await sb.from('users').select('*').eq('status','pending').order('criado_em');
  const c2=$('#pendCont');
  if(!data?.length){c2.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">‚úÖ Nenhuma solicita√ß√£o pendente.</div>';return;}
  const{data:turmas}=await sb.from('turmas').select('*').eq('ativa',true);
  const to=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  c2.innerHTML=`<div style="font-weight:800;color:var(--cyan);margin-bottom:13px">üîî ${data.length} solicita√ß√£o(√µes)</div>`;
  data.forEach(u=>{
    const d2=document.createElement('div');d2.style.cssText='border:1px solid var(--border);border-radius:var(--r);padding:15px;margin-bottom:11px;background:rgba(0,0,0,.18)';
    d2.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:11px"><div><div style="font-weight:800">${u.nome}</div><div style="font-size:.82rem;color:var(--muted)">${u.email||''} ¬∑ ${u.login}</div></div><div style="font-size:.75rem;color:var(--muted)">${fd(u.criado_em)}</div></div><div style="display:flex;gap:9px;flex-wrap:wrap;align-items:center"><select id="ts-${u.id}" class="fi" style="width:auto;min-width:180px"><option value="">Sem turma</option>${to}</select><input type="number" id="ms-${u.id}" class="fi" value="12" min="1" style="width:95px"/><button class="btn bs" onclick="aprovA('${u.id}')">‚úÖ Aprovar</button><button class="btn bd" onclick="rejA('${u.id}')">‚ùå Rejeitar</button></div>`;
    c2.appendChild(d2);
  });
}
window.aprovA=async function(id){
  const ti=document.getElementById('ts-'+id)?.value||null,ms=parseInt(document.getElementById('ms-'+id)?.value)||12;
  const v=new Date();v.setMonth(v.getMonth()+ms);
  await sb.from('users').update({status:'active',turma_id:ti||null,validade_acesso:v.toISOString(),meses_acesso:ms}).eq('id',id);
  toast('‚úÖ Aluno aprovado!','s');loadPend();loadADash();
};
window.rejA=async function(id){if(!confirm('Rejeitar?'))return;await sb.from('users').update({status:'blocked'}).eq('id',id);toast('Rejeitado.','i');loadPend();};

/* ‚îÄ‚îÄ ADMIN RESET DE SENHA ‚îÄ‚îÄ */
async function checkResetRequests(){
  if(!sb)return;
  const{data}=await sb.from('reset_requests').select('*,users(nome,login,email)').eq('resolvido',false).order('solicitado_em',{ascending:false});
  if(!data?.length)return;
  // Show badge on Pendentes or a toast
  toast(`üîë ${data.length} solicita√ß√£o(√µes) de redefini√ß√£o de senha pendente(s). Verifique em Pendentes.`,'w');
  // Append to pendCont if it's visible
  const c2=$('#pendCont');
  if(!c2)return;
  const secTitle=document.createElement('div');
  secTitle.style.cssText='font-weight:800;color:var(--amber);margin:18px 0 10px;display:flex;align-items:center;gap:8px';
  secTitle.innerHTML='üîë Redefini√ß√µes de Senha Solicitadas';
  c2.appendChild(secTitle);
  data.forEach(req=>{
    const d2=document.createElement('div');
    d2.style.cssText='border:1px solid rgba(245,158,11,.3);border-radius:var(--r);padding:14px;margin-bottom:10px;background:rgba(245,158,11,.04)';
    d2.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px"><div><div style="font-weight:800">${req.users?.nome||req.nome||'?'}</div><div style="font-size:.82rem;color:var(--muted)">@${req.users?.login||'?'} ¬∑ ${req.users?.email||req.email||'?'}</div><div style="font-size:.75rem;color:var(--muted);margin-top:2px">Solicitado: ${fdt(req.solicitado_em)}</div></div></div><div style="display:flex;gap:9px;align-items:center"><input type="password" id="rs-${req.id}" class="fi" placeholder="Nova senha (m√≠n. 6 chars)" style="max-width:220px"/><button class="btn bp btn-sm" onclick="resolverReset('${req.id}','${req.user_id}')">‚úÖ Redefinir</button><button class="btn bg2 btn-sm" onclick="dispensarReset('${req.id}')">‚úñ</button></div>`;
    c2.appendChild(d2);
  });
}
window.resolverReset=async function(reqId,userId){
  const pw=document.getElementById('rs-'+reqId)?.value?.trim();
  if(!pw||pw.length<6){toast('‚ö†Ô∏è Senha m√≠nimo 6 caracteres.','w');return;}
  const hash=await sha(pw);
  await sb.from('users').update({senha:hash,session_token:null}).eq('id',userId);
  await sb.from('reset_requests').update({resolvido:true,resolvido_em:new Date().toISOString()}).eq('id',reqId);
  toast('‚úÖ Senha redefinida com sucesso!','s');loadPend();checkResetRequests();
};
window.dispensarReset=async function(reqId){
  await sb.from('reset_requests').update({resolvido:true}).eq('id',reqId);
  toast('Solicita√ß√£o dispensada.','i');loadPend();
};

/* ‚îÄ‚îÄ ADMIN ALUNOS ‚îÄ‚îÄ */
async function loadAAlunos(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*');
  const opts=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  $('#aTurma').innerHTML='<option value="">Sem turma</option>'+opts;
  const{data:al}=await sb.from('users').select('*,turmas(nome)').eq('role','student').order('criado_em',{ascending:false});
  $('#aAT').innerHTML=(al||[]).map(a=>{const d2=du(a.validade_acesso),sb2={active:'bg3',pending:'ba',expired:'br',blocked:'br'}[a.status]||'bw2';return `<tr><td><strong>${a.nome}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${a.login}</span></td><td>${a.email||''}</td><td>${a.turmas?.nome||'‚Äî'}</td><td style="${d2!==null&&d2<=30?'color:var(--amber)':''}">${fd(a.validade_acesso)}</td><td><span class="badge ${sb2}">${a.status}</span></td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="editA('${a.id}')">‚úèÔ∏è</button><button class="btn bd btn-xs" onclick="delA('${a.id}')">üóëÔ∏è</button></td></tr>`;}).join('');
  // Setup tab switching
  $$('.alunoTab').forEach(btn=>btn.addEventListener('click',function(){
    $$('.alunoTab').forEach(x=>x.classList.remove('act'));this.classList.add('act');
    ['lista','certs','historico','upsell'].forEach(id=>document.getElementById('at-'+id).style.display='none');
    const tab=this.dataset.at;document.getElementById('at-'+tab).style.display='';
    if(tab==='certs')loadCertificadosAdmin();
    if(tab==='historico')loadHistoricoAdmin();
    if(tab==='upsell')loadUpsellAdmin();
  }));
}
async function loadCertificadosAdmin(){
  const l=$('#certList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  const{data:certs}=await sb.from('certificados').select('*,users(nome,login),turmas(nome)').order('emitido_em',{ascending:false});
  if(!certs?.length){l.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üèÜ Nenhum certificado emitido ainda.</div>';return;}
  l.innerHTML='<div class="tw2"><table><thead><tr><th>Aluno</th><th>Turma</th><th>Carga H.</th><th>Emitido em</th><th>ID Cert.</th><th></th></tr></thead><tbody>'+
    certs.map(c=>`<tr><td><strong>${c.users?.nome||'?'}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${c.users?.login||'?'}</span></td><td><span class="badge bc">${c.turmas?.nome||'?'}</span></td><td>${c.carga_horaria||0}h</td><td>${fdt(c.emitido_em)}</td><td style="font-family:monospace;font-size:.78rem;color:var(--cyan)">${c.cert_id||'‚Äî'}</td><td><button class="btn bg2 btn-xs" onclick="verCertAdmin('${c.id}')">üèÜ Ver</button></td></tr>`).join('')+
    '</tbody></table></div>';
}
window.verCertAdmin=async function(id){
  const{data:cert}=await sb.from('certificados').select('*,users(nome),turmas(nome)').eq('id',id).single();
  if(!cert)return;
  gerarCertificadoHTML(cert.users?.nome||cert.nome_aluno,cert.turmas?.nome||cert.nome_turma,fd(cert.aprovado_em),cert.carga_horaria||0,cert.emitido_em,cert.cert_id);
};
async function loadHistoricoAdmin(){
  const l=$('#histList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  // Get all students with their turmas history (from projetos aprovados)
  const{data:al}=await sb.from('users').select('id,nome,login').eq('role','student').order('nome');
  if(!al?.length){l.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">Nenhum aluno.</div>';return;}
  const{data:certs}=await sb.from('certificados').select('*,turmas(nome)');
  const certsByUser={};(certs||[]).forEach(c=>{if(!certsByUser[c.user_id])certsByUser[c.user_id]=[];certsByUser[c.user_id].push(c);});
  const{data:projs}=await sb.from('projetos').select('*,turmas(nome)').eq('status','aprovado');
  const projsByUser={};(projs||[]).forEach(p=>{if(!projsByUser[p.user_id])projsByUser[p.user_id]=[];projsByUser[p.user_id].push(p);});
  l.innerHTML='<div style="display:flex;flex-direction:column;gap:10px">'+
    al.map(a=>{
      const userCerts=certsByUser[a.id]||[];
      const userProjs=projsByUser[a.id]||[];
      const allTurmas=[...new Set([...userCerts.map(c=>c.turmas?.nome||c.nome_turma),...userProjs.map(p=>p.turmas?.nome||'?')])].filter(Boolean);
      return `<div style="border:1px solid var(--border);border-radius:var(--r);padding:13px;background:rgba(0,0,0,.18)">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div><div style="font-weight:800">${a.nome} <span style="font-size:.78rem;color:var(--muted);font-weight:400">@${a.login}</span></div>
          <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:5px">${allTurmas.length?allTurmas.map(t=>`<span class="badge bc">${t}</span>`).join(''):'<span style="font-size:.8rem;color:var(--muted)">Sem cursos conclu√≠dos</span>'}</div></div>
          <div style="text-align:right;flex-shrink:0"><div style="font-size:1.3rem;font-weight:900;color:var(--cyan)">${userCerts.length}</div><div style="font-size:.72rem;color:var(--muted)">certificado(s)</div></div>
        </div>
      </div>`;
    }).join('')+'</div>';
}
async function loadUpsellAdmin(){
  const l=$('#upsellList');l.innerHTML='<div style="color:var(--muted)">Carregando...</div>';
  const{data:interesse}=await sb.from('upsell_interesse').select('*,users(nome,login)').order('registrado_em',{ascending:false});
  if(!interesse?.length){l.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üí° Nenhum interesse registrado ainda.</div>';return;}
  const powerbi=interesse.filter(x=>x.curso_interesse==='powerbi');
  const mentoria=interesse.filter(x=>x.curso_interesse==='mentoria');
  l.innerHTML=
    `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div class="card cp" style="text-align:center"><div style="font-size:1.8rem;font-weight:900;color:var(--cyan)">${powerbi.length}</div><div style="font-size:.8rem;color:var(--muted);margin-top:3px">Interesse Power BI</div></div>
      <div class="card cp" style="text-align:center"><div style="font-size:1.8rem;font-weight:900;color:var(--purple)">${mentoria.length}</div><div style="font-size:.8rem;color:var(--muted);margin-top:3px">Interesse Mentoria</div></div>
    </div>`+
    '<div class="tw2"><table><thead><tr><th>Aluno</th><th>Turma Origem</th><th>Curso Interesse</th><th>Data</th></tr></thead><tbody>'+
    interesse.map(i=>`<tr><td><strong>${i.users?.nome||i.nome_aluno||'?'}</strong><br/><span style="font-size:.75rem;color:var(--muted)">${i.users?.login||'?'}</span></td><td>${i.turma_origem||'‚Äî'}</td><td><span class="badge ${i.curso_interesse==='powerbi'?'bc':'bpp'}">${i.curso_interesse==='powerbi'?'üìä Power BI':'üöÄ Mentoria'}</span></td><td style="font-size:.82rem;color:var(--muted)">${fdt(i.registrado_em)}</td></tr>`).join('')+
    '</tbody></table></div>';
}
$('#bCA').addEventListener('click',async()=>{
  const n=$('#aNome').value.trim(),e=$('#aEmail').value.trim(),l=$('#aLogin').value.trim(),p=$('#aPass').value.trim(),ti=$('#aTurma').value,ms=parseInt($('#aMes').value)||12;
  if(!n||!e||!l||!p){toast('‚ö†Ô∏è Preencha todos os campos.','w');return;}
  const hash=await sha(p),v=new Date();v.setMonth(v.getMonth()+ms);
  const{error}=await sb.from('users').insert({nome:n,email:e,login:l,senha:hash,role:'student',status:'active',turma_id:ti||null,validade_acesso:v.toISOString(),meses_acesso:ms});
  if(error){toast('‚ùå '+error.message,'e');return;}
  toast('‚úÖ Aluno criado!','s');['aNome','aEmail','aLogin','aPass'].forEach(id=>document.getElementById(id).value='');$('#aMes').value='12';loadAAlunos();
});
window.editA=async function(id){
  const{data:a}=await sb.from('users').select('*').eq('id',id).single();
  const{data:turmas}=await sb.from('turmas').select('*');
  const opts=(turmas||[]).map(t=>`<option value="${t.id}"${a.turma_id===t.id?' selected':''}>${t.nome}</option>`).join('');
  showModal('<div class="mtt">‚úèÔ∏è Editar: '+a.nome+'</div><div class="fg" style="margin-bottom:12px"><label class="fl">Turma</label><select id="eTurma" class="fi"><option value="">Sem turma</option>'+opts+'</select></div><div class="fg" style="margin-bottom:12px"><label class="fl">Status</label><select id="eStatus" class="fi"><option value="active"'+(a.status==='active'?' selected':'')+'>Ativo</option><option value="blocked"'+(a.status==='blocked'?' selected':'')+'>Bloqueado</option></select></div><div class="fg" style="margin-bottom:12px"><label class="fl">Meses de acesso</label><input id="eMes" class="fi" type="number" value="'+(a.meses_acesso||12)+'" min="1"/></div><div class="fg" style="margin-bottom:16px"><label class="fl">Nova senha (vazio = n√£o altera)</label><input id="ePass" class="fi" type="password"/></div><div style="display:flex;gap:9px"><button class="btn bp" onclick="saveA(\''+id+'\')">üíæ Salvar</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>');
};
window.saveA=async function(id){
  const ti=$('#eTurma').value,st=$('#eStatus').value,ms=parseInt($('#eMes').value)||12,np=$('#ePass').value.trim();
  const v=new Date();v.setMonth(v.getMonth()+ms);
  const pay={turma_id:ti||null,status:st,validade_acesso:v.toISOString(),meses_acesso:ms};
  if(np&&np.length>=6)pay.senha=await sha(np);
  await sb.from('users').update(pay).eq('id',id);
  toast('‚úÖ Atualizado!','s');closeModal();loadAAlunos();loadADash();
};
window.delA=async function(id){
  if(!confirm('Remover aluno?'))return;
  await Promise.all([sb.from('progress').delete().eq('user_id',id),sb.from('notes').delete().eq('user_id',id)]);
  await sb.from('users').delete().eq('id',id);toast('üóëÔ∏è Removido.','i');loadAAlunos();loadADash();
};

/* ‚îÄ‚îÄ ADMIN TURMAS ‚îÄ‚îÄ */
async function loadATurmas(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*').order('criado_em');
  const tb=$('#aTT');tb.innerHTML='';
  for(const t of turmas||[]){
    const[{data:al},{data:mo}]=await Promise.all([sb.from('users').select('id').eq('turma_id',t.id).eq('status','active'),sb.from('modules').select('id').eq('turma_id',t.id)]);
    tb.innerHTML+=`<tr><td><strong>${t.nome}</strong><br/><span style="font-size:.78rem;color:var(--muted)">${t.descricao||''}</span></td><td>${(al||[]).length}</td><td>${(mo||[]).length}</td><td><span class="badge ${t.ativa?'bg3':'bw2'}">${t.ativa?'Ativa':'Inativa'}</span></td><td><span class="badge ${t.tem_projeto?'bpp':'bw2'}">${t.tem_projeto?'Sim':'N√£o'}</span></td><td style="display:flex;gap:5px"><button class="btn bg2 btn-xs" onclick="editT('${t.id}')">‚úèÔ∏è</button><button class="btn bg2 btn-xs" onclick="togT('${t.id}',${!t.ativa})">${t.ativa?'‚è∏Ô∏è':'‚ñ∂Ô∏è'}</button><button class="btn bd btn-xs" onclick="delT('${t.id}')">üóëÔ∏è</button></td></tr>`;
  }
}
$('#bST').addEventListener('click',async()=>{
  const n=$('#tNome').value.trim(),d=$('#tDesc').value.trim(),tp=$('#tProjeto')?.checked||false;
  if(!n){toast('‚ö†Ô∏è Nome obrigat√≥rio.','w');return;}
  await sb.from('turmas').insert({nome:n,descricao:d,ativa:true,tem_projeto:tp});
  toast('‚úÖ Turma criada!','s');$('#tNome').value='';$('#tDesc').value='';if($('#tProjeto'))$('#tProjeto').checked=false;loadATurmas();loadTurmaSelects();
});
window.editT=async function(id){
  const{data:t}=await sb.from('turmas').select('*').eq('id',id).single();
  showModal('<div class="mtt">‚úèÔ∏è Editar Turma</div><div class="fg" style="margin-bottom:12px"><label class="fl">Nome</label><input id="etNome" class="fi" value="'+t.nome+'"/></div><div class="fg" style="margin-bottom:12px"><label class="fl">Descri√ß√£o</label><input id="etDesc" class="fi" value="'+(t.descricao||'')+'"/></div><div class="fg" style="margin-bottom:12px"><label class="fl">Instru√ß√µes do projeto</label><textarea id="etProjInst" class="fi" rows="4" placeholder="Instru√ß√µes para os alunos sobre o projeto final...">'+(t.projeto_instrucoes||'')+'</textarea></div><div class="fg" style="margin-bottom:16px;display:flex;align-items:center;gap:10px"><input type="checkbox" id="etProjeto" style="accent-color:var(--cyan);width:18px;height:18px"'+(t.tem_projeto?' checked':'')+'/><label for="etProjeto" class="fl" style="margin:0">Possui m√≥dulo de projeto final</label></div><div style="display:flex;gap:9px"><button class="btn bp" onclick="saveT(\''+id+'\')">üíæ Salvar</button><button class="btn bg2" onclick="closeModal()">Cancelar</button></div>');
};
window.saveT=async function(id){
  const n=document.getElementById('etNome').value.trim(),d=document.getElementById('etDesc').value.trim(),pi=document.getElementById('etProjInst').value.trim(),tp=document.getElementById('etProjeto').checked;
  await sb.from('turmas').update({nome:n,descricao:d,projeto_instrucoes:pi,tem_projeto:tp}).eq('id',id);
  toast('‚úÖ Turma atualizada!','s');closeModal();loadATurmas();loadTurmaSelects();
};
window.togT=async function(id,a){await sb.from('turmas').update({ativa:a}).eq('id',id);loadATurmas();};
window.delT=async function(id){if(!confirm('Excluir turma e todos os m√≥dulos?'))return;await sb.from('turmas').delete().eq('id',id);toast('üóëÔ∏è Exclu√≠da.','i');loadATurmas();};
async function loadTurmaSelects(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*').eq('ativa',true);
  const opts=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  ['mTur','aTurma','aulaModuloTurma','lvTurma','cdTurma','mrTurma','projFiltro'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const pre=id==='aTurma'?'<option value="">Sem turma</option>':id==='mrTurma'||id==='projFiltro'?'<option value="">Todas as turmas</option>':'<option value="">Selecione...</option>';
    el.innerHTML=pre+opts;
  });
}

/* ‚îÄ‚îÄ ADMIN M√ìDULOS ‚îÄ‚îÄ */
async function loadAMods(){
  if(!sb)return;await loadTurmaSelects();
  const{data:mds}=await sb.from('modules').select('*,turmas(nome)').order('ordem');
  $('#aMT2').innerHTML=(mds||[]).map(m=>`<tr><td>${m.ordem}</td><td><strong>${m.icone} ${m.titulo}</strong></td><td><span class="badge bc">${m.turmas?.nome||'‚Äî'}</span></td><td><span class="badge bpp">${m.video_type||'‚Äî'}</span></td><td>${Math.round((m.duracao_seg||0)/60)}min</td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="editM('${m.id}')">‚úèÔ∏è</button><button class="btn bd btn-xs" onclick="delM('${m.id}')">üóëÔ∏è</button></td></tr>`).join('');
}
$('#bSM').addEventListener('click',async()=>{
  const tt=$('#mTit').value.trim(),ic=$('#mIco').value.trim()||'üìñ',tu=$('#mTur').value,vt=$('#mVT').value,vu=$('#mVU').value.trim(),dur=(parseInt($('#mDur').value)||0)*60,ord=parseInt($('#mOrd').value)||1,top=$('#mTop').value.trim(),eid=$('#mEId').value;
  if(!tt||!tu){toast('‚ö†Ô∏è T√≠tulo e turma obrigat√≥rios.','w');return;}
  if(eid){await sb.from('modules').update({titulo:tt,icone:ic,turma_id:tu,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true}).eq('id',eid);toast('‚úÖ M√≥dulo atualizado!','s');}
  else{await sb.from('modules').insert({titulo:tt,icone:ic,turma_id:tu,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true});toast('‚úÖ M√≥dulo criado!','s');}
  clearMF();loadAMods();loadAAulas();
});
$('#bCM').addEventListener('click',clearMF);
function clearMF(){['mTit','mIco','mVU','mDur','mOrd','mTop','mEId'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});$('#mVT').value='youtube';}
window.editM=async function(id){
  const{data:m}=await sb.from('modules').select('*').eq('id',id).single();
  $('#mTit').value=m.titulo;$('#mIco').value=m.icone||'üìñ';$('#mTur').value=m.turma_id||'';$('#mVT').value=m.video_type||'youtube';
  $('#mVU').value=m.video_url||'';$('#mDur').value=Math.round((m.duracao_seg||0)/60);$('#mOrd').value=m.ordem||1;$('#mTop').value=m.topicos||'';$('#mEId').value=m.id;
  toast('üìù Editando: '+m.titulo,'i');
};
window.delM=async function(id){if(!confirm('Excluir m√≥dulo e aulas?'))return;await sb.from('aulas').delete().eq('modulo_id',id);await sb.from('modules').delete().eq('id',id);toast('üóëÔ∏è Exclu√≠do.','i');loadAMods();};

/* ‚îÄ‚îÄ ADMIN AULAS ‚îÄ‚îÄ */
async function loadAAulas(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone,turmas(nome)').order('ordem');
  const modOpts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo} (${m.turmas?.nome||'?'})</option>`).join('');
  $('#aulaModulo').innerHTML='<option value="">Selecione o m√≥dulo...</option>'+modOpts;
  $('#aulaFiltro').innerHTML='<option value="">Todos os m√≥dulos</option>'+modOpts;
  const filtro=$('#aulaFiltro').value;
  let q=sb.from('aulas').select('*,modules(titulo,turmas(nome))').order('ordem');
  if(filtro)q=q.eq('modulo_id',filtro);
  const{data:aulas}=await q;
  $('#aulasTable').innerHTML=(aulas||[]).map(a=>`<tr><td>${a.ordem}</td><td><strong>${a.icone||'üé¨'} ${a.titulo}</strong></td><td><span class="badge bc">${a.modules?.titulo||'‚Äî'} <span style="opacity:.6">(${a.modules?.turmas?.nome||'?'})</span></span></td><td><span class="badge bpp">${a.video_type}</span></td><td>${Math.round((a.duracao_seg||0)/60)}min</td><td style="display:flex;gap:6px"><button class="btn bg2 btn-xs" onclick="editAula('${a.id}')">‚úèÔ∏è</button><button class="btn bd btn-xs" onclick="delAula('${a.id}')">üóëÔ∏è</button></td></tr>`).join('');
}
$('#aulaFiltro').addEventListener('change',loadAAulas);
$('#bSAula').addEventListener('click',async()=>{
  const mo=$('#aulaModulo').value,tt=$('#aulaTit').value.trim(),ic=$('#aulaIco').value.trim()||'üé¨',vt=$('#aulaVT').value,vu=$('#aulaVU').value.trim(),dur=(parseInt($('#aulaDur').value)||0)*60,ord=parseInt($('#aulaOrd').value)||1,top=$('#aulaTop').value.trim(),eid=$('#aulaEId').value;
  if(!mo||!tt){toast('‚ö†Ô∏è M√≥dulo e t√≠tulo obrigat√≥rios.','w');return;}
  if(eid){await sb.from('aulas').update({modulo_id:mo,titulo:tt,icone:ic,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true}).eq('id',eid);toast('‚úÖ Aula atualizada!','s');}
  else{await sb.from('aulas').insert({modulo_id:mo,titulo:tt,icone:ic,video_type:vt,video_url:vu,duracao_seg:dur,topicos:top,ordem:ord,ativo:true});toast('‚úÖ Aula criada!','s');}
  clearAulaF();loadAAulas();
});
$('#bCAula').addEventListener('click',clearAulaF);
function clearAulaF(){['aulaTit','aulaIco','aulaVU','aulaDur','aulaOrd','aulaTop','aulaEId'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});$('#aulaVT').value='youtube';$('#aulaModulo').value='';}
window.editAula=async function(id){
  const{data:a}=await sb.from('aulas').select('*').eq('id',id).single();
  $('#aulaModulo').value=a.modulo_id||'';$('#aulaTit').value=a.titulo;$('#aulaIco').value=a.icone||'üé¨';
  $('#aulaVT').value=a.video_type||'youtube';$('#aulaVU').value=a.video_url||'';
  $('#aulaDur').value=Math.round((a.duracao_seg||0)/60);$('#aulaOrd').value=a.ordem||1;$('#aulaTop').value=a.topicos||'';$('#aulaEId').value=a.id;
  toast('üìù Editando: '+a.titulo,'i');
  document.querySelector('[data-adm="aulas"]').click();
};
window.delAula=async function(id){if(!confirm('Excluir aula?'))return;await sb.from('aulas').delete().eq('id',id);toast('üóëÔ∏è Exclu√≠da.','i');loadAAulas();};

/* ‚îÄ‚îÄ ADMIN MATERIAIS ‚îÄ‚îÄ */
async function loadAMats(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone');
  const opts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  $('#matM').innerHTML='<option value="">Todos os m√≥dulos</option>'+opts;
  const{data:mats}=await sb.from('materials').select('*,modules(titulo)').order('criado_em',{ascending:false});
  $('#aMatT').innerHTML=(mats||[]).map(m=>`<tr><td><strong>${ti(m.tipo)} ${m.nome}</strong><br/><span style="font-size:.78rem;color:var(--muted)">${m.descricao||''}</span></td><td><span class="badge bc">${m.tipo}</span></td><td>${m.modules?.titulo||'Todos'}</td><td><a href="${m.url}" target="_blank" style="color:var(--cyan);font-size:.78rem;word-break:break-all">${m.url.substring(0,40)}</a></td><td><button class="btn bd btn-xs" onclick="delMat('${m.id}')">üóëÔ∏è</button></td></tr>`).join('');
}
$('#bSMat').addEventListener('click',async()=>{
  const n=$('#matN').value.trim(),t2=$('#matT').value,u=$('#matU').value.trim(),d=$('#matD').value.trim(),m=$('#matM').value;
  if(!n||!u){toast('‚ö†Ô∏è Nome e URL obrigat√≥rios.','w');return;}
  await sb.from('materials').insert({nome:n,tipo:t2,url:u,descricao:d,modulo_id:m||null});
  toast('‚úÖ Material adicionado!','s');['matN','matU','matD'].forEach(id=>document.getElementById(id).value='');$('#matM').value='';loadAMats();
});
window.delMat=async function(id){if(!confirm('Remover?'))return;await sb.from('materials').delete().eq('id',id);toast('üóëÔ∏è Removido.','i');loadAMats();};

/* ‚îÄ‚îÄ ADMIN QUIZ ‚îÄ‚îÄ */
async function loadAQuiz(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone');
  const opts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  $('#qMod').innerHTML='<option value="">Geral (todos)</option>'+opts;
  const{data:qs}=await sb.from('quiz').select('*,modules(titulo)').order('criado_em',{ascending:false});
  const l=$('#aQL');
  if(!qs?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma quest√£o.</div>';return;}
  l.innerHTML=qs.map((q,i)=>`<div style="border:1px solid var(--border);border-radius:var(--r);padding:15px;background:rgba(0,0,0,.18);margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:11px"><div style="font-weight:800">${i+1}. ${q.question}</div><button class="btn bd btn-xs" onclick="delQ('${q.id}')">üóëÔ∏è</button></div><div style="display:flex;flex-direction:column;gap:5px">${(q.options||[]).map((opt,oi)=>`<div style="padding:7px 11px;border-radius:6px;font-size:.88rem;border:1px solid ${oi===q.correct_option?'var(--green)':'var(--border)'};background:${oi===q.correct_option?'rgba(15,186,129,.1)':'rgba(0,0,0,.18)'}">${String.fromCharCode(65+oi)}) ${opt}${oi===q.correct_option?' ‚úì':''}</div>`).join('')}</div><div style="font-size:.75rem;color:var(--muted);margin-top:8px">M√≥dulo: ${q.modules?.titulo||'Geral'}</div></div>`).join('');
}
$('#bSQ').addEventListener('click',async()=>{
  const q=$('#qEn').value.trim(),o0=$('#qO0').value.trim(),o1=$('#qO1').value.trim(),o2=$('#qO2').value.trim(),cs=document.querySelector('input[name="qC"]:checked'),m=$('#qMod').value;
  if(!q||!o0||!o1||!o2||!cs){toast('‚ö†Ô∏è Preencha tudo e marque a op√ß√£o correta.','w');return;}
  await sb.from('quiz').insert({question:q,options:[o0,o1,o2],correct_option:parseInt(cs.value),modulo_id:m||null});
  toast('‚úÖ Quest√£o adicionada!','s');['qEn','qO0','qO1','qO2'].forEach(id=>document.getElementById(id).value='');document.querySelectorAll('input[name="qC"]').forEach(r=>r.checked=false);loadAQuiz();
});
window.delQ=async function(id){if(!confirm('Excluir?'))return;await sb.from('quiz').delete().eq('id',id);loadAQuiz();};

/* ‚îÄ‚îÄ ADMIN ANALYTICS QUIZ ‚îÄ‚îÄ */
async function loadQStats(){
  if(!sb)return;
  const{data:mds}=await sb.from('modules').select('id,titulo,icone');
  const opts=(mds||[]).map(m=>`<option value="${m.id}">${m.icone} ${m.titulo}</option>`).join('');
  $('#qsFiltroMod').innerHTML='<option value="">Todos os m√≥dulos</option>'+opts;
  await runQStats();
}
$('#bQStats').addEventListener('click',runQStats);
async function runQStats(){
  const filtro=$('#qsFiltroMod').value;
  // Get all quiz questions
  let qQuery=sb.from('quiz').select('*,modules(titulo)').order('criado_em');
  if(filtro)qQuery=qQuery.eq('modulo_id',filtro);
  const{data:qs}=await qQuery;
  if(!qs?.length){$('#qStatsList').innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma quest√£o encontrada.</div>';$('#qStatsResume').innerHTML='';return;}
  // Get all answers
  let rQuery=sb.from('quiz_respostas').select('*,users(nome)');
  if(filtro)rQuery=rQuery.eq('modulo_id',filtro);
  const{data:respostas}=await rQuery;
  const r=respostas||[];
  // Summary cards
  const totalRes=r.length,totalCorretas=r.filter(x=>x.correta).length,totalErros=totalRes-totalCorretas;
  const alunos=[...new Set(r.map(x=>x.user_id))].length;
  const taxaAcerto=totalRes>0?pct(totalCorretas,totalRes):0;
  $('#qStatsResume').innerHTML=[
    ['üë•','Alunos respondentes',alunos,'var(--cyan)'],
    ['üìù','Respostas totais',totalRes,'var(--purple)'],
    ['‚úÖ','Taxa de acerto',taxaAcerto+'%','var(--green)'],
    ['‚ùå','Total de erros',totalErros,'var(--red)']
  ].map(([ic,lb,val,cl])=>`<div class="card cp" style="text-align:center"><div style="font-size:1.6rem;margin-bottom:4px">${ic}</div><div style="font-size:1.5rem;font-weight:900;color:${cl}">${val}</div><div style="font-size:.78rem;color:var(--muted);margin-top:3px">${lb}</div></div>`).join('');
  // Per-question breakdown
  const l=$('#qStatsList');l.innerHTML='';
  for(const q of qs){
    const qResps=r.filter(x=>x.quiz_id===q.id);
    const total=qResps.length,corretas=qResps.filter(x=>x.correta).length,erros=total-corretas;
    const taxa=total>0?pct(corretas,total):0;
    const optCounts=(q.options||[]).map((_,i)=>qResps.filter(x=>x.resposta===i).length);
    const div=document.createElement('div');div.style.cssText='border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:12px;background:rgba(0,0,0,.18)';
    div.innerHTML=`<div style="display:flex;align-items:start;justify-content:space-between;gap:12px;margin-bottom:12px"><div style="font-weight:800;flex:1">${q.question}</div><div style="display:flex;gap:6px;flex-shrink:0"><span class="badge bg3">${taxa}% acertos</span><span class="badge ${erros>0?'br':'bw2'}">${erros} erros</span><span class="badge bw2">${total} resp.</span></div></div><div style="font-size:.8rem;color:var(--muted);margin-bottom:9px">M√≥dulo: ${q.modules?.titulo||'Geral'}</div><div style="display:flex;flex-direction:column;gap:6px">${(q.options||[]).map((opt,oi)=>{const cnt=optCounts[oi]||0,pctOpt=total>0?pct(cnt,total):0,isCorrect=oi===q.correct_option;return `<div style="display:flex;align-items:center;gap:9px"><div style="width:200px;font-size:.84rem;color:${isCorrect?'var(--green)':'var(--soft)'}">${String.fromCharCode(65+oi)}) ${opt}</div><div style="flex:1;height:10px;background:rgba(255,255,255,.05);border-radius:5px;overflow:hidden"><div style="height:100%;background:${isCorrect?'var(--green)':'var(--red)'};width:${pctOpt}%;border-radius:5px;transition:width .5s"></div></div><div style="font-size:.8rem;width:55px;text-align:right;color:${isCorrect?'var(--green)':'var(--muted)'}">${cnt} (${pctOpt}%)</div>${isCorrect?'<span style="font-size:.75rem;color:var(--green)">‚úì</span>':''}</div>`;}).join('')}</div>`;
    l.appendChild(div);
  }
}

/* ‚îÄ‚îÄ ADMIN PROJETOS ‚îÄ‚îÄ */
async function loadAProjetos(){
  if(!sb)return;await loadTurmaSelects();
  const filtroT=$('#projFiltro').value,filtroS=$('#projStatus').value;
  let q=sb.from('projetos').select('*,users(nome,login),turmas(nome)').order('enviado_em',{ascending:false});
  if(filtroT)q=q.eq('turma_id',filtroT);if(filtroS)q=q.eq('status',filtroS);
  const{data:projs}=await q;
  const l=$('#projList');l.innerHTML='';
  if(!projs?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum projeto encontrado.</div>';return;}
  for(const p of projs){
    const statusColors={enviado:'var(--amber)',em_revisao:'var(--cyan)',aprovado:'var(--green)',reprovado:'var(--red)'};
    const card=document.createElement('div');card.style.cssText='border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:12px;background:rgba(0,0,0,.18)';
    card.innerHTML=`<div style="display:flex;align-items:start;justify-content:space-between;gap:12px;margin-bottom:12px"><div><div style="font-weight:800">${p.users?.nome||'?'} <span style="font-size:.78rem;color:var(--muted);font-weight:400">@${p.users?.login||'?'}</span></div><div style="font-size:.82rem;color:var(--muted);margin-top:2px">Turma: ${p.turmas?.nome||'?'} ¬∑ Enviado: ${fdt(p.enviado_em)}</div></div><span class="badge" style="background:${statusColors[p.status]||'rgba(255,255,255,.1)'};color:#fff;flex-shrink:0">${p.status}</span></div><div style="padding:11px;border:1px solid var(--border);border-radius:var(--rs);background:rgba(0,0,0,.2);margin-bottom:10px"><div style="font-size:.78rem;font-weight:700;color:var(--cyan);margin-bottom:5px">üîó Link do projeto</div><a href="${p.link||'#'}" target="_blank" style="color:var(--cyan);font-size:.85rem;word-break:break-all">${p.link||'‚Äî'}</a></div><div style="font-size:.87rem;color:var(--soft);margin-bottom:12px;line-height:1.6">${p.descricao||''}</div><div class="proj-comment-area" data-pid="${p.id}"><textarea class="fi" rows="3" placeholder="Coment√°rio / feedback para o aluno..." style="margin-bottom:8px">${p.comentario_admin||''}</textarea><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn bs btn-sm" onclick="avaliarProj('${p.id}','em_revisao')">üîç Em Revis√£o</button><button class="btn bp btn-sm" onclick="avaliarProj('${p.id}','aprovado')">‚úÖ Aprovar</button><button class="btn bd btn-sm" onclick="avaliarProj('${p.id}','reprovado')">‚ùå Reprovar</button></div></div>`;
    l.appendChild(card);
  }
}
$('#bLoadProj').addEventListener('click',loadAProjetos);
window.avaliarProj=async function(id,status){
  const card=document.querySelector(`[data-pid="${id}"]`);
  const comment=card?.querySelector('textarea')?.value?.trim()||'';
  const pay={status,comentario_admin:comment,avaliado_em:new Date().toISOString()};
  if(status==='aprovado')pay.aprovado_em=new Date().toISOString();
  await sb.from('projetos').update(pay).eq('id',id);
  toast(status==='aprovado'?'‚úÖ Projeto aprovado!':status==='reprovado'?'‚ùå Projeto reprovado.':'üîç Em revis√£o.','s');
  loadAProjetos();
};

/* ‚îÄ‚îÄ AVALIA√á√ÉO DO CURSO (STUDENT) ‚îÄ‚îÄ */
async function loadAvalAluno(){
  const c2=$('#avalContent');
  if(!sb||!CU){c2.innerHTML='<div style="color:var(--muted)">Indispon√≠vel.</div>';return;}
  if(!CU.turma_id){c2.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">Voc√™ n√£o est√° vinculado a uma turma.</div>';return;}

  // Verificar se j√° avaliou
  const{data:jaAvalS}=await sb.from('avaliacoes').select('*').eq('user_id',CU.id).eq('turma_id',CU.turma_id).single();
  if(jaAvalS){
    c2.innerHTML=`<div class="card cp" style="text-align:center;padding:32px">
      <div style="font-size:2.5rem;margin-bottom:10px">‚úÖ</div>
      <div style="font-weight:800;color:var(--green);font-size:1.1rem;margin-bottom:8px">Avalia√ß√£o j√° enviada!</div>
      <div style="font-size:.9rem;color:var(--soft);margin-bottom:18px">Obrigado pelo seu feedback.</div>
      <div style="display:flex;justify-content:center;gap:4px;font-size:1.8rem;margin-bottom:12px">${'‚≠ê'.repeat(jaAvalS.nota_geral)}${'‚òÜ'.repeat(5-jaAvalS.nota_geral)}</div>
      <div style="font-size:.88rem;color:var(--muted)">${fdt(jaAvalS.criado_em)}</div>
      <button class="btn bg2 btn-sm" style="margin-top:16px" onclick="editarAvaliacao()">‚úèÔ∏è Editar avalia√ß√£o</button>
    </div>`;
    return;
  }

  // Verificar conclus√£o do curso
  const pm=await getProg();
  const totalMods=mods.length,concluded=mods.filter(m=>pm[m.id]?.concluido).length;
  const pctConc=pct(concluded,totalMods);

  c2.innerHTML='';

  if(pctConc<100){
    const alertEl=document.createElement('div');
    alertEl.style.cssText='padding:12px 14px;border:1px solid rgba(245,158,11,.2);border-radius:var(--r);background:rgba(245,158,11,.05);font-size:.87rem;color:var(--amber);margin-bottom:18px;display:flex;align-items:center;gap:9px';
    alertEl.innerHTML=`<span style="font-size:1.3rem">‚ö†Ô∏è</span><span>Voc√™ concluiu ${concluded} de ${totalMods} m√≥dulos (${pctConc}%). Recomendamos avaliar ap√≥s concluir o curso, mas pode faz√™-lo agora se quiser.</span>`;
    c2.appendChild(alertEl);
  }

  const formEl=document.createElement('div');
  formEl.innerHTML=`
  <div class="card cp" style="margin-bottom:14px">
    <div style="font-weight:800;color:var(--cyan);margin-bottom:18px;font-size:1.05rem">üìã Pesquisa de Satisfa√ß√£o</div>

    <!-- NOTAS POR CATEGORIA -->
    <div style="display:flex;flex-direction:column;gap:18px;margin-bottom:22px">
      ${[
        ['nota_geral','‚≠ê Avalia√ß√£o Geral do Curso','Qual sua nota geral para o curso?'],
        ['nota_conteudo','üìö Qualidade do Conte√∫do','O conte√∫do foi relevante e bem estruturado?'],
        ['nota_didatica','üé§ Did√°tica','A did√°tica do professor foi clara e objetiva?'],
        ['nota_aulas','üé¨ Qualidade das Aulas','Como voc√™ avalia a qualidade t√©cnica das aulas?'],
        ['nota_plataforma','üíª Plataforma','A plataforma √© f√°cil de usar e navegar?'],
      ].map(([id,label,desc])=>`
        <div>
          <div style="font-weight:700;margin-bottom:3px">${label}</div>
          <div style="font-size:.8rem;color:var(--muted);margin-bottom:8px">${desc}</div>
          <div class="star-group" data-field="${id}" style="display:flex;gap:6px">
            ${[1,2,3,4,5].map(n=>`<span class="star" data-val="${n}" style="font-size:2rem;cursor:pointer;transition:transform .1s;user-select:none;opacity:.35">‚≠ê</span>`).join('')}
          </div>
          <input type="hidden" id="${id}" value="0"/>
        </div>`).join('')}
    </div>

    <!-- NPS -->
    <div style="margin-bottom:22px">
      <div style="font-weight:700;margin-bottom:4px">üîÅ Voc√™ recomendaria este curso para um amigo ou colega?</div>
      <div style="font-size:.8rem;color:var(--muted);margin-bottom:10px">0 = N√£o recomendaria ¬∑ 10 = Recomendaria com certeza</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${[0,1,2,3,4,5,6,7,8,9,10].map(n=>`<button type="button" class="nps-btn" data-nps="${n}" style="width:40px;height:40px;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--text);cursor:pointer;font-weight:700;font-size:.9rem;transition:all .15s">${n}</button>`).join('')}
      </div>
      <input type="hidden" id="nps_score" value="-1"/>
    </div>

    <!-- CAMPOS TEXTO -->
    <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:22px">
      <div>
        <label class="fl">üí¨ O que voc√™ mais gostou no curso?</label>
        <textarea id="av_positivo" class="fi" rows="3" placeholder="Pontos fortes, o que te surpreendeu positivamente..."></textarea>
      </div>
      <div>
        <label class="fl">üîß O que poderia ser melhorado?</label>
        <textarea id="av_melhoria" class="fi" rows="3" placeholder="Sugest√µes, pontos de aten√ß√£o, o que faltou..."></textarea>
      </div>
      <div>
        <label class="fl">üìù Coment√°rio livre (opcional)</label>
        <textarea id="av_comentario" class="fi" rows="3" placeholder="Conte mais sobre sua experi√™ncia..."></textarea>
      </div>
      <div>
        <label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="av_anonimo" style="accent-color:var(--cyan);width:16px;height:16px"/>
          Enviar de forma an√¥nima
        </label>
      </div>
    </div>

    <div id="avalErr" style="min-height:18px;font-size:.85rem;color:var(--amber);margin-bottom:10px"></div>
    <button id="bEnviarAval" class="btn bp">‚≠ê Enviar Avalia√ß√£o</button>
  </div>`;
  c2.appendChild(formEl);

  // Star interaction
  c2.querySelectorAll('.star-group').forEach(group=>{
    const field=group.dataset.field;
    const stars=group.querySelectorAll('.star');
    stars.forEach(star=>{
      star.addEventListener('mouseenter',()=>{
        const val=parseInt(star.dataset.val);
        stars.forEach(s=>s.style.opacity=parseInt(s.dataset.val)<=val?'1':'.25');
      });
      star.addEventListener('mouseleave',()=>{
        const cur=parseInt(document.getElementById(field).value)||0;
        stars.forEach(s=>s.style.opacity=parseInt(s.dataset.val)<=cur?'1':'.35');
      });
      star.addEventListener('click',()=>{
        const val=parseInt(star.dataset.val);
        document.getElementById(field).value=val;
        stars.forEach(s=>{s.style.opacity=parseInt(s.dataset.val)<=val?'1':'.35';s.style.transform=parseInt(s.dataset.val)<=val?'scale(1.1)':'scale(1)';});
      });
    });
  });

  // NPS interaction
  c2.querySelectorAll('.nps-btn').forEach(btn=>{
    const npsColors={0:'#ef4444',1:'#ef4444',2:'#ef4444',3:'#ef4444',4:'#ef4444',5:'#ef4444',6:'#f59e0b',7:'#f59e0b',8:'#0fba81',9:'#0fba81',10:'#0fba81'};
    btn.addEventListener('click',()=>{
      document.getElementById('nps_score').value=btn.dataset.nps;
      c2.querySelectorAll('.nps-btn').forEach(b=>{
        const n=parseInt(b.dataset.nps),sel=b===btn;
        b.style.background=sel?npsColors[n]:'rgba(0,0,0,.25)';
        b.style.borderColor=sel?npsColors[n]:'var(--border)';
        b.style.color=sel?'#fff':'var(--text)';
        b.style.transform=sel?'scale(1.12)':'scale(1)';
      });
    });
  });

  // Submit
  c2.querySelector('#bEnviarAval').addEventListener('click',async()=>{
    const err=c2.querySelector('#avalErr');
    const campos=['nota_geral','nota_conteudo','nota_didatica','nota_aulas','nota_plataforma'];
    const notas={};let allFilled=true;
    campos.forEach(f=>{
      const v=parseInt(document.getElementById(f).value)||0;
      notas[f]=v;if(v===0)allFilled=false;
    });
    const nps=parseInt(document.getElementById('nps_score').value);
    if(!allFilled){err.textContent='‚ö†Ô∏è Por favor, avalie todas as categorias.';return;}
    if(nps===-1){err.textContent='‚ö†Ô∏è Por favor, informe sua nota de recomenda√ß√£o (NPS).';return;}
    err.textContent='';
    const anonimo=document.getElementById('av_anonimo').checked;
    await sb.from('avaliacoes').upsert({
      user_id:CU.id,turma_id:CU.turma_id,
      nome_aluno:anonimo?'An√¥nimo':CU.nome,
      ...notas,nps_score:nps,
      positivo:document.getElementById('av_positivo').value.trim(),
      melhoria:document.getElementById('av_melhoria').value.trim(),
      comentario:document.getElementById('av_comentario').value.trim(),
      anonimo,criado_em:new Date().toISOString()
    },{onConflict:'user_id,turma_id'});
    toast('‚≠ê Avalia√ß√£o enviada! Obrigado!','s');
    loadAvalAluno();
  });
}
window.editarAvaliacao=async function(){
  if(sb&&CU){await sb.from('avaliacoes').delete().eq('user_id',CU.id).eq('turma_id',CU.turma_id);}
  loadAvalAluno();
};

/* ‚îÄ‚îÄ AVALIA√á√ïES (ADMIN) ‚îÄ‚îÄ */
async function loadAvalAdmin(){
  if(!sb)return;
  const{data:turmas}=await sb.from('turmas').select('*').eq('ativa',true);
  const opts=(turmas||[]).map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
  $('#avalFiltroTurma').innerHTML='<option value="">Todas as turmas</option>'+opts;
  await runAvalAdmin();
}
$('#bLoadAval').addEventListener('click',runAvalAdmin);
async function runAvalAdmin(){
  const filtroT=$('#avalFiltroTurma').value,filtroN=$('#avalFiltroNota').value;
  let q=sb.from('avaliacoes').select('*,turmas(nome)').order('criado_em',{ascending:false});
  if(filtroT)q=q.eq('turma_id',filtroT);
  if(filtroN)q=q.eq('nota_geral',parseInt(filtroN));
  const{data:avals}=await q;
  const all=avals||[];

  // ‚îÄ‚îÄ RESUMO ‚îÄ‚îÄ
  const avg=field=>all.length?+(all.reduce((s,a)=>s+(a[field]||0),0)/all.length).toFixed(1):0;
  const npsScores=all.filter(a=>a.nps_score!=null);
  const promoters=npsScores.filter(a=>a.nps_score>=9).length;
  const detractors=npsScores.filter(a=>a.nps_score<=6).length;
  const nps=npsScores.length?Math.round(((promoters-detractors)/npsScores.length)*100):null;
  const stars=n=>'‚≠ê'.repeat(n)+'‚òÜ'.repeat(5-n);

  const resumeData=[
    ['‚≠ê','Nota Geral',avg('nota_geral'),'/5','var(--amber)'],
    ['üìö','Conte√∫do',avg('nota_conteudo'),'/5','var(--cyan)'],
    ['üé§','Did√°tica',avg('nota_didatica'),'/5','var(--purple)'],
    ['üé¨','Aulas',avg('nota_aulas'),'/5','var(--green)'],
    ['üíª','Plataforma',avg('nota_plataforma'),'/5','rgba(255,255,255,.6)'],
    ['üîÅ','NPS',nps!==null?nps+'%':'‚Äî','',nps>=50?'var(--green)':nps>=0?'var(--amber)':'var(--muted)'],
    ['üë•','Respostas',all.length,'','var(--cyan)'],
  ];
  $('#avalResume').innerHTML=resumeData.map(([ic,lb,val,suf,cl])=>
    `<div class="card cp" style="text-align:center;padding:14px 10px">
      <div style="font-size:1.1rem;margin-bottom:3px">${ic}</div>
      <div style="font-size:1.6rem;font-weight:900;color:${cl}">${val}${suf}</div>
      <div style="font-size:.74rem;color:var(--muted);margin-top:2px">${lb}</div>
    </div>`
  ).join('');

  // ‚îÄ‚îÄ GR√ÅFICO DE DISTRIBUI√á√ÉO ‚îÄ‚îÄ
  const dist=[1,2,3,4,5].map(n=>({n,cnt:all.filter(a=>a.nota_geral===n).length}));
  const maxCnt=Math.max(...dist.map(d=>d.cnt),1);
  $('#avalGrafico').innerHTML=`<div class="card cp">
    <div style="font-weight:800;color:var(--cyan);margin-bottom:14px">üìä Distribui√ß√£o de Notas</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      ${dist.reverse().map(d=>`<div style="display:flex;align-items:center;gap:10px">
        <div style="width:60px;font-size:.85rem;font-weight:700;flex-shrink:0">${'‚≠ê'.repeat(d.n)}</div>
        <div style="flex:1;height:22px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden">
          <div style="height:100%;background:${d.n>=4?'var(--green)':d.n===3?'var(--amber)':'var(--red)'};width:${pct(d.cnt,maxCnt)}%;border-radius:4px;transition:width .6s;min-width:${d.cnt>0?'4px':'0'}"></div>
        </div>
        <div style="width:40px;text-align:right;font-size:.84rem;font-weight:700">${d.cnt}</div>
      </div>`).join('')}
    </div>
    ${npsScores.length?`<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
      <div style="font-weight:800;color:var(--cyan);margin-bottom:10px">üîÅ NPS ‚Äî Distribui√ß√£o</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="padding:10px 14px;border-radius:var(--rs);background:rgba(15,186,129,.1);border:1px solid rgba(15,186,129,.2);text-align:center;flex:1;min-width:100px"><div style="font-size:1.3rem;font-weight:900;color:var(--green)">${promoters}</div><div style="font-size:.75rem;color:var(--muted)">Promotores (9-10)</div></div>
        <div style="padding:10px 14px;border-radius:var(--rs);background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);text-align:center;flex:1;min-width:100px"><div style="font-size:1.3rem;font-weight:900;color:var(--amber)">${npsScores.filter(a=>a.nps_score>=7&&a.nps_score<=8).length}</div><div style="font-size:.75rem;color:var(--muted)">Neutros (7-8)</div></div>
        <div style="padding:10px 14px;border-radius:var(--rs);background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);text-align:center;flex:1;min-width:100px"><div style="font-size:1.3rem;font-weight:900;color:var(--red)">${detractors}</div><div style="font-size:.75rem;color:var(--muted)">Detratores (0-6)</div></div>
        <div style="padding:10px 14px;border-radius:var(--rs);background:${nps>=50?'rgba(15,186,129,.1)':nps>=0?'rgba(245,158,11,.1)':'rgba(239,68,68,.1)'};border:1px solid ${nps>=50?'rgba(15,186,129,.2)':nps>=0?'rgba(245,158,11,.2)':'rgba(239,68,68,.2)'};text-align:center;flex:1;min-width:100px"><div style="font-size:1.3rem;font-weight:900;color:${nps>=50?'var(--green)':nps>=0?'var(--amber)':'var(--red)'}">${nps}%</div><div style="font-size:.75rem;color:var(--muted)">NPS Score</div></div>
      </div>
    </div>`:'' }
  </div>`;

  // ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ
  const l=$('#avalList');
  if(!all.length){l.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">Nenhuma avalia√ß√£o ainda.</div>';return;}
  l.innerHTML='<div style="display:flex;flex-direction:column;gap:10px">'+
    all.map(a=>`<div style="border:1px solid var(--border);border-radius:var(--r);padding:15px;background:rgba(0,0,0,.18)">
      <div style="display:flex;align-items:start;justify-content:space-between;gap:10px;margin-bottom:12px">
        <div>
          <div style="font-weight:800">${a.anonimo?'üë§ An√¥nimo':a.nome_aluno||'?'}</div>
          <div style="font-size:.78rem;color:var(--muted);margin-top:2px">${a.turmas?.nome||'?'} ¬∑ ${fdt(a.criado_em)}</div>
        </div>
        <div style="display:flex;gap:5px;flex-shrink:0">
          <span class="badge ${a.nota_geral>=4?'bg3':a.nota_geral>=3?'ba':'br'}">${'‚≠ê'.repeat(a.nota_geral)} ${a.nota_geral}/5</span>
          ${a.nps_score!=null?`<span class="badge ${a.nps_score>=9?'bg3':a.nps_score>=7?'ba':'br'}">NPS ${a.nps_score}</span>`:''}
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        ${[['üìö',a.nota_conteudo,'Conte√∫do'],['üé§',a.nota_didatica,'Did√°tica'],['üé¨',a.nota_aulas,'Aulas'],['üíª',a.nota_plataforma,'Plataforma']].map(([ic,n,lb])=>
          `<div style="padding:5px 10px;border-radius:6px;background:rgba(255,255,255,.05);font-size:.78rem">${ic} <strong>${n}</strong> <span style="color:var(--muted)">${lb}</span></div>`
        ).join('')}
      </div>
      ${a.positivo?`<div style="padding:9px 12px;border-left:3px solid var(--green);background:rgba(15,186,129,.05);border-radius:0 var(--rs) var(--rs) 0;margin-bottom:7px;font-size:.86rem"><div style="font-size:.72rem;font-weight:700;color:var(--green);margin-bottom:3px">‚úÖ PONTOS POSITIVOS</div>${a.positivo}</div>`:''}
      ${a.melhoria?`<div style="padding:9px 12px;border-left:3px solid var(--amber);background:rgba(245,158,11,.05);border-radius:0 var(--rs) var(--rs) 0;margin-bottom:7px;font-size:.86rem"><div style="font-size:.72rem;font-weight:700;color:var(--amber);margin-bottom:3px">üîß PONTOS DE MELHORIA</div>${a.melhoria}</div>`:''}
      ${a.comentario?`<div style="padding:9px 12px;border-left:3px solid rgba(255,255,255,.15);background:rgba(255,255,255,.03);border-radius:0 var(--rs) var(--rs) 0;font-size:.86rem"><div style="font-size:.72rem;font-weight:700;color:var(--muted);margin-bottom:3px">üí¨ COMENT√ÅRIO</div>${a.comentario}</div>`:''}
    </div>`
  ).join('')+'</div>';
}
$('#bExportAval').addEventListener('click',()=>{
  const rows=document.querySelectorAll('#avalList [style]');
  // Simple CSV export from data
  if(!sb)return;
  sb.from('avaliacoes').select('*,turmas(nome)').order('criado_em',{ascending:false}).then(({data})=>{
    if(!data?.length){toast('Sem dados para exportar.','w');return;}
    const headers=['Nome','Turma','Nota Geral','Conteudo','Didatica','Aulas','Plataforma','NPS','Positivo','Melhoria','Comentario','Data'];
    const rows=[headers,...data.map(a=>[
      a.anonimo?'Anonimo':a.nome_aluno||'',
      a.turmas?.nome||'',a.nota_geral,a.nota_conteudo,a.nota_didatica,a.nota_aulas,a.nota_plataforma,
      a.nps_score??'',
      (a.positivo||'').replace(/,/g,';'),
      (a.melhoria||'').replace(/,/g,';'),
      (a.comentario||'').replace(/,/g,';'),
      fdt(a.criado_em)
    ])];
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a2=document.createElement('a');a2.href=url;a2.download=`avaliacoes_${new Date().toISOString().substring(0,10)}.csv`;a2.click();
    toast('üì• CSV exportado!','s');
  });
});

/* Show avalia√ß√£o nav when course nearing completion */
async function checkAvalNav(){
  if(!CU||!mods.length)return;
  const pm=await getProg();
  const pctConc=pct(mods.filter(m=>pm[m.id]?.concluido).length,mods.length);
  if(pctConc>=50){
    const nav=document.getElementById('navAval');
    if(nav)nav.style.display='';
  }
}

/* ‚îÄ‚îÄ ADMIN LIVE ‚îÄ‚îÄ */
async function loadALive(){
  if(!sb)return;await loadTurmaSelects();
  const{data:rows}=await sb.from('aulas_ao_vivo').select('*,turmas(nome)').order('criado_em',{ascending:false});
  const tb=$('#lvTable');
  if(!rows?.length){tb.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhuma configura√ß√£o ainda.</div>';return;}
  tb.innerHTML='<div class="tw2"><table><thead><tr><th>Turma</th><th>Tipo</th><th>T√≠tulo</th><th>Status</th><th></th></tr></thead><tbody>'+rows.map(r=>`<tr><td><span class="badge bc">${r.turmas?.nome||'‚Äî'}</span></td><td><span class="badge ${r.tipo==='live'?'br':'bpp'}">${r.tipo==='live'?'Ao vivo':'Contador'}</span></td><td style="font-size:.85rem">${r.titulo||'‚Äî'}</td><td><span class="badge ${r.ativa?'bg3':'bw2'}">${r.ativa?'Ativo':'Inativo'}</span></td><td style="display:flex;gap:5px"><button class="btn bg2 btn-xs" onclick="togLV('${r.id}',${!r.ativa})">${r.ativa?'‚è∏Ô∏è':'‚ñ∂Ô∏è'}</button><button class="btn bd btn-xs" onclick="delLV('${r.id}')">üóëÔ∏è</button></td></tr>`).join('')+'</tbody></table></div>';
}
$('#bSLV').addEventListener('click',async()=>{
  const tu=$('#lvTurma').value,tt=$('#lvTit').value.trim(),lk=$('#lvLink').value.trim(),ds=$('#lvDesc').value.trim(),at=parseInt($('#lvStatus').value);
  if(!tu||!tt||!lk){toast('‚ö†Ô∏è Turma, t√≠tulo e link obrigat√≥rios.','w');return;}
  await sb.from('aulas_ao_vivo').upsert({turma_id:tu,tipo:'live',titulo:tt,link:lk,descricao:ds,ativa:at===1,atualizado_em:new Date().toISOString()},{onConflict:'turma_id,tipo'});
  toast('‚úÖ Salvo!','s');loadALive();
});
$('#bSCD').addEventListener('click',async()=>{
  const tu=$('#cdTurma').value,tt=$('#cdTit').value.trim(),dh=$('#cdDH').value,at=parseInt($('#cdAtivo').value);
  if(!tu||!tt||!dh){toast('‚ö†Ô∏è Preencha turma, t√≠tulo e data/hora.','w');return;}
  await sb.from('aulas_ao_vivo').upsert({turma_id:tu,tipo:'countdown',titulo:tt,data_hora:new Date(dh).toISOString(),ativa:at===1,atualizado_em:new Date().toISOString()},{onConflict:'turma_id,tipo'});
  toast('‚úÖ Contador salvo!','s');loadALive();
});
window.togLV=async function(id,a){await sb.from('aulas_ao_vivo').update({ativa:a}).eq('id',id);loadALive();};
window.delLV=async function(id){if(!confirm('Excluir?'))return;await sb.from('aulas_ao_vivo').delete().eq('id',id);loadALive();};

/* ‚îÄ‚îÄ ADMIN MURAL ‚îÄ‚îÄ */
async function loadAMural(){
  if(!sb)return;await loadTurmaSelects();
  const{data}=await sb.from('mural_avisos').select('*,turmas(nome)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  const l=$('#aMuralList');
  if(!data?.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--muted)">Nenhum aviso publicado.</div>';return;}
  l.innerHTML=data.map(av=>'<div style="border:1px solid '+(av.fixado?'rgba(245,158,11,.4)':'var(--border)')+';border-radius:var(--r);padding:14px;margin-bottom:10px;background:rgba(0,0,0,.18)"><div style="display:flex;align-items:start;justify-content:space-between;gap:10px;margin-bottom:7px"><div><div style="font-weight:800">'+(av.fixado?'üìå ':'')+av.titulo+'</div><div style="font-size:.78rem;color:var(--muted);margin-top:2px">'+(av.turmas?.nome||'Todas')+' ¬∑ '+fdt(av.criado_em)+'</div></div><div style="display:flex;gap:5px"><button class="btn bg2 btn-xs" onclick="togMR(\''+av.id+'\','+!av.fixado+')">'+(av.fixado?'Desafixar':'Fixar')+'</button><button class="btn bd btn-xs" onclick="delMR(\''+av.id+'\')">üóëÔ∏è</button></div></div><div style="font-size:.88rem;color:var(--soft);line-height:1.5">'+av.conteudo+'</div></div>').join('');
}
$('#bSMR').addEventListener('click',async()=>{
  const tu=$('#mrTurma').value,ti2=$('#mrTit').value.trim(),co=$('#mrCont').value.trim(),fi=parseInt($('#mrFix').value);
  if(!ti2||!co){toast('‚ö†Ô∏è T√≠tulo e conte√∫do obrigat√≥rios.','w');return;}
  await sb.from('mural_avisos').insert({turma_id:tu||null,titulo:ti2,conteudo:co,fixado:fi===1,ativo:true});
  toast('‚úÖ Aviso publicado!','s');['mrTit','mrCont'].forEach(id=>document.getElementById(id).value='');$('#mrFix').value='0';loadAMural();
});
window.togMR=async function(id,f){await sb.from('mural_avisos').update({fixado:f}).eq('id',id);loadAMural();};
window.delMR=async function(id){if(!confirm('Excluir aviso?'))return;await sb.from('mural_avisos').delete().eq('id',id);loadAMural();};

/* ‚îÄ‚îÄ ADMIN FORUM ‚îÄ‚îÄ */
async function loadAForum(){
  if(!sb)return;
  const f=$('#aFF').value;
  let q=sb.from('forum_posts').select('*,users(nome,login),modules(titulo)').order('fixado',{ascending:false}).order('criado_em',{ascending:false});
  if(f==='pending')q=q.eq('aprovado',false);else if(f==='approved')q=q.eq('aprovado',true);
  const{data:posts}=await q.limit(100);
  const l=$('#aFL');l.innerHTML='';
  if(!posts?.length){l.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Nenhum post encontrado.</div>';return;}
  for(const p of posts){
    const ini=(p.users?.nome||'?').substring(0,2).toUpperCase();
    const{data:rps}=await sb.from('forum_replies').select('*,users(nome)').eq('post_id',p.id).order('criado_em');
    const pendReps=(rps||[]).filter(r=>!r.aprovado&&!r.is_admin).length;
    let rpsHtml='';
    for(const r of(rps||[])){
      const rAv=r.is_admin?'ADM':(r.users?.nome||'?').substring(0,2).toUpperCase();
      rpsHtml+='<div class="ri'+(r.is_admin?' adm-reply':!r.aprovado?' pending-reply':'')+'" data-rid="'+r.id+'"><div class="rav'+(r.is_admin?' adm':'')+'">'+rAv+'</div><div style="flex:1"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px"><div style="font-weight:700;font-size:.82rem">'+(r.is_admin?'<span style="color:var(--purple)">üë® Admin</span>':(r.users?.nome||'?'))+' <span style="font-weight:400;color:var(--muted)">'+fd(r.criado_em)+'</span>'+(!r.aprovado&&!r.is_admin?'<span class="badge ba" style="font-size:.66rem;margin-left:4px">Pendente</span>':'')+'</div><div style="display:flex;gap:4px">'+(!r.aprovado&&!r.is_admin?'<button class="btn bs btn-xs aprv-rep">‚úÖ</button>':'')+'<button class="btn bd btn-xs del-rep">üóëÔ∏è</button></div></div><div style="font-size:.87rem;color:var(--soft);margin-top:3px">'+r.conteudo+'</div></div></div>';
    }
    const card=document.createElement('div');card.className='pc'+(p.fixado?' pin':'');
    card.innerHTML='<div class="phead"><div class="pav" style="width:30px;height:30px;font-size:.75rem">'+ini+'</div><div style="flex:1"><div style="font-weight:800;font-size:.93rem">'+(p.fixado?'üìå ':'')+p.titulo+'</div><div style="font-size:.76rem;color:var(--muted)">'+(p.users?.nome||'?')+' ¬∑ '+(p.modules?.titulo||'Geral')+' ¬∑ '+fd(p.criado_em)+(!p.aprovado?'<span class="badge ba" style="font-size:.68rem;margin-left:4px">Post pendente</span>':'')+(pendReps>0?'<span class="badge ba" style="font-size:.68rem;margin-left:4px">'+pendReps+' pend.</span>':'')+'</div></div><div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap">'+(!p.aprovado?'<button class="btn bs btn-xs aprv-post">‚úÖ Aprovar</button>':'')+'<button class="btn bg2 btn-xs pin-post">'+(p.fixado?'üìå':'Fixar')+'</button><button class="btn bd btn-xs del-post">üóëÔ∏è</button></div></div><div class="pbody" style="font-size:.87rem;border-bottom:1px solid var(--border);padding-bottom:12px">'+p.conteudo+'</div><div style="padding:11px 15px"><div style="font-size:.78rem;font-weight:800;color:var(--soft);margin-bottom:8px">üí¨ Respostas ('+((rps||[]).length)+')</div><div class="rep-con">'+rpsHtml+'</div><div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)"><div style="font-size:.75rem;font-weight:800;color:var(--purple);margin-bottom:6px">üë® Responder como Admin</div><textarea class="fi adm-ta" rows="2" placeholder="Resposta publicada imediatamente..."></textarea><button class="btn bp btn-sm adm-rep" style="margin-top:7px">üì§ Enviar</button></div></div>';
    (function(post,cardEl,replies){
      const ap=cardEl.querySelector('.aprv-post');if(ap)ap.onclick=async()=>{await sb.from('forum_posts').update({aprovado:true}).eq('id',post.id);toast('‚úÖ Post aprovado!','s');loadAForum();};
      cardEl.querySelector('.pin-post').onclick=async()=>{await sb.from('forum_posts').update({fixado:!post.fixado}).eq('id',post.id);loadAForum();};
      cardEl.querySelector('.del-post').onclick=async()=>{if(!confirm('Excluir post?'))return;await sb.from('forum_replies').delete().eq('post_id',post.id);await sb.from('forum_posts').delete().eq('id',post.id);toast('üóëÔ∏è','i');loadAForum();};
      replies.forEach(r=>{
        const rd=cardEl.querySelector('[data-rid="'+r.id+'"]');if(!rd)return;
        const ab=rd.querySelector('.aprv-rep');if(ab)ab.onclick=async()=>{await sb.from('forum_replies').update({aprovado:true}).eq('id',r.id);toast('‚úÖ','s');loadAForum();};
        const db=rd.querySelector('.del-rep');if(db)db.onclick=async()=>{if(!confirm('Excluir?'))return;await sb.from('forum_replies').delete().eq('id',r.id);loadAForum();};
      });
      cardEl.querySelector('.adm-rep').onclick=async()=>{
        const ta=cardEl.querySelector('.adm-ta'),txt=ta.value.trim();
        if(!txt){toast('‚ö†Ô∏è Digite uma resposta.','w');return;}
        await sb.from('forum_replies').insert({post_id:post.id,user_id:CU.id,conteudo:txt,aprovado:true,is_admin:true});
        ta.value='';toast('‚úÖ Publicado!','s');loadAForum();
      };
    })(p,card,rps||[]);
    l.appendChild(card);
  }
}
$('#aFF').addEventListener('change',loadAForum);
$('#bRF').addEventListener('click',loadAForum);
</script>
</body>
</html>
